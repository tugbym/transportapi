<!DOCTYPE html>
<html>
<head>
  <title>sails.io.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../", thisFile = "assets/lib/sails/sails.io.js", defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h2">
        <a href="#sails.io.js">sails.io.js</a>
      </div>
      <div class="heading h2">
        <a href="#http%3A%2F%2Fsailsjs.org%2F%23!documentation%2Freference%2Fbrowsersdk%2Fbrowsersdk.html">http://sailsjs.org/#!documentation/reference/BrowserSDK/BrowserSDK.html</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
          <h1>sails.io.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1">&#182;</a>
</div>
<p>socket.io-1.2.1
(from <a href='http://socket.io/download/'>http://socket.io/download/</a>)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="o">!</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">exports</span><span class="o">&amp;&amp;</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">module</span><span class="p">)</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">e</span><span class="p">();</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">define</span><span class="o">&amp;&amp;</span><span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">)</span><span class="nx">define</span><span class="p">([],</span><span class="nx">e</span><span class="p">);</span><span class="k">else</span><span class="p">{</span><span class="kd">var</span> <span class="nx">f</span><span class="p">;</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">?</span><span class="nx">f</span><span class="o">=</span><span class="nb">window</span><span class="o">:</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">global</span><span class="o">?</span><span class="nx">f</span><span class="o">=</span><span class="nx">global</span><span class="o">:</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">f</span><span class="o">=</span><span class="nx">self</span><span class="p">),</span><span class="nx">f</span><span class="p">.</span><span class="nx">io</span><span class="o">=</span><span class="nx">e</span><span class="p">()}}(</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">define</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">;</span><span class="k">return</span> <span class="kd">function</span> <span class="nx">e</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">){</span><span class="kd">function</span> <span class="nx">s</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="nx">u</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">n</span><span class="p">[</span><span class="nx">o</span><span class="p">]){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">t</span><span class="p">[</span><span class="nx">o</span><span class="p">]){</span><span class="kd">var</span> <span class="nx">a</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">require</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="o">&amp;&amp;</span><span class="nx">require</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">u</span><span class="o">&amp;&amp;</span><span class="nx">a</span><span class="p">)</span><span class="k">return</span> <span class="nx">a</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="o">!</span><span class="mi">0</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="k">return</span> <span class="nx">i</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="o">!</span><span class="mi">0</span><span class="p">);</span><span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Cannot find module &#39;&quot;</span><span class="o">+</span><span class="nx">o</span><span class="o">+</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">f</span><span class="o">=</span><span class="nx">n</span><span class="p">[</span><span class="nx">o</span><span class="p">]</span><span class="o">=</span><span class="p">{</span><span class="nx">exports</span><span class="o">:</span><span class="p">{}};</span><span class="nx">t</span><span class="p">[</span><span class="nx">o</span><span class="p">][</span><span class="mi">0</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="nx">f</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="nx">t</span><span class="p">[</span><span class="nx">o</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="nx">e</span><span class="p">];</span><span class="k">return</span> <span class="nx">s</span><span class="p">(</span><span class="nx">n</span><span class="o">?</span><span class="nx">n</span><span class="o">:</span><span class="nx">e</span><span class="p">)},</span><span class="nx">f</span><span class="p">,</span><span class="nx">f</span><span class="p">.</span><span class="nx">exports</span><span class="p">,</span><span class="nx">e</span><span class="p">,</span><span class="nx">t</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">)}</span><span class="k">return</span> <span class="nx">n</span><span class="p">[</span><span class="nx">o</span><span class="p">].</span><span class="nx">exports</span><span class="p">}</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">require</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="o">&amp;&amp;</span><span class="nx">require</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">o</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">o</span><span class="o">&lt;</span><span class="nx">r</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">o</span><span class="o">++</span><span class="p">)</span><span class="nx">s</span><span class="p">(</span><span class="nx">r</span><span class="p">[</span><span class="nx">o</span><span class="p">]);</span><span class="k">return</span> <span class="nx">s</span><span class="p">}({</span><span class="mi">1</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./lib/&quot;</span><span class="p">)},{</span><span class="s2">&quot;./lib/&quot;</span><span class="o">:</span><span class="mi">2</span><span class="p">}],</span><span class="mi">2</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">url</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./url&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parser</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">Manager</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./manager&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)(</span><span class="s2">&quot;socket.io-client&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">exports</span><span class="o">=</span><span class="nx">lookup</span><span class="p">;</span><span class="kd">var</span> <span class="nx">cache</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">managers</span><span class="o">=</span><span class="p">{};</span><span class="kd">function</span> <span class="nx">lookup</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span><span class="nx">opts</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">uri</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="p">){</span><span class="nx">opts</span><span class="o">=</span><span class="nx">uri</span><span class="p">;</span><span class="nx">uri</span><span class="o">=</span><span class="kc">undefined</span><span class="p">}</span><span class="nx">opts</span><span class="o">=</span><span class="nx">opts</span><span class="o">||</span><span class="p">{};</span><span class="kd">var</span> <span class="nx">parsed</span><span class="o">=</span><span class="nx">url</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span><span class="kd">var</span> <span class="nx">source</span><span class="o">=</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">source</span><span class="p">;</span><span class="kd">var</span> <span class="nx">id</span><span class="o">=</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="kd">var</span> <span class="nx">io</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceNew</span><span class="o">||</span><span class="nx">opts</span><span class="p">[</span><span class="s2">&quot;force new connection&quot;</span><span class="p">]</span><span class="o">||</span><span class="kc">false</span><span class="o">===</span><span class="nx">opts</span><span class="p">.</span><span class="nx">multiplex</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;ignoring socket cache for %s&quot;</span><span class="p">,</span><span class="nx">source</span><span class="p">);</span><span class="nx">io</span><span class="o">=</span><span class="nx">Manager</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span><span class="nx">opts</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;new io instance for %s&quot;</span><span class="p">,</span><span class="nx">source</span><span class="p">);</span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">=</span><span class="nx">Manager</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span><span class="nx">opts</span><span class="p">)}</span><span class="nx">io</span><span class="o">=</span><span class="nx">cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]}</span><span class="k">return</span> <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">(</span><span class="nx">parsed</span><span class="p">.</span><span class="nx">path</span><span class="p">)}</span><span class="nx">exports</span><span class="p">.</span><span class="nx">protocol</span><span class="o">=</span><span class="nx">parser</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">connect</span><span class="o">=</span><span class="nx">lookup</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">Manager</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./manager&quot;</span><span class="p">);</span><span class="nx">exports</span><span class="p">.</span><span class="nx">Socket</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./socket&quot;</span><span class="p">)},{</span><span class="s2">&quot;./manager&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;./socket&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;./url&quot;</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span><span class="nx">debug</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="o">:</span><span class="mi">43</span><span class="p">}],</span><span class="mi">3</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">url</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./url&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">eio</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;engine.io-client&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">Socket</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./socket&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">Emitter</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-emitter&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parser</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">on</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./on&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">bind</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-bind&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">object</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;object-component&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)(</span><span class="s2">&quot;socket.io-client:manager&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">indexOf</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;indexof&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">Manager</span><span class="p">;</span><span class="kd">function</span> <span class="nx">Manager</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span><span class="nx">opts</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Manager</span><span class="p">))</span><span class="k">return</span> <span class="k">new</span> <span class="nx">Manager</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span><span class="nx">opts</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">uri</span><span class="o">&amp;&amp;</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">uri</span><span class="p">){</span><span class="nx">opts</span><span class="o">=</span><span class="nx">uri</span><span class="p">;</span><span class="nx">uri</span><span class="o">=</span><span class="kc">undefined</span><span class="p">}</span><span class="nx">opts</span><span class="o">=</span><span class="nx">opts</span><span class="o">||</span><span class="p">{};</span><span class="nx">opts</span><span class="p">.</span><span class="nx">path</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">path</span><span class="o">||</span><span class="s2">&quot;/socket.io&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="o">=</span><span class="p">{};</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="o">=</span><span class="p">[];</span><span class="k">this</span><span class="p">.</span><span class="nx">opts</span><span class="o">=</span><span class="nx">opts</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnection</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reconnection</span><span class="o">!==</span><span class="kc">false</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnectionAttempts</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reconnectionAttempts</span><span class="o">||</span><span class="kc">Infinity</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnectionDelay</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reconnectionDelay</span><span class="o">||</span><span class="mi">1</span><span class="nx">e3</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnectionDelayMax</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">reconnectionDelayMax</span><span class="o">||</span><span class="mi">5</span><span class="nx">e3</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">(</span><span class="kc">null</span><span class="o">==</span><span class="nx">opts</span><span class="p">.</span><span class="nx">timeout</span><span class="o">?</span><span class="mi">2</span><span class="nx">e4</span><span class="o">:</span><span class="nx">opts</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;closed&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="o">=</span><span class="nx">uri</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="o">=</span><span class="p">[];</span><span class="k">this</span><span class="p">.</span><span class="nx">attempts</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">encoding</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">packetBuffer</span><span class="o">=</span><span class="p">[];</span><span class="k">this</span><span class="p">.</span><span class="nx">encoder</span><span class="o">=</span><span class="k">new</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">Encoder</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="o">=</span><span class="k">new</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">Decoder</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">autoConnect</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">autoConnect</span><span class="o">!==</span><span class="kc">false</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">autoConnect</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">()}</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emitAll</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">nsp</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">[</span><span class="nx">nsp</span><span class="p">].</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">[</span><span class="nx">nsp</span><span class="p">],</span><span class="nx">arguments</span><span class="p">)}};</span><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnection</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnection</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">_reconnection</span><span class="o">=!!</span><span class="nx">v</span><span class="p">;</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnectionAttempts</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionAttempts</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionAttempts</span><span class="o">=</span><span class="nx">v</span><span class="p">;</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnectionDelay</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionDelay</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionDelay</span><span class="o">=</span><span class="nx">v</span><span class="p">;</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnectionDelayMax</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionDelayMax</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionDelayMax</span><span class="o">=</span><span class="nx">v</span><span class="p">;</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">timeout</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="o">=</span><span class="nx">v</span><span class="p">;</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">maybeReconnectOnOpen</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">openReconnect</span><span class="o">&amp;&amp;!</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">_reconnection</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">attempts</span><span class="o">===</span><span class="mi">0</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">openReconnect</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnect</span><span class="p">()}};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span><span class="o">=</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connect</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">fn</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;readyState %s&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="o">~</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">))</span><span class="k">return</span> <span class="k">this</span><span class="p">;</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;opening %s&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">engine</span><span class="o">=</span><span class="nx">eio</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">opts</span><span class="p">);</span><span class="kd">var</span> <span class="nx">socket</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">engine</span><span class="p">;</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;opening&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="kd">var</span> <span class="nx">openSub</span><span class="o">=</span><span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span><span class="s2">&quot;open&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onopen</span><span class="p">();</span><span class="nx">fn</span><span class="o">&amp;&amp;</span><span class="nx">fn</span><span class="p">()});</span><span class="kd">var</span> <span class="nx">errorSub</span><span class="o">=</span><span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;connect_error&quot;</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">();</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;closed&quot;</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s2">&quot;connect_error&quot;</span><span class="p">,</span><span class="nx">data</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">fn</span><span class="p">){</span><span class="kd">var</span> <span class="nx">err</span><span class="o">=</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Connection error&quot;</span><span class="p">);</span><span class="nx">err</span><span class="p">.</span><span class="nx">data</span><span class="o">=</span><span class="nx">data</span><span class="p">;</span><span class="nx">fn</span><span class="p">(</span><span class="nx">err</span><span class="p">)}</span><span class="nx">self</span><span class="p">.</span><span class="nx">maybeReconnectOnOpen</span><span class="p">()});</span><span class="k">if</span><span class="p">(</span><span class="kc">false</span><span class="o">!==</span><span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="p">){</span><span class="kd">var</span> <span class="nx">timeout</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">_timeout</span><span class="p">;</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;connect attempt will timeout after %d&quot;</span><span class="p">,</span><span class="nx">timeout</span><span class="p">);</span><span class="kd">var</span> <span class="nx">timer</span><span class="o">=</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;connect attempt timed out after %d&quot;</span><span class="p">,</span><span class="nx">timeout</span><span class="p">);</span><span class="nx">openSub</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span><span class="nx">socket</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span><span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="s2">&quot;timeout&quot;</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s2">&quot;connect_timeout&quot;</span><span class="p">,</span><span class="nx">timeout</span><span class="p">)},</span><span class="nx">timeout</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">destroy</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">)}})}</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">openSub</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">errorSub</span><span class="p">);</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onopen</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">socket</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">engine</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;ondata&quot;</span><span class="p">)));</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">on</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">,</span><span class="s2">&quot;decoded&quot;</span><span class="p">,</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;ondecoded&quot;</span><span class="p">)));</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;onerror&quot;</span><span class="p">)));</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">on</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;onclose&quot;</span><span class="p">)))};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ondata</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">data</span><span class="p">)};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ondecoded</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;packet&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">)};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onerror</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">)};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">socket</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">nsp</span><span class="p">){</span><span class="kd">var</span> <span class="nx">socket</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">[</span><span class="nx">nsp</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">socket</span><span class="p">){</span><span class="nx">socket</span><span class="o">=</span><span class="k">new</span> <span class="nx">Socket</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">nsp</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">nsps</span><span class="p">[</span><span class="nx">nsp</span><span class="p">]</span><span class="o">=</span><span class="nx">socket</span><span class="p">;</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="o">!~</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">connected</span><span class="p">,</span><span class="nx">socket</span><span class="p">)){</span><span class="nx">self</span><span class="p">.</span><span class="nx">connected</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">socket</span><span class="p">)}})}</span><span class="k">return</span> <span class="nx">socket</span><span class="p">};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">){</span><span class="kd">var</span> <span class="nx">index</span><span class="o">=</span><span class="nx">indexOf</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">,</span><span class="nx">socket</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="o">~</span><span class="nx">index</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">close</span><span class="p">()};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">packet</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;writing packet %j&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">);</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">encoder</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">encodedPackets</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">encodedPackets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">encodedPackets</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span><span class="nx">self</span><span class="p">.</span><span class="nx">encoding</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">processPacketQueue</span><span class="p">()})}</span><span class="k">else</span><span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">packetBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">packet</span><span class="p">)}};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">processPacketQueue</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">packetBuffer</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">0</span><span class="o">&amp;&amp;!</span><span class="k">this</span><span class="p">.</span><span class="nx">encoding</span><span class="p">){</span><span class="kd">var</span> <span class="nx">pack</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">packetBuffer</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="nx">pack</span><span class="p">)}};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cleanup</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">sub</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="nx">sub</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">shift</span><span class="p">())</span><span class="nx">sub</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">packetBuffer</span><span class="o">=</span><span class="p">[];</span><span class="k">this</span><span class="p">.</span><span class="nx">encoding</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">decoder</span><span class="p">.</span><span class="nx">destroy</span><span class="p">()};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span><span class="o">=</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">disconnect</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;closed&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">engine</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">engine</span><span class="p">.</span><span class="nx">close</span><span class="p">()};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onclose</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;closed&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="nx">reason</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_reconnection</span><span class="o">&amp;&amp;!</span><span class="k">this</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnect</span><span class="p">()}};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reconnect</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span><span class="o">||</span><span class="k">this</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="p">)</span><span class="k">return</span> <span class="k">this</span><span class="p">;</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">attempts</span><span class="o">++</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">attempts</span><span class="o">&gt;</span><span class="k">this</span><span class="p">.</span><span class="nx">_reconnectionAttempts</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;reconnect failed&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s2">&quot;reconnect_failed&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="kd">var</span> <span class="nx">delay</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">attempts</span><span class="o">*</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnectionDelay</span><span class="p">();</span><span class="nx">delay</span><span class="o">=</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">delay</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnectionDelayMax</span><span class="p">());</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;will wait %dms before reconnect attempt&quot;</span><span class="p">,</span><span class="nx">delay</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="kd">var</span> <span class="nx">timer</span><span class="o">=</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;attempting reconnect&quot;</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s2">&quot;reconnect_attempt&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">attempts</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s2">&quot;reconnecting&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">attempts</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">skipReconnect</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;reconnect attempt error&quot;</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">reconnecting</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">reconnect</span><span class="p">();</span><span class="nx">self</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s2">&quot;reconnect_error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">.</span><span class="nx">data</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;reconnect success&quot;</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">onreconnect</span><span class="p">()}})},</span><span class="nx">delay</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="nx">destroy</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timer</span><span class="p">)}})}};</span><span class="nx">Manager</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onreconnect</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">attempt</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">attempts</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">attempts</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">reconnecting</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emitAll</span><span class="p">(</span><span class="s2">&quot;reconnect&quot;</span><span class="p">,</span><span class="nx">attempt</span><span class="p">)}},{</span><span class="s2">&quot;./on&quot;</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&quot;./socket&quot;</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;./url&quot;</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span><span class="s2">&quot;component-bind&quot;</span><span class="o">:</span><span class="mi">7</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="nx">debug</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;engine.io-client&quot;</span><span class="o">:</span><span class="mi">10</span><span class="p">,</span><span class="nx">indexof</span><span class="o">:</span><span class="mi">39</span><span class="p">,</span><span class="s2">&quot;object-component&quot;</span><span class="o">:</span><span class="mi">40</span><span class="p">,</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="o">:</span><span class="mi">43</span><span class="p">}],</span><span class="mi">4</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">on</span><span class="p">;</span><span class="kd">function</span> <span class="nx">on</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">ev</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span><span class="nx">obj</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span><span class="nx">fn</span><span class="p">);</span><span class="k">return</span><span class="p">{</span><span class="nx">destroy</span><span class="o">:</span><span class="kd">function</span><span class="p">(){</span><span class="nx">obj</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="nx">ev</span><span class="p">,</span><span class="nx">fn</span><span class="p">)}}}},{}],</span><span class="mi">5</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">parser</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">Emitter</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-emitter&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">toArray</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;to-array&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">on</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./on&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">bind</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-bind&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)(</span><span class="s2">&quot;socket.io-client:socket&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">hasBin</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;has-binary&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">exports</span><span class="o">=</span><span class="nx">Socket</span><span class="p">;</span><span class="kd">var</span> <span class="nx">events</span><span class="o">=</span><span class="p">{</span><span class="nx">connect</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">connect_error</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">connect_timeout</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">disconnect</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">error</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">reconnect</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">reconnect_attempt</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">reconnect_failed</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">reconnect_error</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">reconnecting</span><span class="o">:</span><span class="mi">1</span><span class="p">};</span><span class="kd">var</span> <span class="nx">emit</span><span class="o">=</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span><span class="p">;</span><span class="kd">function</span> <span class="nx">Socket</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span><span class="nx">nsp</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="o">=</span><span class="nx">io</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="o">=</span><span class="nx">nsp</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">json</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">ids</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">acks</span><span class="o">=</span><span class="p">{};</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">autoConnect</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span><span class="o">=</span><span class="p">[];</span><span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span><span class="o">=</span><span class="p">[];</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">disconnected</span><span class="o">=</span><span class="kc">true</span><span class="p">}</span><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">subEvents</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="kd">var</span> <span class="nx">io</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="o">=</span><span class="p">[</span><span class="nx">on</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span><span class="s2">&quot;open&quot;</span><span class="p">,</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;onopen&quot;</span><span class="p">)),</span><span class="nx">on</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span><span class="s2">&quot;packet&quot;</span><span class="p">,</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;onpacket&quot;</span><span class="p">)),</span><span class="nx">on</span><span class="p">(</span><span class="nx">io</span><span class="p">,</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="s2">&quot;onclose&quot;</span><span class="p">))]};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span><span class="o">=</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">connect</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">)</span><span class="k">return</span> <span class="k">this</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">subEvents</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="nx">onopen</span><span class="p">();</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">args</span><span class="o">=</span><span class="nx">toArray</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span><span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">args</span><span class="p">);</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">events</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">ev</span><span class="p">)){</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">);</span><span class="k">return</span> <span class="k">this</span><span class="p">}</span><span class="kd">var</span> <span class="nx">args</span><span class="o">=</span><span class="nx">toArray</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parserType</span><span class="o">=</span><span class="nx">parser</span><span class="p">.</span><span class="nx">EVENT</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">hasBin</span><span class="p">(</span><span class="nx">args</span><span class="p">)){</span><span class="nx">parserType</span><span class="o">=</span><span class="nx">parser</span><span class="p">.</span><span class="nx">BINARY_EVENT</span><span class="p">}</span><span class="kd">var</span> <span class="nx">packet</span><span class="o">=</span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="nx">parserType</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="nx">args</span><span class="p">};</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;emitting packet with ack id %d&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">ids</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">acks</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">ids</span><span class="p">]</span><span class="o">=</span><span class="nx">args</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span><span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">ids</span><span class="o">++</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">packet</span><span class="p">)}</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">packet</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="nx">packet</span><span class="p">.</span><span class="nx">nsp</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onopen</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;transport is open - connecting&quot;</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">!=</span><span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span><span class="nx">parser</span><span class="p">.</span><span class="nx">CONNECT</span><span class="p">})}};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onclose</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;close (%s)&quot;</span><span class="p">,</span><span class="nx">reason</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">disconnected</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;disconnect&quot;</span><span class="p">,</span><span class="nx">reason</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onpacket</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">nsp</span><span class="o">!=</span><span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="k">switch</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">){</span><span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">CONNECT</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">onconnect</span><span class="p">();</span><span class="k">break</span><span class="p">;</span><span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">EVENT</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">onevent</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span><span class="k">break</span><span class="p">;</span><span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">BINARY_EVENT</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">onevent</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span><span class="k">break</span><span class="p">;</span><span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">ACK</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">onack</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span><span class="k">break</span><span class="p">;</span><span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">BINARY_ACK</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">onack</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span><span class="k">break</span><span class="p">;</span><span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">DISCONNECT</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">ondisconnect</span><span class="p">();</span><span class="k">break</span><span class="p">;</span><span class="k">case</span> <span class="nx">parser</span><span class="p">.</span><span class="nx">ERROR</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="k">break</span><span class="p">}};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onevent</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="kd">var</span> <span class="nx">args</span><span class="o">=</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="o">||</span><span class="p">[];</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;emitting event %j&quot;</span><span class="p">,</span><span class="nx">args</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">!=</span><span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;attaching ack callback to event&quot;</span><span class="p">);</span><span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ack</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">))}</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">){</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">args</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">args</span><span class="p">)}};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ack</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="kd">var</span> <span class="nx">sent</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">return</span> <span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">sent</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="nx">sent</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="kd">var</span> <span class="nx">args</span><span class="o">=</span><span class="nx">toArray</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;sending ack %j&quot;</span><span class="p">,</span><span class="nx">args</span><span class="p">);</span><span class="kd">var</span> <span class="nx">type</span><span class="o">=</span><span class="nx">hasBin</span><span class="p">(</span><span class="nx">args</span><span class="p">)</span><span class="o">?</span><span class="nx">parser</span><span class="p">.</span><span class="nx">BINARY_ACK</span><span class="o">:</span><span class="nx">parser</span><span class="p">.</span><span class="nx">ACK</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">packet</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span><span class="nx">type</span><span class="p">,</span><span class="nx">id</span><span class="o">:</span><span class="nx">id</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="nx">args</span><span class="p">})}};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onack</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;calling ack %s with %j&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="kd">var</span> <span class="nx">fn</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">acks</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span><span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">acks</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">id</span><span class="p">]};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onconnect</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">disconnected</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;connect&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">emitBuffered</span><span class="p">()};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emitBuffered</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">i</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">emit</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span><span class="k">this</span><span class="p">.</span><span class="nx">receiveBuffer</span><span class="o">=</span><span class="p">[];</span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span><span class="k">this</span><span class="p">.</span><span class="nx">sendBuffer</span><span class="o">=</span><span class="p">[]};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ondisconnect</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;server disconnect (%s)&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">onclose</span><span class="p">(</span><span class="s2">&quot;io server disconnect&quot;</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">destroy</span><span class="p">()}</span><span class="k">this</span><span class="p">.</span><span class="nx">subs</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="k">this</span><span class="p">.</span><span class="nx">io</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="k">this</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span><span class="o">=</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">disconnect</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;performing disconnect (%s)&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">nsp</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">packet</span><span class="p">({</span><span class="nx">type</span><span class="o">:</span><span class="nx">parser</span><span class="p">.</span><span class="nx">DISCONNECT</span><span class="p">})}</span><span class="k">this</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">connected</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">onclose</span><span class="p">(</span><span class="s2">&quot;io client disconnect&quot;</span><span class="p">)}</span><span class="k">return</span> <span class="k">this</span><span class="p">}},{</span><span class="s2">&quot;./on&quot;</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span><span class="s2">&quot;component-bind&quot;</span><span class="o">:</span><span class="mi">7</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="nx">debug</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="s2">&quot;has-binary&quot;</span><span class="o">:</span><span class="mi">35</span><span class="p">,</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="o">:</span><span class="mi">43</span><span class="p">,</span><span class="s2">&quot;to-array&quot;</span><span class="o">:</span><span class="mi">47</span><span class="p">}],</span><span class="mi">6</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">parseuri</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;parseuri&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)(</span><span class="s2">&quot;socket.io-client:url&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">url</span><span class="p">;</span><span class="kd">function</span> <span class="nx">url</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span><span class="nx">loc</span><span class="p">){</span><span class="kd">var</span> <span class="nx">obj</span><span class="o">=</span><span class="nx">uri</span><span class="p">;</span><span class="kd">var</span> <span class="nx">loc</span><span class="o">=</span><span class="nx">loc</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">==</span><span class="nx">uri</span><span class="p">)</span><span class="nx">uri</span><span class="o">=</span><span class="nx">loc</span><span class="p">.</span><span class="nx">protocol</span><span class="o">+</span><span class="s2">&quot;//&quot;</span><span class="o">+</span><span class="nx">loc</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">uri</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">==</span><span class="nx">uri</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">==</span><span class="nx">uri</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">1</span><span class="p">)){</span><span class="nx">uri</span><span class="o">=</span><span class="nx">loc</span><span class="p">.</span><span class="nx">protocol</span><span class="o">+</span><span class="nx">uri</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">uri</span><span class="o">=</span><span class="nx">loc</span><span class="p">.</span><span class="nx">hostname</span><span class="o">+</span><span class="nx">uri</span><span class="p">}}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="sr">/^(https?|wss?):\/\//</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">uri</span><span class="p">)){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;protocol-less url %s&quot;</span><span class="p">,</span><span class="nx">uri</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">loc</span><span class="p">){</span><span class="nx">uri</span><span class="o">=</span><span class="nx">loc</span><span class="p">.</span><span class="nx">protocol</span><span class="o">+</span><span class="s2">&quot;//&quot;</span><span class="o">+</span><span class="nx">uri</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">uri</span><span class="o">=</span><span class="s2">&quot;https://&quot;</span><span class="o">+</span><span class="nx">uri</span><span class="p">}}</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;parse %s&quot;</span><span class="p">,</span><span class="nx">uri</span><span class="p">);</span><span class="nx">obj</span><span class="o">=</span><span class="nx">parseuri</span><span class="p">(</span><span class="nx">uri</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">.</span><span class="nx">port</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="sr">/^(http|ws)$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">protocol</span><span class="p">)){</span><span class="nx">obj</span><span class="p">.</span><span class="nx">port</span><span class="o">=</span><span class="s2">&quot;80&quot;</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="sr">/^(http|ws)s$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">protocol</span><span class="p">)){</span><span class="nx">obj</span><span class="p">.</span><span class="nx">port</span><span class="o">=</span><span class="s2">&quot;443&quot;</span><span class="p">}}</span><span class="nx">obj</span><span class="p">.</span><span class="nx">path</span><span class="o">=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">path</span><span class="o">||</span><span class="s2">&quot;/&quot;</span><span class="p">;</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="o">=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">protocol</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="nx">obj</span><span class="p">.</span><span class="nx">host</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">obj</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span><span class="nx">obj</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">protocol</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="nx">obj</span><span class="p">.</span><span class="nx">host</span><span class="o">+</span><span class="p">(</span><span class="nx">loc</span><span class="o">&amp;&amp;</span><span class="nx">loc</span><span class="p">.</span><span class="nx">port</span><span class="o">==</span><span class="nx">obj</span><span class="p">.</span><span class="nx">port</span><span class="o">?</span><span class="s2">&quot;&quot;</span><span class="o">:</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">obj</span><span class="p">.</span><span class="nx">port</span><span class="p">);</span><span class="k">return</span> <span class="nx">obj</span><span class="p">}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{</span><span class="nx">debug</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="nx">parseuri</span><span class="o">:</span><span class="mi">41</span><span class="p">}],</span><span class="mi">7</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">slice</span><span class="o">=</span><span class="p">[].</span><span class="nx">slice</span><span class="p">;</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">fn</span><span class="p">)</span><span class="nx">fn</span><span class="o">=</span><span class="nx">obj</span><span class="p">[</span><span class="nx">fn</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">fn</span><span class="p">)</span><span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;bind() requires a function&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">args</span><span class="o">=</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="k">return</span> <span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">args</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">)))}}},{}],</span><span class="mi">8</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">Emitter</span><span class="p">;</span><span class="kd">function</span> <span class="nx">Emitter</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span><span class="k">return</span> <span class="nx">mixin</span><span class="p">(</span><span class="nx">obj</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">mixin</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">){</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">=</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="nx">key</span><span class="p">]}</span><span class="k">return</span> <span class="nx">obj</span><span class="p">}</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span><span class="o">=</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addEventListener</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">||</span><span class="p">{};(</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span><span class="o">||</span><span class="p">[]).</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">once</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">||</span><span class="p">{};</span><span class="kd">function</span> <span class="nx">on</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="nx">on</span><span class="p">);</span><span class="nx">fn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">arguments</span><span class="p">)}</span><span class="nx">on</span><span class="p">.</span><span class="nx">fn</span><span class="o">=</span><span class="nx">fn</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="nx">on</span><span class="p">);</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">off</span><span class="o">=</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeListener</span><span class="o">=</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="o">=</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">||</span><span class="p">{};</span><span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">=</span><span class="p">{};</span><span class="k">return</span> <span class="k">this</span><span class="p">}</span><span class="kd">var</span> <span class="nx">callbacks</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">callbacks</span><span class="p">)</span><span class="k">return</span> <span class="k">this</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="mi">1</span><span class="o">==</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span><span class="k">return</span> <span class="k">this</span><span class="p">}</span><span class="kd">var</span> <span class="nx">cb</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">cb</span><span class="o">=</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="nx">cb</span><span class="o">===</span><span class="nx">fn</span><span class="o">||</span><span class="nx">cb</span><span class="p">.</span><span class="nx">fn</span><span class="o">===</span><span class="nx">fn</span><span class="p">){</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="k">break</span><span class="p">}}</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">emit</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">||</span><span class="p">{};</span><span class="kd">var</span> <span class="nx">args</span><span class="o">=</span><span class="p">[].</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="nx">callbacks</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="nx">callbacks</span><span class="p">){</span><span class="nx">callbacks</span><span class="o">=</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">len</span><span class="o">=</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="o">++</span><span class="nx">i</span><span class="p">){</span><span class="nx">callbacks</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">args</span><span class="p">)}}</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">listeners</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="o">||</span><span class="p">{};</span><span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_callbacks</span><span class="p">[</span><span class="nx">event</span><span class="p">]</span><span class="o">||</span><span class="p">[]};</span><span class="nx">Emitter</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasListeners</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span><span class="k">return</span><span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">(</span><span class="nx">event</span><span class="p">).</span><span class="nx">length</span><span class="p">}},{}],</span><span class="mi">9</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">debug</span><span class="p">;</span><span class="kd">function</span> <span class="nx">debug</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">debug</span><span class="p">.</span><span class="nx">enabled</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span><span class="k">return</span> <span class="kd">function</span><span class="p">(){};</span><span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">fmt</span><span class="p">){</span><span class="nx">fmt</span><span class="o">=</span><span class="nx">coerce</span><span class="p">(</span><span class="nx">fmt</span><span class="p">);</span><span class="kd">var</span> <span class="nx">curr</span><span class="o">=</span><span class="k">new</span> <span class="nb">Date</span><span class="p">;</span><span class="kd">var</span> <span class="nx">ms</span><span class="o">=</span><span class="nx">curr</span><span class="o">-</span><span class="p">(</span><span class="nx">debug</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">||</span><span class="nx">curr</span><span class="p">);</span><span class="nx">debug</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">=</span><span class="nx">curr</span><span class="p">;</span><span class="nx">fmt</span><span class="o">=</span><span class="nx">name</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">fmt</span><span class="o">+</span><span class="s2">&quot; +&quot;</span><span class="o">+</span><span class="nx">debug</span><span class="p">.</span><span class="nx">humanize</span><span class="p">(</span><span class="nx">ms</span><span class="p">);</span><span class="nb">window</span><span class="p">.</span><span class="nx">console</span><span class="o">&amp;&amp;</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="o">&amp;&amp;</span><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">apply</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span><span class="nx">console</span><span class="p">,</span><span class="nx">arguments</span><span class="p">)}}</span><span class="nx">debug</span><span class="p">.</span><span class="nx">names</span><span class="o">=</span><span class="p">[];</span><span class="nx">debug</span><span class="p">.</span><span class="nx">skips</span><span class="o">=</span><span class="p">[];</span><span class="nx">debug</span><span class="p">.</span><span class="nx">enable</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">debug</span><span class="o">=</span><span class="nx">name</span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span><span class="kd">var</span> <span class="nx">split</span><span class="o">=</span><span class="p">(</span><span class="nx">name</span><span class="o">||</span><span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/[\s,]+/</span><span class="p">),</span><span class="nx">len</span><span class="o">=</span><span class="nx">split</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">name</span><span class="o">=</span><span class="nx">split</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="s2">&quot;.*?&quot;</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">===</span><span class="s2">&quot;-&quot;</span><span class="p">){</span><span class="nx">debug</span><span class="p">.</span><span class="nx">skips</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="o">+</span><span class="nx">name</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">))}</span><span class="k">else</span><span class="p">{</span><span class="nx">debug</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="o">+</span><span class="nx">name</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">))}}};</span><span class="nx">debug</span><span class="p">.</span><span class="nx">disable</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)};</span><span class="nx">debug</span><span class="p">.</span><span class="nx">humanize</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">ms</span><span class="p">){</span><span class="kd">var</span> <span class="nx">sec</span><span class="o">=</span><span class="mi">1</span><span class="nx">e3</span><span class="p">,</span><span class="nx">min</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">1</span><span class="nx">e3</span><span class="p">,</span><span class="nx">hour</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="nx">min</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="o">&gt;=</span><span class="nx">hour</span><span class="p">)</span><span class="k">return</span><span class="p">(</span><span class="nx">ms</span><span class="o">/</span><span class="nx">hour</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;h&quot;</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="o">&gt;=</span><span class="nx">min</span><span class="p">)</span><span class="k">return</span><span class="p">(</span><span class="nx">ms</span><span class="o">/</span><span class="nx">min</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;m&quot;</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="o">&gt;=</span><span class="nx">sec</span><span class="p">)</span><span class="k">return</span><span class="p">(</span><span class="nx">ms</span><span class="o">/</span><span class="nx">sec</span><span class="o">|</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;s&quot;</span><span class="p">;</span><span class="k">return</span> <span class="nx">ms</span><span class="o">+</span><span class="s2">&quot;ms&quot;</span><span class="p">};</span><span class="nx">debug</span><span class="p">.</span><span class="nx">enabled</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">len</span><span class="o">=</span><span class="nx">debug</span><span class="p">.</span><span class="nx">skips</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">debug</span><span class="p">.</span><span class="nx">skips</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">)){</span><span class="k">return</span> <span class="kc">false</span><span class="p">}}</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">len</span><span class="o">=</span><span class="nx">debug</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">debug</span><span class="p">.</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">)){</span><span class="k">return</span> <span class="kc">true</span><span class="p">}}</span><span class="k">return</span> <span class="kc">false</span><span class="p">};</span><span class="kd">function</span> <span class="nx">coerce</span><span class="p">(</span><span class="nx">val</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span><span class="k">return</span> <span class="nx">val</span><span class="p">.</span><span class="nx">stack</span><span class="o">||</span><span class="nx">val</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span><span class="k">return</span> <span class="nx">val</span><span class="p">}</span><span class="k">try</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">)</span><span class="nx">debug</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">debug</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}},{}],</span><span class="mi">10</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./lib/&quot;</span><span class="p">)},{</span><span class="s2">&quot;./lib/&quot;</span><span class="o">:</span><span class="mi">11</span><span class="p">}],</span><span class="mi">11</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./socket&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">parser</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="p">)},{</span><span class="s2">&quot;./socket&quot;</span><span class="o">:</span><span class="mi">12</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">24</span><span class="p">}],</span><span class="mi">12</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">transports</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./transports&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">Emitter</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-emitter&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)(</span><span class="s2">&quot;engine.io-client:socket&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">index</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;indexof&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parser</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parseuri</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;parseuri&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parsejson</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;parsejson&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parseqs</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;parseqs&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">Socket</span><span class="p">;</span><span class="kd">function</span> <span class="nx">noop</span><span class="p">(){}</span><span class="kd">function</span> <span class="nx">Socket</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span><span class="nx">opts</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">this</span> <span class="k">instanceof</span> <span class="nx">Socket</span><span class="p">))</span><span class="k">return</span> <span class="k">new</span> <span class="nx">Socket</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span><span class="nx">opts</span><span class="p">);</span><span class="nx">opts</span><span class="o">=</span><span class="nx">opts</span><span class="o">||</span><span class="p">{};</span><span class="k">if</span><span class="p">(</span><span class="nx">uri</span><span class="o">&amp;&amp;</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">uri</span><span class="p">){</span><span class="nx">opts</span><span class="o">=</span><span class="nx">uri</span><span class="p">;</span><span class="nx">uri</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">uri</span><span class="p">){</span><span class="nx">uri</span><span class="o">=</span><span class="nx">parseuri</span><span class="p">(</span><span class="nx">uri</span><span class="p">);</span><span class="nx">opts</span><span class="p">.</span><span class="nx">host</span><span class="o">=</span><span class="nx">uri</span><span class="p">.</span><span class="nx">host</span><span class="p">;</span><span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span><span class="o">=</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span><span class="o">==</span><span class="s2">&quot;https&quot;</span><span class="o">||</span><span class="nx">uri</span><span class="p">.</span><span class="nx">protocol</span><span class="o">==</span><span class="s2">&quot;wss&quot;</span><span class="p">;</span><span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="o">=</span><span class="nx">uri</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span><span class="nx">opts</span><span class="p">.</span><span class="nx">query</span><span class="o">=</span><span class="nx">uri</span><span class="p">.</span><span class="nx">query</span><span class="p">}</span><span class="k">this</span><span class="p">.</span><span class="nx">secure</span><span class="o">=</span><span class="kc">null</span><span class="o">!=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span><span class="o">?</span><span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span><span class="o">:</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="o">&amp;&amp;</span><span class="s2">&quot;https:&quot;</span><span class="o">==</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">host</span><span class="p">){</span><span class="kd">var</span> <span class="nx">pieces</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">);</span><span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span><span class="o">=</span><span class="nx">pieces</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="nx">pieces</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="o">=</span><span class="nx">pieces</span><span class="p">.</span><span class="nx">pop</span><span class="p">()}</span><span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">agent</span><span class="o">||</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span><span class="o">||</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="o">?</span><span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span><span class="o">:</span><span class="s2">&quot;localhost&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="o">||</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="o">&amp;&amp;</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="o">?</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">secure</span><span class="o">?</span><span class="mi">443</span><span class="o">:</span><span class="mi">80</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">query</span><span class="o">||</span><span class="p">{};</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="o">=</span><span class="nx">parseqs</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrade</span><span class="o">=</span><span class="kc">false</span><span class="o">!==</span><span class="nx">opts</span><span class="p">.</span><span class="nx">upgrade</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="o">=</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">path</span><span class="o">||</span><span class="s2">&quot;/engine.io&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/$/</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;/&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">forceJSONP</span><span class="o">=!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceJSONP</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">jsonp</span><span class="o">=</span><span class="kc">false</span><span class="o">!==</span><span class="nx">opts</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">forceBase64</span><span class="o">=!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceBase64</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="o">=!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">timestampParam</span><span class="o">||</span><span class="s2">&quot;t&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">transports</span><span class="o">||</span><span class="p">[</span><span class="s2">&quot;polling&quot;</span><span class="p">,</span><span class="s2">&quot;websocket&quot;</span><span class="p">];</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="o">=</span><span class="p">[];</span><span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="o">=</span><span class="p">[];</span><span class="k">this</span><span class="p">.</span><span class="nx">policyPort</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">policyPort</span><span class="o">||</span><span class="mi">843</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">rememberUpgrade</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">rememberUpgrade</span><span class="o">||</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">binaryType</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">onlyBinaryUpgrades</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">onlyBinaryUpgrades</span><span class="p">}</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">protocol</span><span class="o">=</span><span class="nx">parser</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">Socket</span><span class="o">=</span><span class="nx">Socket</span><span class="p">;</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">Transport</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./transport&quot;</span><span class="p">);</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">transports</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./transports&quot;</span><span class="p">);</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">parser</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="p">);</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">createTransport</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;creating transport &quot;%s&quot;&#39;</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span><span class="kd">var</span> <span class="nx">query</span><span class="o">=</span><span class="nx">clone</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">);</span><span class="nx">query</span><span class="p">.</span><span class="nx">EIO</span><span class="o">=</span><span class="nx">parser</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span><span class="nx">query</span><span class="p">.</span><span class="nx">transport</span><span class="o">=</span><span class="nx">name</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="nx">query</span><span class="p">.</span><span class="nx">sid</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span><span class="kd">var</span> <span class="nx">transport</span><span class="o">=</span><span class="k">new</span> <span class="nx">transports</span><span class="p">[</span><span class="nx">name</span><span class="p">]({</span><span class="nx">agent</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="p">,</span><span class="nx">hostname</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="p">,</span><span class="nx">port</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span><span class="nx">secure</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">secure</span><span class="p">,</span><span class="nx">path</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span><span class="nx">query</span><span class="o">:</span><span class="nx">query</span><span class="p">,</span><span class="nx">forceJSONP</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">forceJSONP</span><span class="p">,</span><span class="nx">jsonp</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">,</span><span class="nx">forceBase64</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">forceBase64</span><span class="p">,</span><span class="nx">enablesXDR</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">,</span><span class="nx">timestampRequests</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">,</span><span class="nx">timestampParam</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span><span class="p">,</span><span class="nx">policyPort</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">policyPort</span><span class="p">,</span><span class="nx">socket</span><span class="o">:</span><span class="k">this</span><span class="p">});</span><span class="k">return</span> <span class="nx">transport</span><span class="p">};</span><span class="kd">function</span> <span class="nx">clone</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="kd">var</span> <span class="nx">o</span><span class="o">=</span><span class="p">{};</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">)){</span><span class="nx">o</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">]}}</span><span class="k">return</span> <span class="nx">o</span><span class="p">}</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">transport</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">rememberUpgrade</span><span class="o">&amp;&amp;</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;websocket&quot;</span><span class="p">)</span><span class="o">!=-</span><span class="mi">1</span><span class="p">){</span><span class="nx">transport</span><span class="o">=</span><span class="s2">&quot;websocket&quot;</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="mi">0</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="s2">&quot;No transports available&quot;</span><span class="p">)},</span><span class="mi">0</span><span class="p">);</span><span class="k">return</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">transport</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;opening&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">transport</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="nx">transport</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="nx">transport</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">.</span><span class="nx">shift</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span><span class="k">return</span><span class="p">}</span><span class="nx">transport</span><span class="p">.</span><span class="nx">open</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">setTransport</span><span class="p">(</span><span class="nx">transport</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setTransport</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;setting transport %s&quot;</span><span class="p">,</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;clearing existing transport %s&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">()}</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="o">=</span><span class="nx">transport</span><span class="p">;</span><span class="nx">transport</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onDrain</span><span class="p">()}).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;packet&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onPacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">)}).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">e</span><span class="p">)}).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">(</span><span class="s2">&quot;transport close&quot;</span><span class="p">)})};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">probe</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probing transport &quot;%s&quot;&#39;</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span><span class="kd">var</span> <span class="nx">transport</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="nx">name</span><span class="p">,{</span><span class="nx">probe</span><span class="o">:</span><span class="mi">1</span><span class="p">}),</span><span class="nx">failed</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span><span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="kd">function</span> <span class="nx">onTransportOpen</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">onlyBinaryUpgrades</span><span class="p">){</span><span class="kd">var</span> <span class="nx">upgradeLosesBinary</span><span class="o">=!</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">&amp;&amp;</span><span class="nx">self</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">;</span><span class="nx">failed</span><span class="o">=</span><span class="nx">failed</span><span class="o">||</span><span class="nx">upgradeLosesBinary</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">failed</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probe transport &quot;%s&quot; opened&#39;</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span><span class="nx">transport</span><span class="p">.</span><span class="nx">send</span><span class="p">([{</span><span class="nx">type</span><span class="o">:</span><span class="s2">&quot;ping&quot;</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="s2">&quot;probe&quot;</span><span class="p">}]);</span><span class="nx">transport</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;packet&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">failed</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;pong&quot;</span><span class="o">==</span><span class="nx">msg</span><span class="p">.</span><span class="nx">type</span><span class="o">&amp;&amp;</span><span class="s2">&quot;probe&quot;</span><span class="o">==</span><span class="nx">msg</span><span class="p">.</span><span class="nx">data</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probe transport &quot;%s&quot; pong&#39;</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">upgrading</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;upgrading&quot;</span><span class="p">,</span><span class="nx">transport</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">transport</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span><span class="o">=</span><span class="s2">&quot;websocket&quot;</span><span class="o">==</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;pausing current transport &quot;%s&quot;&#39;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">pause</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">failed</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;closed&quot;</span><span class="o">==</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;changing transport and sending upgrade packet&quot;</span><span class="p">);</span><span class="nx">cleanup</span><span class="p">();</span><span class="nx">self</span><span class="p">.</span><span class="nx">setTransport</span><span class="p">(</span><span class="nx">transport</span><span class="p">);</span><span class="nx">transport</span><span class="p">.</span><span class="nx">send</span><span class="p">([{</span><span class="nx">type</span><span class="o">:</span><span class="s2">&quot;upgrade&quot;</span><span class="p">}]);</span><span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;upgrade&quot;</span><span class="p">,</span><span class="nx">transport</span><span class="p">);</span><span class="nx">transport</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">upgrading</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">flush</span><span class="p">()})}</span><span class="k">else</span><span class="p">{</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probe transport &quot;%s&quot; failed&#39;</span><span class="p">,</span><span class="nx">name</span><span class="p">);</span><span class="kd">var</span> <span class="nx">err</span><span class="o">=</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;probe error&quot;</span><span class="p">);</span><span class="nx">err</span><span class="p">.</span><span class="nx">transport</span><span class="o">=</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;upgradeError&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">)}})}</span><span class="kd">function</span> <span class="nx">freezeTransport</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">failed</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="nx">failed</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">cleanup</span><span class="p">();</span><span class="nx">transport</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span><span class="nx">transport</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="kd">function</span> <span class="nx">onerror</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="kd">var</span> <span class="nx">error</span><span class="o">=</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;probe error: &quot;</span><span class="o">+</span><span class="nx">err</span><span class="p">);</span><span class="nx">error</span><span class="p">.</span><span class="nx">transport</span><span class="o">=</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="nx">freezeTransport</span><span class="p">();</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;probe transport &quot;%s&quot; failed because of error: %s&#39;</span><span class="p">,</span><span class="nx">name</span><span class="p">,</span><span class="nx">err</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;upgradeError&quot;</span><span class="p">,</span><span class="nx">error</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">onTransportClose</span><span class="p">(){</span><span class="nx">onerror</span><span class="p">(</span><span class="s2">&quot;transport closed&quot;</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">onclose</span><span class="p">(){</span><span class="nx">onerror</span><span class="p">(</span><span class="s2">&quot;socket closed&quot;</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">onupgrade</span><span class="p">(</span><span class="nx">to</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">transport</span><span class="o">&amp;&amp;</span><span class="nx">to</span><span class="p">.</span><span class="nx">name</span><span class="o">!=</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;&quot;%s&quot; works - aborting &quot;%s&quot;&#39;</span><span class="p">,</span><span class="nx">to</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span><span class="nx">freezeTransport</span><span class="p">()}}</span><span class="kd">function</span> <span class="nx">cleanup</span><span class="p">(){</span><span class="nx">transport</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">,</span><span class="nx">onTransportOpen</span><span class="p">);</span><span class="nx">transport</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">onerror</span><span class="p">);</span><span class="nx">transport</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="nx">onTransportClose</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="nx">onclose</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;upgrading&quot;</span><span class="p">,</span><span class="nx">onupgrade</span><span class="p">)}</span><span class="nx">transport</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">,</span><span class="nx">onTransportOpen</span><span class="p">);</span><span class="nx">transport</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">onerror</span><span class="p">);</span><span class="nx">transport</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="nx">onTransportClose</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="nx">onclose</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;upgrading&quot;</span><span class="p">,</span><span class="nx">onupgrade</span><span class="p">);</span><span class="nx">transport</span><span class="p">.</span><span class="nx">open</span><span class="p">()};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onOpen</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;socket open&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">;</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span><span class="o">=</span><span class="s2">&quot;websocket&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">flush</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrade</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">pause</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;starting upgrade probes&quot;</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">l</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrades</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">l</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">probe</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrades</span><span class="p">[</span><span class="nx">i</span><span class="p">])}}};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onPacket</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;opening&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">||</span><span class="s2">&quot;open&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;socket receive: type &quot;%s&quot;, data &quot;%s&quot;&#39;</span><span class="p">,</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;packet&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;heartbeat&quot;</span><span class="p">);</span><span class="k">switch</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">){</span><span class="k">case</span><span class="s2">&quot;open&quot;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">onHandshake</span><span class="p">(</span><span class="nx">parsejson</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">));</span><span class="k">break</span><span class="p">;</span><span class="k">case</span><span class="s2">&quot;pong&quot;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">setPing</span><span class="p">();</span><span class="k">break</span><span class="p">;</span><span class="k">case</span><span class="s2">&quot;error&quot;</span><span class="o">:</span><span class="kd">var</span> <span class="nx">err</span><span class="o">=</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;server error&quot;</span><span class="p">);</span><span class="nx">err</span><span class="p">.</span><span class="nx">code</span><span class="o">=</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">);</span><span class="k">break</span><span class="p">;</span><span class="k">case</span><span class="s2">&quot;message&quot;</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="k">break</span><span class="p">}}</span><span class="k">else</span><span class="p">{</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;packet received with socket readyState &quot;%s&quot;&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)}};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onHandshake</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;handshake&quot;</span><span class="p">,</span><span class="nx">data</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">sid</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">sid</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrades</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">filterUpgrades</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">upgrades</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">pingInterval</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">pingInterval</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">pingTimeout</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">pingTimeout</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">onOpen</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;closed&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">setPing</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;heartbeat&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">onHeartbeat</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;heartbeat&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">onHeartbeat</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onHeartbeat</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">timeout</span><span class="p">){</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pingTimeoutTimer</span><span class="p">);</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingTimeoutTimer</span><span class="o">=</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;closed&quot;</span><span class="o">==</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">(</span><span class="s2">&quot;ping timeout&quot;</span><span class="p">)},</span><span class="nx">timeout</span><span class="o">||</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingInterval</span><span class="o">+</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingTimeout</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setPing</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingIntervalTimer</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingIntervalTimer</span><span class="o">=</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;writing ping packet - expecting pong within %sms&quot;</span><span class="p">,</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingTimeout</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">ping</span><span class="p">();</span><span class="nx">self</span><span class="p">.</span><span class="nx">onHeartbeat</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingTimeout</span><span class="p">)},</span><span class="nx">self</span><span class="p">.</span><span class="nx">pingInterval</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">ping</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">sendPacket</span><span class="p">(</span><span class="s2">&quot;ping&quot;</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onDrain</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]){</span><span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="p">[</span><span class="nx">i</span><span class="p">]()}}</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">flush</span><span class="p">()}};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">flush</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;closed&quot;</span><span class="o">!=</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">writable</span><span class="o">&amp;&amp;!</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrading</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;flushing %d packets in socket&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">prevBufferLen</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;flush&quot;</span><span class="p">)}};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span><span class="o">=</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">sendPacket</span><span class="p">(</span><span class="s2">&quot;message&quot;</span><span class="p">,</span><span class="nx">msg</span><span class="p">,</span><span class="nx">fn</span><span class="p">);</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">sendPacket</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="nx">data</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;closing&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">||</span><span class="s2">&quot;closed&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="k">return</span><span class="p">}</span><span class="kd">var</span> <span class="nx">packet</span><span class="o">=</span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="nx">type</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="nx">data</span><span class="p">};</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;packetCreate&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">flush</span><span class="p">()};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;opening&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">||</span><span class="s2">&quot;open&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;closing&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="kd">function</span> <span class="nx">close</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">(</span><span class="s2">&quot;forced close&quot;</span><span class="p">);</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;socket closing - telling transport to close&quot;</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">close</span><span class="p">()}</span><span class="kd">function</span> <span class="nx">cleanupAndClose</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;upgrade&quot;</span><span class="p">,</span><span class="nx">cleanupAndClose</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">removeListener</span><span class="p">(</span><span class="s2">&quot;upgradeError&quot;</span><span class="p">,</span><span class="nx">cleanupAndClose</span><span class="p">);</span><span class="nx">close</span><span class="p">()}</span><span class="kd">function</span> <span class="nx">waitForUpgrade</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;upgrade&quot;</span><span class="p">,</span><span class="nx">cleanupAndClose</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;upgradeError&quot;</span><span class="p">,</span><span class="nx">cleanupAndClose</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrading</span><span class="p">){</span><span class="nx">waitForUpgrade</span><span class="p">()}</span><span class="k">else</span><span class="p">{</span><span class="nx">close</span><span class="p">()}})}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">upgrading</span><span class="p">){</span><span class="nx">waitForUpgrade</span><span class="p">()}</span><span class="k">else</span><span class="p">{</span><span class="nx">close</span><span class="p">()}}</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onError</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;socket error %j&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">);</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">priorWebsocketSuccess</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">(</span><span class="s2">&quot;transport error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">)};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">reason</span><span class="p">,</span><span class="nx">desc</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;opening&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">||</span><span class="s2">&quot;open&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">||</span><span class="s2">&quot;closing&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;socket close with reason: &quot;%s&quot;&#39;</span><span class="p">,</span><span class="nx">reason</span><span class="p">);</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pingIntervalTimer</span><span class="p">);</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pingTimeoutTimer</span><span class="p">);</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="o">=</span><span class="p">[];</span><span class="nx">self</span><span class="p">.</span><span class="nx">callbackBuffer</span><span class="o">=</span><span class="p">[];</span><span class="nx">self</span><span class="p">.</span><span class="nx">prevBufferLen</span><span class="o">=</span><span class="mi">0</span><span class="p">},</span><span class="mi">0</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">transport</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;closed&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="nx">reason</span><span class="p">,</span><span class="nx">desc</span><span class="p">)}};</span><span class="nx">Socket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">filterUpgrades</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">upgrades</span><span class="p">){</span><span class="kd">var</span> <span class="nx">filteredUpgrades</span><span class="o">=</span><span class="p">[];</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">j</span><span class="o">=</span><span class="nx">upgrades</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">j</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">~</span><span class="nx">index</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">transports</span><span class="p">,</span><span class="nx">upgrades</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span><span class="nx">filteredUpgrades</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">upgrades</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span><span class="k">return</span> <span class="nx">filteredUpgrades</span><span class="p">}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{</span><span class="s2">&quot;./transport&quot;</span><span class="o">:</span><span class="mi">13</span><span class="p">,</span><span class="s2">&quot;./transports&quot;</span><span class="o">:</span><span class="mi">14</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="nx">debug</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">24</span><span class="p">,</span><span class="nx">indexof</span><span class="o">:</span><span class="mi">39</span><span class="p">,</span><span class="nx">parsejson</span><span class="o">:</span><span class="mi">31</span><span class="p">,</span><span class="nx">parseqs</span><span class="o">:</span><span class="mi">32</span><span class="p">,</span><span class="nx">parseuri</span><span class="o">:</span><span class="mi">33</span><span class="p">}],</span><span class="mi">13</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">parser</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">Emitter</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-emitter&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">Transport</span><span class="p">;</span><span class="kd">function</span> <span class="nx">Transport</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">secure</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">query</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">timestampParam</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">agent</span><span class="o">||</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">socket</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">}</span><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">timestamps</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onError</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="nx">desc</span><span class="p">){</span><span class="kd">var</span> <span class="nx">err</span><span class="o">=</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span><span class="nx">err</span><span class="p">.</span><span class="nx">type</span><span class="o">=</span><span class="s2">&quot;TransportError&quot;</span><span class="p">;</span><span class="nx">err</span><span class="p">.</span><span class="nx">description</span><span class="o">=</span><span class="nx">desc</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">);</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">open</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;closed&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">||</span><span class="s2">&quot;&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;opening&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">doOpen</span><span class="p">()}</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">close</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;opening&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">||</span><span class="s2">&quot;open&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">doClose</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">onClose</span><span class="p">()}</span><span class="k">return</span> <span class="k">this</span><span class="p">};</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">send</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">packets</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Transport not open&quot;</span><span class="p">)}};</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onOpen</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">writable</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">)};</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="kd">var</span> <span class="nx">packet</span><span class="o">=</span><span class="nx">parser</span><span class="p">.</span><span class="nx">decodePacket</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">binaryType</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">onPacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">)};</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onPacket</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;packet&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">)};</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;closed&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">)}},{</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">24</span><span class="p">}],</span><span class="mi">14</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">XMLHttpRequest</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;xmlhttprequest&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">XHR</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./polling-xhr&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">JSONP</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./polling-jsonp&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">websocket</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./websocket&quot;</span><span class="p">);</span><span class="nx">exports</span><span class="p">.</span><span class="nx">polling</span><span class="o">=</span><span class="nx">polling</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">websocket</span><span class="o">=</span><span class="nx">websocket</span><span class="p">;</span><span class="kd">function</span> <span class="nx">polling</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span><span class="kd">var</span> <span class="nx">xhr</span><span class="p">;</span><span class="kd">var</span> <span class="nx">xd</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="kd">var</span> <span class="nx">xs</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="kd">var</span> <span class="nx">jsonp</span><span class="o">=</span><span class="kc">false</span><span class="o">!==</span><span class="nx">opts</span><span class="p">.</span><span class="nx">jsonp</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="p">){</span><span class="kd">var</span> <span class="nx">isSSL</span><span class="o">=</span><span class="s2">&quot;https:&quot;</span><span class="o">==</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span><span class="kd">var</span> <span class="nx">port</span><span class="o">=</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">port</span><span class="p">){</span><span class="nx">port</span><span class="o">=</span><span class="nx">isSSL</span><span class="o">?</span><span class="mi">443</span><span class="o">:</span><span class="mi">80</span><span class="p">}</span><span class="nx">xd</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span><span class="o">!=</span><span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span><span class="o">||</span><span class="nx">port</span><span class="o">!=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span><span class="nx">xs</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span><span class="o">!=</span><span class="nx">isSSL</span><span class="p">}</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xdomain</span><span class="o">=</span><span class="nx">xd</span><span class="p">;</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xscheme</span><span class="o">=</span><span class="nx">xs</span><span class="p">;</span><span class="nx">xhr</span><span class="o">=</span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="k">in</span> <span class="nx">xhr</span><span class="o">&amp;&amp;!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceJSONP</span><span class="p">){</span><span class="k">return</span> <span class="k">new</span> <span class="nx">XHR</span><span class="p">(</span><span class="nx">opts</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">jsonp</span><span class="p">)</span><span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;JSONP disabled&quot;</span><span class="p">);</span><span class="k">return</span> <span class="k">new</span> <span class="nx">JSONP</span><span class="p">(</span><span class="nx">opts</span><span class="p">)}}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{</span><span class="s2">&quot;./polling-jsonp&quot;</span><span class="o">:</span><span class="mi">15</span><span class="p">,</span><span class="s2">&quot;./polling-xhr&quot;</span><span class="o">:</span><span class="mi">16</span><span class="p">,</span><span class="s2">&quot;./websocket&quot;</span><span class="o">:</span><span class="mi">18</span><span class="p">,</span><span class="nx">xmlhttprequest</span><span class="o">:</span><span class="mi">19</span><span class="p">}],</span><span class="mi">15</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">Polling</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./polling&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">inherit</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-inherit&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">JSONPPolling</span><span class="p">;</span><span class="kd">var</span> <span class="nx">rNewline</span><span class="o">=</span><span class="sr">/\n/g</span><span class="p">;</span><span class="kd">var</span> <span class="nx">rEscapedNewline</span><span class="o">=</span><span class="sr">/\\n/g</span><span class="p">;</span><span class="kd">var</span> <span class="nx">callbacks</span><span class="p">;</span><span class="kd">var</span> <span class="nx">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="kd">function</span> <span class="nx">empty</span><span class="p">(){}</span><span class="kd">function</span> <span class="nx">JSONPPolling</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">opts</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="o">||</span><span class="p">{};</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">callbacks</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">___eio</span><span class="p">)</span><span class="nx">global</span><span class="p">.</span><span class="nx">___eio</span><span class="o">=</span><span class="p">[];</span><span class="nx">callbacks</span><span class="o">=</span><span class="nx">global</span><span class="p">.</span><span class="nx">___eio</span><span class="p">}</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="o">=</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="nx">msg</span><span class="p">)});</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">j</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="o">&amp;&amp;</span><span class="nx">global</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">){</span><span class="nx">global</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;beforeunload&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">script</span><span class="p">)</span><span class="nx">self</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">onerror</span><span class="o">=</span><span class="nx">empty</span><span class="p">},</span><span class="kc">false</span><span class="p">)}}</span><span class="nx">inherit</span><span class="p">(</span><span class="nx">JSONPPolling</span><span class="p">,</span><span class="nx">Polling</span><span class="p">);</span><span class="nx">JSONPPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="nx">JSONPPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doClose</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">iframe</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doClose</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)};</span><span class="nx">JSONPPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doPoll</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="kd">var</span> <span class="nx">script</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="nx">script</span><span class="p">.</span><span class="nx">async</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">script</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">();</span><span class="nx">script</span><span class="p">.</span><span class="nx">onerror</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;jsonp poll error&quot;</span><span class="p">,</span><span class="nx">e</span><span class="p">)};</span><span class="kd">var</span> <span class="nx">insertAt</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span><span class="nx">insertAt</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span><span class="nx">insertAt</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">script</span><span class="o">=</span><span class="nx">script</span><span class="p">;</span><span class="kd">var</span> <span class="nx">isUAgecko</span><span class="o">=</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">navigator</span><span class="o">&amp;&amp;</span><span class="sr">/gecko/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">isUAgecko</span><span class="p">){</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">iframe</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;iframe&quot;</span><span class="p">);</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">iframe</span><span class="p">)},</span><span class="mi">100</span><span class="p">)}};</span><span class="nx">JSONPPolling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doWrite</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">){</span><span class="kd">var</span> <span class="nx">form</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;form&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">area</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;textarea&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">id</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">iframeId</span><span class="o">=</span><span class="s2">&quot;eio_iframe_&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span><span class="kd">var</span> <span class="nx">iframe</span><span class="p">;</span><span class="nx">form</span><span class="p">.</span><span class="nx">className</span><span class="o">=</span><span class="s2">&quot;socketio&quot;</span><span class="p">;</span><span class="nx">form</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">position</span><span class="o">=</span><span class="s2">&quot;absolute&quot;</span><span class="p">;</span><span class="nx">form</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span><span class="o">=</span><span class="s2">&quot;-1000px&quot;</span><span class="p">;</span><span class="nx">form</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span><span class="o">=</span><span class="s2">&quot;-1000px&quot;</span><span class="p">;</span><span class="nx">form</span><span class="p">.</span><span class="nx">target</span><span class="o">=</span><span class="nx">id</span><span class="p">;</span><span class="nx">form</span><span class="p">.</span><span class="nx">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">;</span><span class="nx">form</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;accept-charset&quot;</span><span class="p">,</span><span class="s2">&quot;utf-8&quot;</span><span class="p">);</span><span class="nx">area</span><span class="p">.</span><span class="nx">name</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">;</span><span class="nx">form</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">area</span><span class="p">);</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">form</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="o">=</span><span class="nx">form</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">area</span><span class="o">=</span><span class="nx">area</span><span class="p">}</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">action</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">();</span><span class="kd">function</span> <span class="nx">complete</span><span class="p">(){</span><span class="nx">initIframe</span><span class="p">();</span><span class="nx">fn</span><span class="p">()}</span><span class="kd">function</span> <span class="nx">initIframe</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframe</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframe</span><span class="p">)</span>
<span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;jsonp polling iframe removal error&quot;</span><span class="p">,</span><span class="nx">e</span><span class="p">)}}</span><span class="k">try</span><span class="p">{</span><span class="kd">var</span> <span class="nx">html</span><span class="o">=</span><span class="s1">&#39;&lt;iframe src=&quot;javascript:0&quot; name=&quot;&#39;</span><span class="o">+</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframeId</span><span class="o">+</span><span class="s1">&#39;&quot;&gt;&#39;</span><span class="p">;</span><span class="nx">iframe</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="nx">html</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">iframe</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;iframe&quot;</span><span class="p">);</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">name</span><span class="o">=</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframeId</span><span class="p">;</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">src</span><span class="o">=</span><span class="s2">&quot;javascript:0&quot;</span><span class="p">}</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">id</span><span class="o">=</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframeId</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">iframe</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframe</span><span class="o">=</span><span class="nx">iframe</span><span class="p">}</span><span class="nx">initIframe</span><span class="p">();</span><span class="nx">data</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rEscapedNewline</span><span class="p">,</span><span class="s2">&quot;\\\n&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">area</span><span class="p">.</span><span class="nx">value</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rNewline</span><span class="p">,</span><span class="s2">&quot;\\n&quot;</span><span class="p">);</span><span class="k">try</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">submit</span><span class="p">()}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">onreadystatechange</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">readyState</span><span class="o">==</span><span class="s2">&quot;complete&quot;</span><span class="p">){</span><span class="nx">complete</span><span class="p">()}}}</span><span class="k">else</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">iframe</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="nx">complete</span><span class="p">}}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{</span><span class="s2">&quot;./polling&quot;</span><span class="o">:</span><span class="mi">17</span><span class="p">,</span><span class="s2">&quot;component-inherit&quot;</span><span class="o">:</span><span class="mi">20</span><span class="p">}],</span><span class="mi">16</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">XMLHttpRequest</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;xmlhttprequest&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">Polling</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./polling&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">Emitter</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-emitter&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">inherit</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-inherit&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)(</span><span class="s2">&quot;engine.io-client:polling-xhr&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">XHR</span><span class="p">;</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">Request</span><span class="o">=</span><span class="nx">Request</span><span class="p">;</span><span class="kd">function</span> <span class="nx">empty</span><span class="p">(){}</span><span class="kd">function</span> <span class="nx">XHR</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">opts</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="p">){</span><span class="kd">var</span> <span class="nx">isSSL</span><span class="o">=</span><span class="s2">&quot;https:&quot;</span><span class="o">==</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">;</span><span class="kd">var</span> <span class="nx">port</span><span class="o">=</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">port</span><span class="p">){</span><span class="nx">port</span><span class="o">=</span><span class="nx">isSSL</span><span class="o">?</span><span class="mi">443</span><span class="o">:</span><span class="mi">80</span><span class="p">}</span><span class="k">this</span><span class="p">.</span><span class="nx">xd</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">hostname</span><span class="o">!=</span><span class="nx">global</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span><span class="o">||</span><span class="nx">port</span><span class="o">!=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">port</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">xs</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">secure</span><span class="o">!=</span><span class="nx">isSSL</span><span class="p">}}</span><span class="nx">inherit</span><span class="p">(</span><span class="nx">XHR</span><span class="p">,</span><span class="nx">Polling</span><span class="p">);</span><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">request</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span><span class="nx">opts</span><span class="o">=</span><span class="nx">opts</span><span class="o">||</span><span class="p">{};</span><span class="nx">opts</span><span class="p">.</span><span class="nx">uri</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">();</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xd</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">xd</span><span class="p">;</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xs</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">xs</span><span class="p">;</span><span class="nx">opts</span><span class="p">.</span><span class="nx">agent</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="o">||</span><span class="kc">false</span><span class="p">;</span><span class="nx">opts</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">;</span><span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span><span class="k">return</span> <span class="k">new</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">opts</span><span class="p">)};</span><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doWrite</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">fn</span><span class="p">){</span><span class="kd">var</span> <span class="nx">isBinary</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">data</span><span class="o">!==</span><span class="s2">&quot;string&quot;</span><span class="o">&amp;&amp;</span><span class="nx">data</span><span class="o">!==</span><span class="kc">undefined</span><span class="p">;</span><span class="kd">var</span> <span class="nx">req</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span><span class="nx">method</span><span class="o">:</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="nx">data</span><span class="p">,</span><span class="nx">isBinary</span><span class="o">:</span><span class="nx">isBinary</span><span class="p">});</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">,</span><span class="nx">fn</span><span class="p">);</span><span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;xhr post error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">)});</span><span class="k">this</span><span class="p">.</span><span class="nx">sendXhr</span><span class="o">=</span><span class="nx">req</span><span class="p">};</span><span class="nx">XHR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doPoll</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;xhr poll&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">req</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">();</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="nx">data</span><span class="p">)});</span><span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;xhr poll error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">)});</span><span class="k">this</span><span class="p">.</span><span class="nx">pollXhr</span><span class="o">=</span><span class="nx">req</span><span class="p">};</span><span class="kd">function</span> <span class="nx">Request</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">method</span><span class="o">||</span><span class="s2">&quot;GET&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">uri</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">xd</span><span class="o">=!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xd</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">xs</span><span class="o">=!!</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xs</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">async</span><span class="o">=</span><span class="kc">false</span><span class="o">!==</span><span class="nx">opts</span><span class="p">.</span><span class="nx">async</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="o">=</span><span class="kc">undefined</span><span class="o">!=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span><span class="nx">opts</span><span class="p">.</span><span class="nx">data</span><span class="o">:</span><span class="kc">null</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">agent</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">isBinary</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">isBinary</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">create</span><span class="p">()}</span><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">create</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">xhr</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="o">=</span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">({</span><span class="nx">agent</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="p">,</span><span class="nx">xdomain</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">xd</span><span class="p">,</span><span class="nx">xscheme</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">xs</span><span class="p">,</span><span class="nx">enablesXDR</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">});</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;xhr open %s: %s&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">);</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">async</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">){</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseType</span><span class="o">=</span><span class="s2">&quot;arraybuffer&quot;</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;POST&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">method</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">isBinary</span><span class="p">){</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Content-type&quot;</span><span class="p">,</span><span class="s2">&quot;text/plain;charset=UTF-8&quot;</span><span class="p">)}}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}}</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;withCredentials&quot;</span><span class="k">in</span> <span class="nx">xhr</span><span class="p">){</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">withCredentials</span><span class="o">=</span><span class="kc">true</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasXDR</span><span class="p">()){</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onLoad</span><span class="p">()};</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)}}</span><span class="k">else</span><span class="p">{</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="mi">4</span><span class="o">!=</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="mi">200</span><span class="o">==</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="o">||</span><span class="mi">1223</span><span class="o">==</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onLoad</span><span class="p">()}</span><span class="k">else</span><span class="p">{</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span><span class="p">)},</span><span class="mi">0</span><span class="p">)}}}</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;xhr data %s&quot;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">e</span><span class="p">)},</span><span class="mi">0</span><span class="p">);</span><span class="k">return</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="o">=</span><span class="nx">Request</span><span class="p">.</span><span class="nx">requestsCount</span><span class="o">++</span><span class="p">;</span><span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">]</span><span class="o">=</span><span class="k">this</span><span class="p">}};</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onSuccess</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">()};</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span><span class="nx">data</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">onSuccess</span><span class="p">()};</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onError</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">err</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">()};</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">cleanup</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;undefined&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="o">||</span><span class="kc">null</span><span class="o">===</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">){</span><span class="k">return</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">hasXDR</span><span class="p">()){</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onerror</span><span class="o">=</span><span class="nx">empty</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">onreadystatechange</span><span class="o">=</span><span class="nx">empty</span><span class="p">}</span><span class="k">try</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">abort</span><span class="p">()}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">){</span><span class="k">delete</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">index</span><span class="p">]}</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="o">=</span><span class="kc">null</span><span class="p">};</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onLoad</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">data</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="kd">var</span> <span class="nx">contentType</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="nx">contentType</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">getResponseHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span><span class="k">if</span><span class="p">(</span><span class="nx">contentType</span><span class="o">===</span><span class="s2">&quot;application/octet-stream&quot;</span><span class="p">){</span><span class="nx">data</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">response</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">){</span><span class="nx">data</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">data</span><span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="p">}}}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="nx">e</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">!=</span><span class="nx">data</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="nx">data</span><span class="p">)}};</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasXDR</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span><span class="s2">&quot;undefined&quot;</span><span class="o">!==</span><span class="k">typeof</span> <span class="nx">global</span><span class="p">.</span><span class="nx">XDomainRequest</span><span class="o">&amp;&amp;!</span><span class="k">this</span><span class="p">.</span><span class="nx">xs</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">};</span><span class="nx">Request</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">abort</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">cleanup</span><span class="p">()};</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nb">document</span><span class="p">){</span><span class="nx">Request</span><span class="p">.</span><span class="nx">requestsCount</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="o">=</span><span class="p">{};</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">){</span><span class="nx">global</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s2">&quot;onunload&quot;</span><span class="p">,</span><span class="nx">unloadHandler</span><span class="p">)}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">){</span><span class="nx">global</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;beforeunload&quot;</span><span class="p">,</span><span class="nx">unloadHandler</span><span class="p">,</span><span class="kc">false</span><span class="p">)}}</span><span class="kd">function</span> <span class="nx">unloadHandler</span><span class="p">(){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">)){</span><span class="nx">Request</span><span class="p">.</span><span class="nx">requests</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">abort</span><span class="p">()}}}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{</span><span class="s2">&quot;./polling&quot;</span><span class="o">:</span><span class="mi">17</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="s2">&quot;component-inherit&quot;</span><span class="o">:</span><span class="mi">20</span><span class="p">,</span><span class="nx">debug</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="nx">xmlhttprequest</span><span class="o">:</span><span class="mi">19</span><span class="p">}],</span><span class="mi">17</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">Transport</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;../transport&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parseqs</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;parseqs&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parser</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">inherit</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-inherit&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)(</span><span class="s2">&quot;engine.io-client:polling&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">Polling</span><span class="p">;</span><span class="kd">var</span> <span class="nx">hasXHR2</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">XMLHttpRequest</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;xmlhttprequest&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">xhr</span><span class="o">=</span><span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">({</span><span class="nx">xdomain</span><span class="o">:</span><span class="kc">false</span><span class="p">});</span><span class="k">return</span> <span class="kc">null</span><span class="o">!=</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseType</span><span class="p">}();</span><span class="kd">function</span> <span class="nx">Polling</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span><span class="kd">var</span> <span class="nx">forceBase64</span><span class="o">=</span><span class="nx">opts</span><span class="o">&amp;&amp;</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceBase64</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">hasXHR2</span><span class="o">||</span><span class="nx">forceBase64</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">opts</span><span class="p">)}</span><span class="nx">inherit</span><span class="p">(</span><span class="nx">Polling</span><span class="p">,</span><span class="nx">Transport</span><span class="p">);</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span><span class="o">=</span><span class="s2">&quot;polling&quot;</span><span class="p">;</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doOpen</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">poll</span><span class="p">()};</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pause</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">onPause</span><span class="p">){</span><span class="kd">var</span> <span class="nx">pending</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;pausing&quot;</span><span class="p">;</span><span class="kd">function</span> <span class="nx">pause</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;paused&quot;</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span><span class="o">=</span><span class="s2">&quot;paused&quot;</span><span class="p">;</span><span class="nx">onPause</span><span class="p">()}</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">polling</span><span class="o">||!</span><span class="k">this</span><span class="p">.</span><span class="nx">writable</span><span class="p">){</span><span class="kd">var</span> <span class="nx">total</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">polling</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;we are currently polling - waiting to pause&quot;</span><span class="p">);</span><span class="nx">total</span><span class="o">++</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;pollComplete&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;pre-pause polling complete&quot;</span><span class="p">);</span><span class="o">--</span><span class="nx">total</span><span class="o">||</span><span class="nx">pause</span><span class="p">()})}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">writable</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;we are currently writing - waiting to pause&quot;</span><span class="p">);</span><span class="nx">total</span><span class="o">++</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">,</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;pre-pause writing complete&quot;</span><span class="p">);</span><span class="o">--</span><span class="nx">total</span><span class="o">||</span><span class="nx">pause</span><span class="p">()})}}</span><span class="k">else</span><span class="p">{</span><span class="nx">pause</span><span class="p">()}};</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">poll</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;polling&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">polling</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">doPoll</span><span class="p">();</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;poll&quot;</span><span class="p">)};</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;polling got data %s&quot;</span><span class="p">,</span><span class="nx">data</span><span class="p">);</span><span class="kd">var</span> <span class="nx">callback</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">index</span><span class="p">,</span><span class="nx">total</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;opening&quot;</span><span class="o">==</span><span class="nx">self</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onOpen</span><span class="p">()}</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="o">==</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">();</span><span class="k">return</span> <span class="kc">false</span><span class="p">}</span><span class="nx">self</span><span class="p">.</span><span class="nx">onPacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">)};</span><span class="nx">parser</span><span class="p">.</span><span class="nx">decodePayload</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">binaryType</span><span class="p">,</span><span class="nx">callback</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;closed&quot;</span><span class="o">!=</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">polling</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;pollComplete&quot;</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">poll</span><span class="p">()}</span><span class="k">else</span><span class="p">{</span><span class="nx">debug</span><span class="p">(</span><span class="s1">&#39;ignoring poll - transport state &quot;%s&quot;&#39;</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)}}};</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doClose</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="kd">function</span> <span class="nx">close</span><span class="p">(){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;writing close packet&quot;</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">write</span><span class="p">([{</span><span class="nx">type</span><span class="o">:</span><span class="s2">&quot;close&quot;</span><span class="p">}])}</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;transport open - closing&quot;</span><span class="p">);</span><span class="nx">close</span><span class="p">()}</span><span class="k">else</span><span class="p">{</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;transport not open - deferring close&quot;</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;open&quot;</span><span class="p">,</span><span class="nx">close</span><span class="p">)}};</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">writable</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="kd">var</span> <span class="nx">callbackfn</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">writable</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">)};</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">parser</span><span class="p">.</span><span class="nx">encodePayload</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">doWrite</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">callbackfn</span><span class="p">)})};</span><span class="nx">Polling</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">uri</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">query</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="o">||</span><span class="p">{};</span><span class="kd">var</span> <span class="nx">schema</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">secure</span><span class="o">?</span><span class="s2">&quot;https&quot;</span><span class="o">:</span><span class="s2">&quot;http&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">port</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="kc">false</span><span class="o">!==</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">){</span><span class="nx">query</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span><span class="p">]</span><span class="o">=+</span><span class="k">new</span> <span class="nb">Date</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">timestamps</span><span class="o">++</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">&amp;&amp;!</span><span class="nx">query</span><span class="p">.</span><span class="nx">sid</span><span class="p">){</span><span class="nx">query</span><span class="p">.</span><span class="nx">b64</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="nx">query</span><span class="o">=</span><span class="nx">parseqs</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="o">==</span><span class="nx">schema</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="o">!=</span><span class="mi">443</span><span class="o">||</span><span class="s2">&quot;http&quot;</span><span class="o">==</span><span class="nx">schema</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="o">!=</span><span class="mi">80</span><span class="p">)){</span><span class="nx">port</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="nx">query</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="o">+</span><span class="nx">query</span><span class="p">}</span><span class="k">return</span> <span class="nx">schema</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="o">+</span><span class="nx">port</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="o">+</span><span class="nx">query</span><span class="p">}},{</span><span class="s2">&quot;../transport&quot;</span><span class="o">:</span><span class="mi">13</span><span class="p">,</span><span class="s2">&quot;component-inherit&quot;</span><span class="o">:</span><span class="mi">20</span><span class="p">,</span><span class="nx">debug</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">24</span><span class="p">,</span><span class="nx">parseqs</span><span class="o">:</span><span class="mi">32</span><span class="p">,</span><span class="nx">xmlhttprequest</span><span class="o">:</span><span class="mi">19</span><span class="p">}],</span><span class="mi">18</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">Transport</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;../transport&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parser</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parseqs</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;parseqs&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">inherit</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-inherit&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)(</span><span class="s2">&quot;engine.io-client:websocket&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">WebSocket</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;ws&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">WS</span><span class="p">;</span><span class="kd">function</span> <span class="nx">WS</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span><span class="kd">var</span> <span class="nx">forceBase64</span><span class="o">=</span><span class="nx">opts</span><span class="o">&amp;&amp;</span><span class="nx">opts</span><span class="p">.</span><span class="nx">forceBase64</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">forceBase64</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">opts</span><span class="p">)}</span><span class="nx">inherit</span><span class="p">(</span><span class="nx">WS</span><span class="p">,</span><span class="nx">Transport</span><span class="p">);</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span><span class="o">=</span><span class="s2">&quot;websocket&quot;</span><span class="p">;</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doOpen</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">check</span><span class="p">()){</span><span class="k">return</span><span class="p">}</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="kd">var</span> <span class="nx">uri</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">uri</span><span class="p">();</span><span class="kd">var</span> <span class="nx">protocols</span><span class="o">=</span><span class="k">void</span> <span class="mi">0</span><span class="p">;</span><span class="kd">var</span> <span class="nx">opts</span><span class="o">=</span><span class="p">{</span><span class="nx">agent</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">agent</span><span class="p">};</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="o">=</span><span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span><span class="nx">protocols</span><span class="p">,</span><span class="nx">opts</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">binaryType</span><span class="o">===</span><span class="kc">undefined</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">binaryType</span><span class="o">=</span><span class="s2">&quot;arraybuffer&quot;</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">addEventListeners</span><span class="p">()};</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addEventListeners</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onopen</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onOpen</span><span class="p">()};</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onclose</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onClose</span><span class="p">()};</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onmessage</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onData</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">data</span><span class="p">)};</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">onerror</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">self</span><span class="p">.</span><span class="nx">onError</span><span class="p">(</span><span class="s2">&quot;websocket error&quot;</span><span class="p">,</span><span class="nx">e</span><span class="p">)}};</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">navigator</span><span class="o">&amp;&amp;</span><span class="sr">/iPad|iPhone|iPod/i</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">)){</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onData</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="nx">data</span><span class="p">)},</span><span class="mi">0</span><span class="p">)}}</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">write</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="k">this</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">writable</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">l</span><span class="o">=</span><span class="nx">packets</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">l</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">parser</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packets</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">self</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;websocket closed before onclose event&quot;</span><span class="p">)}})}</span><span class="kd">function</span> <span class="nx">ondrain</span><span class="p">(){</span><span class="nx">self</span><span class="p">.</span><span class="nx">writable</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;drain&quot;</span><span class="p">)}</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">ondrain</span><span class="p">,</span><span class="mi">0</span><span class="p">)};</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">Transport</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">onClose</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)};</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">doClose</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">ws</span><span class="p">.</span><span class="nx">close</span><span class="p">()}};</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">uri</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">query</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="o">||</span><span class="p">{};</span><span class="kd">var</span> <span class="nx">schema</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">secure</span><span class="o">?</span><span class="s2">&quot;wss&quot;</span><span class="o">:</span><span class="s2">&quot;ws&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">port</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="s2">&quot;wss&quot;</span><span class="o">==</span><span class="nx">schema</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="o">!=</span><span class="mi">443</span><span class="o">||</span><span class="s2">&quot;ws&quot;</span><span class="o">==</span><span class="nx">schema</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="o">!=</span><span class="mi">80</span><span class="p">)){</span><span class="nx">port</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">port</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampRequests</span><span class="p">){</span><span class="nx">query</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">timestampParam</span><span class="p">]</span><span class="o">=+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">supportsBinary</span><span class="p">){</span><span class="nx">query</span><span class="p">.</span><span class="nx">b64</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="nx">query</span><span class="o">=</span><span class="nx">parseqs</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">query</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="nx">query</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="o">+</span><span class="nx">query</span><span class="p">}</span><span class="k">return</span> <span class="nx">schema</span><span class="o">+</span><span class="s2">&quot;://&quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">hostname</span><span class="o">+</span><span class="nx">port</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">path</span><span class="o">+</span><span class="nx">query</span><span class="p">};</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">check</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span><span class="o">!!</span><span class="nx">WebSocket</span><span class="o">&amp;&amp;!</span><span class="p">(</span><span class="s2">&quot;__initialize&quot;</span><span class="k">in</span> <span class="nx">WebSocket</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="o">===</span><span class="nx">WS</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">name</span><span class="p">)}},{</span><span class="s2">&quot;../transport&quot;</span><span class="o">:</span><span class="mi">13</span><span class="p">,</span><span class="s2">&quot;component-inherit&quot;</span><span class="o">:</span><span class="mi">20</span><span class="p">,</span><span class="nx">debug</span><span class="o">:</span><span class="mi">21</span><span class="p">,</span><span class="s2">&quot;engine.io-parser&quot;</span><span class="o">:</span><span class="mi">24</span><span class="p">,</span><span class="nx">parseqs</span><span class="o">:</span><span class="mi">32</span><span class="p">,</span><span class="nx">ws</span><span class="o">:</span><span class="mi">34</span><span class="p">}],</span><span class="mi">19</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">hasCORS</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;has-cors&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">opts</span><span class="p">){</span><span class="kd">var</span> <span class="nx">xdomain</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xdomain</span><span class="p">;</span><span class="kd">var</span> <span class="nx">xscheme</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">xscheme</span><span class="p">;</span><span class="kd">var</span> <span class="nx">enablesXDR</span><span class="o">=</span><span class="nx">opts</span><span class="p">.</span><span class="nx">enablesXDR</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">XMLHttpRequest</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="o">!</span><span class="nx">xdomain</span><span class="o">||</span><span class="nx">hasCORS</span><span class="p">)){</span><span class="k">return</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">}}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span><span class="k">try</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;undefined&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">XDomainRequest</span><span class="o">&amp;&amp;!</span><span class="nx">xscheme</span><span class="o">&amp;&amp;</span><span class="nx">enablesXDR</span><span class="p">){</span><span class="k">return</span> <span class="k">new</span> <span class="nx">XDomainRequest</span><span class="p">}}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">xdomain</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="k">return</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;Microsoft.XMLHTTP&quot;</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}}}},{</span><span class="s2">&quot;has-cors&quot;</span><span class="o">:</span><span class="mi">37</span><span class="p">}],</span><span class="mi">20</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span><span class="kd">var</span> <span class="nx">fn</span><span class="o">=</span><span class="kd">function</span><span class="p">(){};</span><span class="nx">fn</span><span class="p">.</span><span class="nx">prototype</span><span class="o">=</span><span class="nx">b</span><span class="p">.</span><span class="nx">prototype</span><span class="p">;</span><span class="nx">a</span><span class="p">.</span><span class="nx">prototype</span><span class="o">=</span><span class="k">new</span> <span class="nx">fn</span><span class="p">;</span><span class="nx">a</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">constructor</span><span class="o">=</span><span class="nx">a</span><span class="p">}},{}],</span><span class="mi">21</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">exports</span><span class="o">=</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./debug&quot;</span><span class="p">);</span><span class="nx">exports</span><span class="p">.</span><span class="nx">log</span><span class="o">=</span><span class="nx">log</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">formatArgs</span><span class="o">=</span><span class="nx">formatArgs</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">save</span><span class="o">=</span><span class="nx">save</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">load</span><span class="o">=</span><span class="nx">load</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">useColors</span><span class="o">=</span><span class="nx">useColors</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">colors</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;lightseagreen&quot;</span><span class="p">,</span><span class="s2">&quot;forestgreen&quot;</span><span class="p">,</span><span class="s2">&quot;goldenrod&quot;</span><span class="p">,</span><span class="s2">&quot;dodgerblue&quot;</span><span class="p">,</span><span class="s2">&quot;darkorchid&quot;</span><span class="p">,</span><span class="s2">&quot;crimson&quot;</span><span class="p">];</span><span class="kd">function</span> <span class="nx">useColors</span><span class="p">(){</span><span class="k">return</span><span class="s2">&quot;WebkitAppearance&quot;</span><span class="k">in</span> <span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">style</span><span class="o">||</span><span class="nb">window</span><span class="p">.</span><span class="nx">console</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">firebug</span><span class="o">||</span><span class="nx">console</span><span class="p">.</span><span class="nx">exception</span><span class="o">&amp;&amp;</span><span class="nx">console</span><span class="p">.</span><span class="nx">table</span><span class="p">)</span><span class="o">||</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/firefox\/(\d+)/</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="nb">parseInt</span><span class="p">(</span><span class="nb">RegExp</span><span class="p">.</span><span class="nx">$1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">31</span><span class="p">}</span><span class="nx">exports</span><span class="p">.</span><span class="nx">formatters</span><span class="p">.</span><span class="nx">j</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">){</span><span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">v</span><span class="p">)};</span><span class="kd">function</span> <span class="nx">formatArgs</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">args</span><span class="o">=</span><span class="nx">arguments</span><span class="p">;</span><span class="kd">var</span> <span class="nx">useColors</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">useColors</span><span class="p">;</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="nx">useColors</span><span class="o">?</span><span class="s2">&quot;%c&quot;</span><span class="o">:</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">namespace</span><span class="o">+</span><span class="p">(</span><span class="nx">useColors</span><span class="o">?</span><span class="s2">&quot; %c&quot;</span><span class="o">:</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">+</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="p">(</span><span class="nx">useColors</span><span class="o">?</span><span class="s2">&quot;%c &quot;</span><span class="o">:</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;+&quot;</span><span class="o">+</span><span class="nx">exports</span><span class="p">.</span><span class="nx">humanize</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">diff</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">useColors</span><span class="p">)</span><span class="k">return</span> <span class="nx">args</span><span class="p">;</span><span class="kd">var</span> <span class="nx">c</span><span class="o">=</span><span class="s2">&quot;color: &quot;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span><span class="nx">args</span><span class="o">=</span><span class="p">[</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nx">c</span><span class="p">,</span><span class="s2">&quot;color: inherit&quot;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span><span class="kd">var</span> <span class="nx">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="kd">var</span> <span class="nx">lastC</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/%[a-z%]/g</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="o">===</span><span class="nx">match</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;%c&quot;</span><span class="o">===</span><span class="nx">match</span><span class="p">){</span><span class="nx">lastC</span><span class="o">=</span><span class="nx">index</span><span class="p">}});</span><span class="nx">args</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">lastC</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">c</span><span class="p">);</span><span class="k">return</span> <span class="nx">args</span><span class="p">}</span><span class="kd">function</span> <span class="nx">log</span><span class="p">(){</span><span class="k">return</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">console</span><span class="o">&amp;&amp;</span><span class="s2">&quot;function&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="o">&amp;&amp;</span><span class="nb">Function</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">apply</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">,</span><span class="nx">console</span><span class="p">,</span><span class="nx">arguments</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">save</span><span class="p">(</span><span class="nx">namespaces</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">==</span><span class="nx">namespaces</span><span class="p">){</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">debug</span><span class="o">=</span><span class="nx">namespaces</span><span class="p">}}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}}</span><span class="kd">function</span> <span class="nx">load</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">r</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="nx">r</span><span class="o">=</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">debug</span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){}</span><span class="k">return</span> <span class="nx">r</span><span class="p">}</span><span class="nx">exports</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="nx">load</span><span class="p">())},{</span><span class="s2">&quot;./debug&quot;</span><span class="o">:</span><span class="mi">22</span><span class="p">}],</span><span class="mi">22</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">exports</span><span class="o">=</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">debug</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">coerce</span><span class="o">=</span><span class="nx">coerce</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">disable</span><span class="o">=</span><span class="nx">disable</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">enable</span><span class="o">=</span><span class="nx">enable</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">enabled</span><span class="o">=</span><span class="nx">enabled</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">humanize</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;ms&quot;</span><span class="p">);</span><span class="nx">exports</span><span class="p">.</span><span class="nx">names</span><span class="o">=</span><span class="p">[];</span><span class="nx">exports</span><span class="p">.</span><span class="nx">skips</span><span class="o">=</span><span class="p">[];</span><span class="nx">exports</span><span class="p">.</span><span class="nx">formatters</span><span class="o">=</span><span class="p">{};</span><span class="kd">var</span> <span class="nx">prevColor</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="kd">var</span> <span class="nx">prevTime</span><span class="p">;</span><span class="kd">function</span> <span class="nx">selectColor</span><span class="p">(){</span><span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">colors</span><span class="p">[</span><span class="nx">prevColor</span><span class="o">++%</span><span class="nx">exports</span><span class="p">.</span><span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">]}</span><span class="kd">function</span> <span class="nx">debug</span><span class="p">(</span><span class="nx">namespace</span><span class="p">){</span><span class="kd">function</span> <span class="nx">disabled</span><span class="p">(){}</span><span class="nx">disabled</span><span class="p">.</span><span class="nx">enabled</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="kd">function</span> <span class="nx">enabled</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">self</span><span class="o">=</span><span class="nx">enabled</span><span class="p">;</span><span class="kd">var</span> <span class="nx">curr</span><span class="o">=+</span><span class="k">new</span> <span class="nb">Date</span><span class="p">;</span><span class="kd">var</span> <span class="nx">ms</span><span class="o">=</span><span class="nx">curr</span><span class="o">-</span><span class="p">(</span><span class="nx">prevTime</span><span class="o">||</span><span class="nx">curr</span><span class="p">);</span><span class="nx">self</span><span class="p">.</span><span class="nx">diff</span><span class="o">=</span><span class="nx">ms</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">prev</span><span class="o">=</span><span class="nx">prevTime</span><span class="p">;</span><span class="nx">self</span><span class="p">.</span><span class="nx">curr</span><span class="o">=</span><span class="nx">curr</span><span class="p">;</span><span class="nx">prevTime</span><span class="o">=</span><span class="nx">curr</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">==</span><span class="nx">self</span><span class="p">.</span><span class="nx">useColors</span><span class="p">)</span><span class="nx">self</span><span class="p">.</span><span class="nx">useColors</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">useColors</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">==</span><span class="nx">self</span><span class="p">.</span><span class="nx">color</span><span class="o">&amp;&amp;</span><span class="nx">self</span><span class="p">.</span><span class="nx">useColors</span><span class="p">)</span><span class="nx">self</span><span class="p">.</span><span class="nx">color</span><span class="o">=</span><span class="nx">selectColor</span><span class="p">();</span><span class="kd">var</span> <span class="nx">args</span><span class="o">=</span><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">coerce</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="o">!==</span><span class="k">typeof</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]){</span><span class="nx">args</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;%o&quot;</span><span class="p">].</span><span class="nx">concat</span><span class="p">(</span><span class="nx">args</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/%([a-z%])/g</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span><span class="nx">format</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">match</span><span class="o">===</span><span class="s2">&quot;%&quot;</span><span class="p">)</span><span class="k">return</span> <span class="nx">match</span><span class="p">;</span><span class="nx">index</span><span class="o">++</span><span class="p">;</span><span class="kd">var</span> <span class="nx">formatter</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">formatters</span><span class="p">[</span><span class="nx">format</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="o">===</span><span class="k">typeof</span> <span class="nx">formatter</span><span class="p">){</span><span class="kd">var</span> <span class="nx">val</span><span class="o">=</span><span class="nx">args</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span><span class="nx">match</span><span class="o">=</span><span class="nx">formatter</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="nx">val</span><span class="p">);</span><span class="nx">args</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="nx">index</span><span class="o">--</span><span class="p">}</span><span class="k">return</span> <span class="nx">match</span><span class="p">});</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="o">===</span><span class="k">typeof</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">formatArgs</span><span class="p">){</span><span class="nx">args</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">formatArgs</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="nx">args</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">logFn</span><span class="o">=</span><span class="nx">enabled</span><span class="p">.</span><span class="nx">log</span><span class="o">||</span><span class="nx">exports</span><span class="p">.</span><span class="nx">log</span><span class="o">||</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">);</span><span class="nx">logFn</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">self</span><span class="p">,</span><span class="nx">args</span><span class="p">)}</span><span class="nx">enabled</span><span class="p">.</span><span class="nx">enabled</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="kd">var</span> <span class="nx">fn</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">enabled</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span><span class="o">?</span><span class="nx">enabled</span><span class="o">:</span><span class="nx">disabled</span><span class="p">;</span><span class="nx">fn</span><span class="p">.</span><span class="nx">namespace</span><span class="o">=</span><span class="nx">namespace</span><span class="p">;</span><span class="k">return</span> <span class="nx">fn</span><span class="p">}</span><span class="kd">function</span> <span class="nx">enable</span><span class="p">(</span><span class="nx">namespaces</span><span class="p">){</span><span class="nx">exports</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="nx">namespaces</span><span class="p">);</span><span class="kd">var</span> <span class="nx">split</span><span class="o">=</span><span class="p">(</span><span class="nx">namespaces</span><span class="o">||</span><span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="sr">/[\s,]+/</span><span class="p">);</span><span class="kd">var</span> <span class="nx">len</span><span class="o">=</span><span class="nx">split</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">split</span><span class="p">[</span><span class="nx">i</span><span class="p">])</span><span class="k">continue</span><span class="p">;</span><span class="nx">namespaces</span><span class="o">=</span><span class="nx">split</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\*/g</span><span class="p">,</span><span class="s2">&quot;.*?&quot;</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">namespaces</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">===</span><span class="s2">&quot;-&quot;</span><span class="p">){</span><span class="nx">exports</span><span class="p">.</span><span class="nx">skips</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="o">+</span><span class="nx">namespaces</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">))}</span><span class="k">else</span><span class="p">{</span><span class="nx">exports</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^&quot;</span><span class="o">+</span><span class="nx">namespaces</span><span class="o">+</span><span class="s2">&quot;$&quot;</span><span class="p">))}}}</span><span class="kd">function</span> <span class="nx">disable</span><span class="p">(){</span><span class="nx">exports</span><span class="p">.</span><span class="nx">enable</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">enabled</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span><span class="kd">var</span> <span class="nx">i</span><span class="p">,</span><span class="nx">len</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">len</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">skips</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">skips</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">)){</span><span class="k">return</span> <span class="kc">false</span><span class="p">}}</span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">len</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">names</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">names</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">test</span><span class="p">(</span><span class="nx">name</span><span class="p">)){</span><span class="k">return</span> <span class="kc">true</span><span class="p">}}</span><span class="k">return</span> <span class="kc">false</span><span class="p">}</span><span class="kd">function</span> <span class="nx">coerce</span><span class="p">(</span><span class="nx">val</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nb">Error</span><span class="p">)</span><span class="k">return</span> <span class="nx">val</span><span class="p">.</span><span class="nx">stack</span><span class="o">||</span><span class="nx">val</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span><span class="k">return</span> <span class="nx">val</span><span class="p">}},{</span><span class="nx">ms</span><span class="o">:</span><span class="mi">23</span><span class="p">}],</span><span class="mi">23</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">s</span><span class="o">=</span><span class="mi">1</span><span class="nx">e3</span><span class="p">;</span><span class="kd">var</span> <span class="nx">m</span><span class="o">=</span><span class="nx">s</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span><span class="kd">var</span> <span class="nx">h</span><span class="o">=</span><span class="nx">m</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span><span class="kd">var</span> <span class="nx">d</span><span class="o">=</span><span class="nx">h</span><span class="o">*</span><span class="mi">24</span><span class="p">;</span><span class="kd">var</span> <span class="nx">y</span><span class="o">=</span><span class="nx">d</span><span class="o">*</span><span class="mf">365.25</span><span class="p">;</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span><span class="nx">options</span><span class="p">){</span><span class="nx">options</span><span class="o">=</span><span class="nx">options</span><span class="o">||</span><span class="p">{};</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">val</span><span class="p">)</span><span class="k">return</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span><span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="kr">long</span><span class="o">?</span><span class="kr">long</span><span class="p">(</span><span class="nx">val</span><span class="p">)</span><span class="o">:</span><span class="kr">short</span><span class="p">(</span><span class="nx">val</span><span class="p">)};</span><span class="kd">function</span> <span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span><span class="kd">var</span> <span class="nx">match</span><span class="o">=</span><span class="sr">/^((?:\d+)?\.?\d+) *(ms|seconds?|s|minutes?|m|hours?|h|days?|d|years?|y)?$/i</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">match</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="kd">var</span> <span class="nx">type</span><span class="o">=</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">||</span><span class="s2">&quot;ms&quot;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span><span class="k">switch</span><span class="p">(</span><span class="nx">type</span><span class="p">){</span><span class="k">case</span><span class="s2">&quot;years&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;year&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;y&quot;</span><span class="o">:</span><span class="k">return</span> <span class="nx">n</span><span class="o">*</span><span class="nx">y</span><span class="p">;</span><span class="k">case</span><span class="s2">&quot;days&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;day&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;d&quot;</span><span class="o">:</span><span class="k">return</span> <span class="nx">n</span><span class="o">*</span><span class="nx">d</span><span class="p">;</span><span class="k">case</span><span class="s2">&quot;hours&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;hour&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;h&quot;</span><span class="o">:</span><span class="k">return</span> <span class="nx">n</span><span class="o">*</span><span class="nx">h</span><span class="p">;</span><span class="k">case</span><span class="s2">&quot;minutes&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;minute&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;m&quot;</span><span class="o">:</span><span class="k">return</span> <span class="nx">n</span><span class="o">*</span><span class="nx">m</span><span class="p">;</span><span class="k">case</span><span class="s2">&quot;seconds&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;second&quot;</span><span class="o">:</span><span class="k">case</span><span class="s2">&quot;s&quot;</span><span class="o">:</span><span class="k">return</span> <span class="nx">n</span><span class="o">*</span><span class="nx">s</span><span class="p">;</span><span class="k">case</span><span class="s2">&quot;ms&quot;</span><span class="o">:</span><span class="k">return</span> <span class="nx">n</span><span class="p">}}</span><span class="kd">function</span> <span class="kr">short</span><span class="p">(</span><span class="nx">ms</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="o">&gt;=</span><span class="nx">d</span><span class="p">)</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ms</span><span class="o">/</span><span class="nx">d</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;d&quot;</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="o">&gt;=</span><span class="nx">h</span><span class="p">)</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ms</span><span class="o">/</span><span class="nx">h</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;h&quot;</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="o">&gt;=</span><span class="nx">m</span><span class="p">)</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ms</span><span class="o">/</span><span class="nx">m</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;m&quot;</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="o">&gt;=</span><span class="nx">s</span><span class="p">)</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">ms</span><span class="o">/</span><span class="nx">s</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;s&quot;</span><span class="p">;</span><span class="k">return</span> <span class="nx">ms</span><span class="o">+</span><span class="s2">&quot;ms&quot;</span><span class="p">}</span><span class="kd">function</span> <span class="kr">long</span><span class="p">(</span><span class="nx">ms</span><span class="p">){</span><span class="k">return</span> <span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span><span class="nx">d</span><span class="p">,</span><span class="s2">&quot;day&quot;</span><span class="p">)</span><span class="o">||</span><span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span><span class="nx">h</span><span class="p">,</span><span class="s2">&quot;hour&quot;</span><span class="p">)</span><span class="o">||</span><span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span><span class="nx">m</span><span class="p">,</span><span class="s2">&quot;minute&quot;</span><span class="p">)</span><span class="o">||</span><span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span><span class="nx">s</span><span class="p">,</span><span class="s2">&quot;second&quot;</span><span class="p">)</span><span class="o">||</span><span class="nx">ms</span><span class="o">+</span><span class="s2">&quot; ms&quot;</span><span class="p">}</span><span class="kd">function</span> <span class="nx">plural</span><span class="p">(</span><span class="nx">ms</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">name</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="o">&lt;</span><span class="nx">n</span><span class="p">)</span><span class="k">return</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">ms</span><span class="o">&lt;</span><span class="nx">n</span><span class="o">*</span><span class="mf">1.5</span><span class="p">)</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">ms</span><span class="o">/</span><span class="nx">n</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">name</span><span class="p">;</span><span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">ms</span><span class="o">/</span><span class="nx">n</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nx">name</span><span class="o">+</span><span class="s2">&quot;s&quot;</span><span class="p">}},{}],</span><span class="mi">24</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">keys</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./keys&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">sliceBuffer</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;arraybuffer.slice&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">base64encoder</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;base64-arraybuffer&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">after</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;after&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">utf8</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">isAndroid</span><span class="o">=</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/Android/i</span><span class="p">);</span><span class="nx">exports</span><span class="p">.</span><span class="nx">protocol</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span><span class="kd">var</span> <span class="nx">packets</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">packets</span><span class="o">=</span><span class="p">{</span><span class="nx">open</span><span class="o">:</span><span class="mi">0</span><span class="p">,</span><span class="nx">close</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">ping</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span><span class="nx">pong</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span><span class="nx">message</span><span class="o">:</span><span class="mi">4</span><span class="p">,</span><span class="nx">upgrade</span><span class="o">:</span><span class="mi">5</span><span class="p">,</span><span class="nx">noop</span><span class="o">:</span><span class="mi">6</span><span class="p">};</span><span class="kd">var</span> <span class="nx">packetslist</span><span class="o">=</span><span class="nx">keys</span><span class="p">(</span><span class="nx">packets</span><span class="p">);</span><span class="kd">var</span> <span class="nx">err</span><span class="o">=</span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="s2">&quot;parser error&quot;</span><span class="p">};</span><span class="kd">var</span> <span class="nx">Blob</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;blob&quot;</span><span class="p">);</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="nx">utf8encode</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">supportsBinary</span><span class="p">){</span><span class="nx">callback</span><span class="o">=</span><span class="nx">supportsBinary</span><span class="p">;</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;function&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">utf8encode</span><span class="p">){</span><span class="nx">callback</span><span class="o">=</span><span class="nx">utf8encode</span><span class="p">;</span><span class="nx">utf8encode</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="kd">var</span> <span class="nx">data</span><span class="o">=</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="o">===</span><span class="kc">undefined</span><span class="o">?</span><span class="kc">undefined</span><span class="o">:</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">buffer</span><span class="o">||</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">ArrayBuffer</span><span class="o">&amp;&amp;</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nx">ArrayBuffer</span><span class="p">){</span><span class="k">return</span> <span class="nx">encodeArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">Blob</span><span class="o">&amp;&amp;</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Blob</span><span class="p">){</span><span class="k">return</span> <span class="nx">encodeBlob</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">encoded</span><span class="o">=</span><span class="nx">packets</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="kc">undefined</span><span class="o">!==</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">){</span><span class="nx">encoded</span><span class="o">+=</span><span class="nx">utf8encode</span><span class="o">?</span><span class="nx">utf8</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nb">String</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span><span class="o">:</span><span class="nb">String</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">)}</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="nx">encoded</span><span class="p">)};</span><span class="kd">function</span> <span class="nx">encodeArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">supportsBinary</span><span class="p">){</span><span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodeBase64Packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">data</span><span class="o">=</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span><span class="kd">var</span> <span class="nx">contentArray</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="kd">var</span> <span class="nx">resultBuffer</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="nx">data</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">);</span><span class="nx">resultBuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nx">packets</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">contentArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">resultBuffer</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="nx">contentArray</span><span class="p">[</span><span class="nx">i</span><span class="p">]}</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">resultBuffer</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">encodeBlobAsArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">supportsBinary</span><span class="p">){</span><span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodeBase64Packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">fr</span><span class="o">=</span><span class="k">new</span> <span class="nx">FileReader</span><span class="p">;</span><span class="nx">fr</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="o">=</span><span class="nx">fr</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="nx">callback</span><span class="p">)};</span><span class="k">return</span> <span class="nx">fr</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">encodeBlob</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">supportsBinary</span><span class="p">){</span><span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodeBase64Packet</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">isAndroid</span><span class="p">){</span><span class="k">return</span> <span class="nx">encodeBlobAsArrayBuffer</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">length</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="nx">length</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="nx">packets</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span><span class="kd">var</span> <span class="nx">blob</span><span class="o">=</span><span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">length</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">]);</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">blob</span><span class="p">)}</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encodeBase64Packet</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">var</span> <span class="nx">message</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="o">+</span><span class="nx">exports</span><span class="p">.</span><span class="nx">packets</span><span class="p">[</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="nx">Blob</span><span class="o">&amp;&amp;</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nx">Blob</span><span class="p">){</span><span class="kd">var</span> <span class="nx">fr</span><span class="o">=</span><span class="k">new</span> <span class="nx">FileReader</span><span class="p">;</span><span class="nx">fr</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">b64</span><span class="o">=</span><span class="nx">fr</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span><span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="o">+</span><span class="nx">b64</span><span class="p">)};</span><span class="k">return</span> <span class="nx">fr</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">b64data</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="nx">b64data</span><span class="o">=</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">))}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="kd">var</span> <span class="nx">typed</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="kd">var</span> <span class="nx">basic</span><span class="o">=</span><span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">typed</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">typed</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">basic</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nx">typed</span><span class="p">[</span><span class="nx">i</span><span class="p">]}</span><span class="nx">b64data</span><span class="o">=</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">basic</span><span class="p">)}</span><span class="nx">message</span><span class="o">+=</span><span class="nx">global</span><span class="p">.</span><span class="nx">btoa</span><span class="p">(</span><span class="nx">b64data</span><span class="p">);</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">message</span><span class="p">)};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">decodePacket</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">binaryType</span><span class="p">,</span><span class="nx">utf8decode</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span><span class="o">==</span><span class="s2">&quot;string&quot;</span><span class="o">||</span><span class="nx">data</span><span class="o">===</span><span class="kc">undefined</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;b&quot;</span><span class="p">){</span><span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">decodeBase64Packet</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="nx">binaryType</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">utf8decode</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">data</span><span class="o">=</span><span class="nx">utf8</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">data</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span> <span class="nx">err</span><span class="p">}}</span><span class="kd">var</span> <span class="nx">type</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nb">Number</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span><span class="o">!=</span><span class="nx">type</span><span class="o">||!</span><span class="nx">packetslist</span><span class="p">[</span><span class="nx">type</span><span class="p">]){</span><span class="k">return</span> <span class="nx">err</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">){</span><span class="k">return</span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="nx">packetslist</span><span class="p">[</span><span class="nx">type</span><span class="p">],</span><span class="nx">data</span><span class="o">:</span><span class="nx">data</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">)}}</span><span class="k">else</span><span class="p">{</span><span class="k">return</span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="nx">packetslist</span><span class="p">[</span><span class="nx">type</span><span class="p">]}}}</span><span class="kd">var</span> <span class="nx">asArray</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="kd">var</span> <span class="nx">type</span><span class="o">=</span><span class="nx">asArray</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="kd">var</span> <span class="nx">rest</span><span class="o">=</span><span class="nx">sliceBuffer</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">Blob</span><span class="o">&amp;&amp;</span><span class="nx">binaryType</span><span class="o">===</span><span class="s2">&quot;blob&quot;</span><span class="p">){</span><span class="nx">rest</span><span class="o">=</span><span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">rest</span><span class="p">])}</span><span class="k">return</span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="nx">packetslist</span><span class="p">[</span><span class="nx">type</span><span class="p">],</span><span class="nx">data</span><span class="o">:</span><span class="nx">rest</span><span class="p">}};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">decodeBase64Packet</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="nx">binaryType</span><span class="p">){</span><span class="kd">var</span> <span class="nx">type</span><span class="o">=</span><span class="nx">packetslist</span><span class="p">[</span><span class="nx">msg</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)];</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">global</span><span class="p">.</span><span class="nx">ArrayBuffer</span><span class="p">){</span><span class="k">return</span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="nx">type</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="p">{</span><span class="nx">base64</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="nx">msg</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">)}}}</span><span class="kd">var</span> <span class="nx">data</span><span class="o">=</span><span class="nx">base64encoder</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span><span class="k">if</span><span class="p">(</span><span class="nx">binaryType</span><span class="o">===</span><span class="s2">&quot;blob&quot;</span><span class="o">&amp;&amp;</span><span class="nx">Blob</span><span class="p">){</span><span class="nx">data</span><span class="o">=</span><span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">data</span><span class="p">])}</span><span class="k">return</span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="nx">type</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="nx">data</span><span class="p">}};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayload</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">supportsBinary</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="p">){</span><span class="nx">callback</span><span class="o">=</span><span class="nx">supportsBinary</span><span class="p">;</span><span class="nx">supportsBinary</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">supportsBinary</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">Blob</span><span class="o">&amp;&amp;!</span><span class="nx">isAndroid</span><span class="p">){</span><span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayloadAsBlob</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayloadAsArrayBuffer</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">packets</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="s2">&quot;0:&quot;</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">setLengthHeader</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span><span class="k">return</span> <span class="nx">message</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">message</span><span class="p">}</span><span class="kd">function</span> <span class="nx">encodeOne</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">doneCallback</span><span class="p">){</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">supportsBinary</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span><span class="nx">doneCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">setLengthHeader</span><span class="p">(</span><span class="nx">message</span><span class="p">))})}</span><span class="nx">map</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span><span class="nx">encodeOne</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">results</span><span class="p">){</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">))})};</span><span class="kd">function</span> <span class="nx">map</span><span class="p">(</span><span class="nx">ary</span><span class="p">,</span><span class="nx">each</span><span class="p">,</span><span class="nx">done</span><span class="p">){</span><span class="kd">var</span> <span class="nx">result</span><span class="o">=</span><span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span><span class="kd">var</span> <span class="nx">next</span><span class="o">=</span><span class="nx">after</span><span class="p">(</span><span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="nx">done</span><span class="p">);</span><span class="kd">var</span> <span class="nx">eachWithIndex</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">el</span><span class="p">,</span><span class="nx">cb</span><span class="p">){</span><span class="nx">each</span><span class="p">(</span><span class="nx">el</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="nx">msg</span><span class="p">){</span><span class="nx">result</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nx">msg</span><span class="p">;</span><span class="nx">cb</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="nx">result</span><span class="p">)})};</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">eachWithIndex</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">next</span><span class="p">)}}</span><span class="nx">exports</span><span class="p">.</span><span class="nx">decodePayload</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">binaryType</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span><span class="o">!=</span><span class="s2">&quot;string&quot;</span><span class="p">){</span><span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">decodePayloadAsBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">binaryType</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">binaryType</span><span class="o">===</span><span class="s2">&quot;function&quot;</span><span class="p">){</span><span class="nx">callback</span><span class="o">=</span><span class="nx">binaryType</span><span class="p">;</span><span class="nx">binaryType</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="kd">var</span> <span class="nx">packet</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="o">==</span><span class="s2">&quot;&quot;</span><span class="p">){</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">length</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">msg</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">l</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">l</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="kd">var</span> <span class="nx">chr</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="o">!=</span><span class="nx">chr</span><span class="p">){</span><span class="nx">length</span><span class="o">+=</span><span class="nx">chr</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">==</span><span class="nx">length</span><span class="o">||</span><span class="nx">length</span><span class="o">!=</span><span class="p">(</span><span class="nx">n</span><span class="o">=</span><span class="nb">Number</span><span class="p">(</span><span class="nx">length</span><span class="p">))){</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span><span class="nx">msg</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nx">n</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">length</span><span class="o">!=</span><span class="nx">msg</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="nx">packet</span><span class="o">=</span><span class="nx">exports</span><span class="p">.</span><span class="nx">decodePacket</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="nx">binaryType</span><span class="p">,</span><span class="kc">true</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nx">type</span><span class="o">==</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="o">&amp;&amp;</span><span class="nx">err</span><span class="p">.</span><span class="nx">data</span><span class="o">==</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">){</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">ret</span><span class="o">=</span><span class="nx">callback</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">i</span><span class="o">+</span><span class="nx">n</span><span class="p">,</span><span class="nx">l</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="kc">false</span><span class="o">===</span><span class="nx">ret</span><span class="p">)</span><span class="k">return</span><span class="p">}</span><span class="nx">i</span><span class="o">+=</span><span class="nx">n</span><span class="p">;</span><span class="nx">length</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">}}</span><span class="k">if</span><span class="p">(</span><span class="nx">length</span><span class="o">!=</span><span class="s2">&quot;&quot;</span><span class="p">){</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)}};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayloadAsArrayBuffer</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">packets</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">0</span><span class="p">))}</span><span class="kd">function</span> <span class="nx">encodeOne</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">doneCallback</span><span class="p">){</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="k">return</span> <span class="nx">doneCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">data</span><span class="p">)})}</span><span class="nx">map</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span><span class="nx">encodeOne</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">encodedPackets</span><span class="p">){</span><span class="kd">var</span> <span class="nx">totalLength</span><span class="o">=</span><span class="nx">encodedPackets</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">acc</span><span class="p">,</span><span class="nx">p</span><span class="p">){</span><span class="kd">var</span> <span class="nx">len</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">p</span><span class="o">===</span><span class="s2">&quot;string&quot;</span><span class="p">){</span><span class="nx">len</span><span class="o">=</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">len</span><span class="o">=</span><span class="nx">p</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">}</span><span class="k">return</span> <span class="nx">acc</span><span class="o">+</span><span class="nx">len</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span><span class="o">+</span><span class="nx">len</span><span class="o">+</span><span class="mi">2</span><span class="p">},</span><span class="mi">0</span><span class="p">);</span><span class="kd">var</span> <span class="nx">resultArray</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">totalLength</span><span class="p">);</span><span class="kd">var</span> <span class="nx">bufferIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">encodedPackets</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">p</span><span class="p">){</span><span class="kd">var</span> <span class="nx">isString</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">p</span><span class="o">===</span><span class="s2">&quot;string&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">ab</span><span class="o">=</span><span class="nx">p</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">isString</span><span class="p">){</span><span class="kd">var</span> <span class="nx">view</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">p</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">view</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nx">p</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)}</span><span class="nx">ab</span><span class="o">=</span><span class="nx">view</span><span class="p">.</span><span class="nx">buffer</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">isString</span><span class="p">){</span><span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="kd">var</span> <span class="nx">lenStr</span><span class="o">=</span><span class="nx">ab</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">lenStr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">lenStr</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span><span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="mi">255</span><span class="p">;</span><span class="kd">var</span> <span class="nx">view</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">ab</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">view</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">resultArray</span><span class="p">[</span><span class="nx">bufferIndex</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="nx">view</span><span class="p">[</span><span class="nx">i</span><span class="p">]}});</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">resultArray</span><span class="p">.</span><span class="nx">buffer</span><span class="p">)})};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePayloadAsBlob</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">function</span> <span class="nx">encodeOne</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">doneCallback</span><span class="p">){</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encodePacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">encoded</span><span class="p">){</span><span class="kd">var</span> <span class="nx">binaryIdentifier</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="nx">binaryIdentifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">encoded</span><span class="o">===</span><span class="s2">&quot;string&quot;</span><span class="p">){</span><span class="kd">var</span> <span class="nx">view</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">encoded</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">encoded</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">view</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nx">encoded</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)}</span><span class="nx">encoded</span><span class="o">=</span><span class="nx">view</span><span class="p">.</span><span class="nx">buffer</span><span class="p">;</span><span class="nx">binaryIdentifier</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">}</span><span class="kd">var</span> <span class="nx">len</span><span class="o">=</span><span class="nx">encoded</span> <span class="k">instanceof</span> <span class="nx">ArrayBuffer</span><span class="o">?</span><span class="nx">encoded</span><span class="p">.</span><span class="nx">byteLength</span><span class="o">:</span><span class="nx">encoded</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span><span class="kd">var</span> <span class="nx">lenStr</span><span class="o">=</span><span class="nx">len</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span><span class="kd">var</span> <span class="nx">lengthAry</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">lenStr</span><span class="p">.</span><span class="nx">length</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">lenStr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">lengthAry</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">lenStr</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span><span class="nx">lengthAry</span><span class="p">[</span><span class="nx">lenStr</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span><span class="o">=</span><span class="mi">255</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">Blob</span><span class="p">){</span><span class="kd">var</span> <span class="nx">blob</span><span class="o">=</span><span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="nx">binaryIdentifier</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span><span class="nx">lengthAry</span><span class="p">.</span><span class="nx">buffer</span><span class="p">,</span><span class="nx">encoded</span><span class="p">]);</span><span class="nx">doneCallback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">blob</span><span class="p">)}})}</span><span class="nx">map</span><span class="p">(</span><span class="nx">packets</span><span class="p">,</span><span class="nx">encodeOne</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">results</span><span class="p">){</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="k">new</span> <span class="nx">Blob</span><span class="p">(</span><span class="nx">results</span><span class="p">))})};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">decodePayloadAsBinary</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">binaryType</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">binaryType</span><span class="o">===</span><span class="s2">&quot;function&quot;</span><span class="p">){</span><span class="nx">callback</span><span class="o">=</span><span class="nx">binaryType</span><span class="p">;</span><span class="nx">binaryType</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="kd">var</span> <span class="nx">bufferTail</span><span class="o">=</span><span class="nx">data</span><span class="p">;</span><span class="kd">var</span> <span class="nx">buffers</span><span class="o">=</span><span class="p">[];</span><span class="kd">var</span> <span class="nx">numberTooLong</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="nx">bufferTail</span><span class="p">.</span><span class="nx">byteLength</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span><span class="kd">var</span> <span class="nx">tailArray</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">bufferTail</span><span class="p">);</span><span class="kd">var</span> <span class="nx">isString</span><span class="o">=</span><span class="nx">tailArray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">===</span><span class="mi">0</span><span class="p">;</span><span class="kd">var</span> <span class="nx">msgLength</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">tailArray</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">==</span><span class="mi">255</span><span class="p">)</span><span class="k">break</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">msgLength</span><span class="p">.</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">310</span><span class="p">){</span><span class="nx">numberTooLong</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="k">break</span><span class="p">}</span><span class="nx">msgLength</span><span class="o">+=</span><span class="nx">tailArray</span><span class="p">[</span><span class="nx">i</span><span class="p">]}</span><span class="k">if</span><span class="p">(</span><span class="nx">numberTooLong</span><span class="p">)</span><span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="nx">bufferTail</span><span class="o">=</span><span class="nx">sliceBuffer</span><span class="p">(</span><span class="nx">bufferTail</span><span class="p">,</span><span class="mi">2</span><span class="o">+</span><span class="nx">msgLength</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span><span class="nx">msgLength</span><span class="o">=</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">msgLength</span><span class="p">);</span><span class="kd">var</span> <span class="nx">msg</span><span class="o">=</span><span class="nx">sliceBuffer</span><span class="p">(</span><span class="nx">bufferTail</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="nx">msgLength</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">isString</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">msg</span><span class="o">=</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">msg</span><span class="p">))}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="kd">var</span> <span class="nx">typed</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span><span class="nx">msg</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">typed</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">msg</span><span class="o">+=</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">typed</span><span class="p">[</span><span class="nx">i</span><span class="p">])}}}</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span><span class="nx">bufferTail</span><span class="o">=</span><span class="nx">sliceBuffer</span><span class="p">(</span><span class="nx">bufferTail</span><span class="p">,</span><span class="nx">msgLength</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">total</span><span class="o">=</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span><span class="nx">i</span><span class="p">){</span><span class="nx">callback</span><span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">decodePacket</span><span class="p">(</span><span class="nx">buffer</span><span class="p">,</span><span class="nx">binaryType</span><span class="p">,</span><span class="kc">true</span><span class="p">),</span><span class="nx">i</span><span class="p">,</span><span class="nx">total</span><span class="p">)})}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{</span><span class="s2">&quot;./keys&quot;</span><span class="o">:</span><span class="mi">25</span><span class="p">,</span><span class="nx">after</span><span class="o">:</span><span class="mi">26</span><span class="p">,</span><span class="s2">&quot;arraybuffer.slice&quot;</span><span class="o">:</span><span class="mi">27</span><span class="p">,</span><span class="s2">&quot;base64-arraybuffer&quot;</span><span class="o">:</span><span class="mi">28</span><span class="p">,</span><span class="nx">blob</span><span class="o">:</span><span class="mi">29</span><span class="p">,</span><span class="nx">utf8</span><span class="o">:</span><span class="mi">30</span><span class="p">}],</span><span class="mi">25</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="o">||</span><span class="kd">function</span> <span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="kd">var</span> <span class="nx">arr</span><span class="o">=</span><span class="p">[];</span><span class="kd">var</span> <span class="nx">has</span><span class="o">=</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">i</span><span class="p">)){</span><span class="nx">arr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span><span class="p">)}}</span><span class="k">return</span> <span class="nx">arr</span><span class="p">}},{}],</span><span class="mi">26</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">after</span><span class="p">;</span><span class="kd">function</span> <span class="nx">after</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span><span class="nx">callback</span><span class="p">,</span><span class="nx">err_cb</span><span class="p">){</span><span class="kd">var</span> <span class="nx">bail</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="nx">err_cb</span><span class="o">=</span><span class="nx">err_cb</span><span class="o">||</span><span class="nx">noop</span><span class="p">;</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">count</span><span class="o">=</span><span class="nx">count</span><span class="p">;</span><span class="k">return</span> <span class="nx">count</span><span class="o">===</span><span class="mi">0</span><span class="o">?</span><span class="nx">callback</span><span class="p">()</span><span class="o">:</span><span class="nx">proxy</span><span class="p">;</span><span class="kd">function</span> <span class="nx">proxy</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">result</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">count</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">){</span><span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;after called too many times&quot;</span><span class="p">)}</span><span class="o">--</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">count</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">bail</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">callback</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span><span class="nx">callback</span><span class="o">=</span><span class="nx">err_cb</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">proxy</span><span class="p">.</span><span class="nx">count</span><span class="o">===</span><span class="mi">0</span><span class="o">&amp;&amp;!</span><span class="nx">bail</span><span class="p">){</span><span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">result</span><span class="p">)}}}</span><span class="kd">function</span> <span class="nx">noop</span><span class="p">(){}},{}],</span><span class="mi">27</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">,</span><span class="nx">start</span><span class="p">,</span><span class="nx">end</span><span class="p">){</span><span class="kd">var</span> <span class="nx">bytes</span><span class="o">=</span><span class="nx">arraybuffer</span><span class="p">.</span><span class="nx">byteLength</span><span class="p">;</span><span class="nx">start</span><span class="o">=</span><span class="nx">start</span><span class="o">||</span><span class="mi">0</span><span class="p">;</span><span class="nx">end</span><span class="o">=</span><span class="nx">end</span><span class="o">||</span><span class="nx">bytes</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">){</span><span class="k">return</span> <span class="nx">arraybuffer</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">start</span><span class="p">,</span><span class="nx">end</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">start</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span><span class="nx">start</span><span class="o">+=</span><span class="nx">bytes</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">end</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">){</span><span class="nx">end</span><span class="o">+=</span><span class="nx">bytes</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">end</span><span class="o">&gt;</span><span class="nx">bytes</span><span class="p">){</span><span class="nx">end</span><span class="o">=</span><span class="nx">bytes</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">start</span><span class="o">&gt;=</span><span class="nx">bytes</span><span class="o">||</span><span class="nx">start</span><span class="o">&gt;=</span><span class="nx">end</span><span class="o">||</span><span class="nx">bytes</span><span class="o">===</span><span class="mi">0</span><span class="p">){</span><span class="k">return</span> <span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="mi">0</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">abv</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">);</span><span class="kd">var</span> <span class="nx">result</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">end</span><span class="o">-</span><span class="nx">start</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="nx">start</span><span class="p">,</span><span class="nx">ii</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">end</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">,</span><span class="nx">ii</span><span class="o">++</span><span class="p">){</span><span class="nx">result</span><span class="p">[</span><span class="nx">ii</span><span class="p">]</span><span class="o">=</span><span class="nx">abv</span><span class="p">[</span><span class="nx">i</span><span class="p">]}</span><span class="k">return</span> <span class="nx">result</span><span class="p">.</span><span class="nx">buffer</span><span class="p">}},{}],</span><span class="mi">28</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">chars</span><span class="p">){</span><span class="s2">&quot;use strict&quot;</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encode</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">){</span><span class="kd">var</span> <span class="nx">bytes</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">),</span><span class="nx">i</span><span class="p">,</span><span class="nx">len</span><span class="o">=</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="nx">base64</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">+=</span><span class="mi">3</span><span class="p">){</span><span class="nx">base64</span><span class="o">+=</span><span class="nx">chars</span><span class="p">[</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">];</span><span class="nx">base64</span><span class="o">+=</span><span class="nx">chars</span><span class="p">[(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="o">|</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">];</span><span class="nx">base64</span><span class="o">+=</span><span class="nx">chars</span><span class="p">[(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="o">|</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="p">];</span><span class="nx">base64</span><span class="o">+=</span><span class="nx">chars</span><span class="p">[</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">]}</span><span class="k">if</span><span class="p">(</span><span class="nx">len</span><span class="o">%</span><span class="mi">3</span><span class="o">===</span><span class="mi">2</span><span class="p">){</span><span class="nx">base64</span><span class="o">=</span><span class="nx">base64</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">base64</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">len</span><span class="o">%</span><span class="mi">3</span><span class="o">===</span><span class="mi">1</span><span class="p">){</span><span class="nx">base64</span><span class="o">=</span><span class="nx">base64</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">base64</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;==&quot;</span><span class="p">}</span><span class="k">return</span> <span class="nx">base64</span><span class="p">};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">decode</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">base64</span><span class="p">){</span><span class="kd">var</span> <span class="nx">bufferLength</span><span class="o">=</span><span class="nx">base64</span><span class="p">.</span><span class="nx">length</span><span class="o">*</span><span class="p">.</span><span class="mi">75</span><span class="p">,</span><span class="nx">len</span><span class="o">=</span><span class="nx">base64</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="nx">i</span><span class="p">,</span><span class="nx">p</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">encoded1</span><span class="p">,</span><span class="nx">encoded2</span><span class="p">,</span><span class="nx">encoded3</span><span class="p">,</span><span class="nx">encoded4</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">base64</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">===</span><span class="s2">&quot;=&quot;</span><span class="p">){</span><span class="nx">bufferLength</span><span class="o">--</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">base64</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">===</span><span class="s2">&quot;=&quot;</span><span class="p">){</span><span class="nx">bufferLength</span><span class="o">--</span><span class="p">}}</span><span class="kd">var</span> <span class="nx">arraybuffer</span><span class="o">=</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">bufferLength</span><span class="p">),</span><span class="nx">bytes</span><span class="o">=</span><span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="nx">arraybuffer</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span><span class="nx">i</span><span class="o">+=</span><span class="mi">4</span><span class="p">){</span><span class="nx">encoded1</span><span class="o">=</span><span class="nx">chars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span><span class="nx">encoded2</span><span class="o">=</span><span class="nx">chars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span><span class="nx">encoded3</span><span class="o">=</span><span class="nx">chars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]);</span><span class="nx">encoded4</span><span class="o">=</span><span class="nx">chars</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">base64</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]);</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="nx">encoded1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="o">|</span><span class="nx">encoded2</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">;</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="nx">encoded2</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="o">|</span><span class="nx">encoded3</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">;</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">p</span><span class="o">++</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="nx">encoded3</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="o">|</span><span class="nx">encoded4</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">}</span><span class="k">return</span> <span class="nx">arraybuffer</span><span class="p">}})(</span><span class="s2">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot;</span><span class="p">)},{}],</span><span class="mi">29</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">BlobBuilder</span><span class="o">=</span><span class="nx">global</span><span class="p">.</span><span class="nx">BlobBuilder</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">WebKitBlobBuilder</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">MSBlobBuilder</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">MozBlobBuilder</span><span class="p">;</span><span class="kd">var</span> <span class="nx">blobSupported</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">try</span><span class="p">{</span><span class="kd">var</span> <span class="nx">b</span><span class="o">=</span><span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span><span class="s2">&quot;hi&quot;</span><span class="p">]);</span><span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">size</span><span class="o">==</span><span class="mi">2</span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span> <span class="kc">false</span><span class="p">}}();</span><span class="kd">var</span> <span class="nx">blobBuilderSupported</span><span class="o">=</span><span class="nx">BlobBuilder</span><span class="o">&amp;&amp;</span><span class="nx">BlobBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">append</span><span class="o">&amp;&amp;</span><span class="nx">BlobBuilder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">;</span><span class="kd">function</span> <span class="nx">BlobBuilderConstructor</span><span class="p">(</span><span class="nx">ary</span><span class="p">,</span><span class="nx">options</span><span class="p">){</span><span class="nx">options</span><span class="o">=</span><span class="nx">options</span><span class="o">||</span><span class="p">{};</span><span class="kd">var</span> <span class="nx">bb</span><span class="o">=</span><span class="k">new</span> <span class="nx">BlobBuilder</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">ary</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">bb</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">ary</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span><span class="k">return</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="o">?</span><span class="nx">bb</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="o">:</span><span class="nx">bb</span><span class="p">.</span><span class="nx">getBlob</span><span class="p">()}</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">blobSupported</span><span class="p">){</span><span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Blob</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">blobBuilderSupported</span><span class="p">){</span><span class="k">return</span> <span class="nx">BlobBuilderConstructor</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="k">return</span> <span class="kc">undefined</span><span class="p">}}()}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{}],</span><span class="mi">30</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">root</span><span class="p">){</span><span class="kd">var</span> <span class="nx">freeExports</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">exports</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">&amp;&amp;</span><span class="nx">exports</span><span class="p">;</span><span class="kd">var</span> <span class="nx">freeModule</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">module</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">&amp;&amp;</span><span class="nx">module</span><span class="o">&amp;&amp;</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">==</span><span class="nx">freeExports</span><span class="o">&amp;&amp;</span><span class="nx">module</span><span class="p">;</span><span class="kd">var</span> <span class="nx">freeGlobal</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">global</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">&amp;&amp;</span><span class="nx">global</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">freeGlobal</span><span class="p">.</span><span class="nx">global</span><span class="o">===</span><span class="nx">freeGlobal</span><span class="o">||</span><span class="nx">freeGlobal</span><span class="p">.</span><span class="nb">window</span><span class="o">===</span><span class="nx">freeGlobal</span><span class="p">){</span><span class="nx">root</span><span class="o">=</span><span class="nx">freeGlobal</span><span class="p">}</span><span class="kd">var</span> <span class="nx">stringFromCharCode</span><span class="o">=</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">;</span><span class="kd">function</span> <span class="nx">ucs2decode</span><span class="p">(</span><span class="nx">string</span><span class="p">){</span><span class="kd">var</span> <span class="nx">output</span><span class="o">=</span><span class="p">[];</span><span class="kd">var</span> <span class="nx">counter</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="kd">var</span> <span class="nx">length</span><span class="o">=</span><span class="nx">string</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="kd">var</span> <span class="nx">value</span><span class="p">;</span><span class="kd">var</span> <span class="nx">extra</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="nx">counter</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">){</span><span class="nx">value</span><span class="o">=</span><span class="nx">string</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">counter</span><span class="o">++</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">&gt;=</span><span class="mi">55296</span><span class="o">&amp;&amp;</span><span class="nx">value</span><span class="o">&lt;=</span><span class="mi">56319</span><span class="o">&amp;&amp;</span><span class="nx">counter</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">){</span><span class="nx">extra</span><span class="o">=</span><span class="nx">string</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">counter</span><span class="o">++</span><span class="p">);</span><span class="k">if</span><span class="p">((</span><span class="nx">extra</span><span class="o">&amp;</span><span class="mi">64512</span><span class="p">)</span><span class="o">==</span><span class="mi">56320</span><span class="p">){</span><span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(((</span><span class="nx">value</span><span class="o">&amp;</span><span class="mi">1023</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="nx">extra</span><span class="o">&amp;</span><span class="mi">1023</span><span class="p">)</span><span class="o">+</span><span class="mi">65536</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span><span class="nx">counter</span><span class="o">--</span><span class="p">}}</span><span class="k">else</span><span class="p">{</span><span class="nx">output</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">)}}</span><span class="k">return</span> <span class="nx">output</span><span class="p">}</span><span class="kd">function</span> <span class="nx">ucs2encode</span><span class="p">(</span><span class="nx">array</span><span class="p">){</span><span class="kd">var</span> <span class="nx">length</span><span class="o">=</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="kd">var</span> <span class="nx">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span><span class="kd">var</span> <span class="nx">value</span><span class="p">;</span><span class="kd">var</span> <span class="nx">output</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="o">++</span><span class="nx">index</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">){</span><span class="nx">value</span><span class="o">=</span><span class="nx">array</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">&gt;</span><span class="mi">65535</span><span class="p">){</span><span class="nx">value</span><span class="o">-=</span><span class="mi">65536</span><span class="p">;</span><span class="nx">output</span><span class="o">+=</span><span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">value</span><span class="o">&gt;&gt;&gt;</span><span class="mi">10</span><span class="o">&amp;</span><span class="mi">1023</span><span class="o">|</span><span class="mi">55296</span><span class="p">);</span><span class="nx">value</span><span class="o">=</span><span class="mi">56320</span><span class="o">|</span><span class="nx">value</span><span class="o">&amp;</span><span class="mi">1023</span><span class="p">}</span><span class="nx">output</span><span class="o">+=</span><span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">value</span><span class="p">)}</span><span class="k">return</span> <span class="nx">output</span><span class="p">}</span><span class="kd">function</span> <span class="nx">createByte</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">,</span><span class="nx">shift</span><span class="p">){</span><span class="k">return</span> <span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">codePoint</span><span class="o">&gt;&gt;</span><span class="nx">shift</span><span class="o">&amp;</span><span class="mi">63</span><span class="o">|</span><span class="mi">128</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">encodeCodePoint</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">){</span><span class="k">if</span><span class="p">((</span><span class="nx">codePoint</span><span class="o">&amp;</span><span class="mi">4294967168</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span><span class="k">return</span> <span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">symbol</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">if</span><span class="p">((</span><span class="nx">codePoint</span><span class="o">&amp;</span><span class="mi">4294965248</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span><span class="nx">symbol</span><span class="o">=</span><span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">codePoint</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="o">&amp;</span><span class="mi">31</span><span class="o">|</span><span class="mi">192</span><span class="p">)}</span><span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="nx">codePoint</span><span class="o">&amp;</span><span class="mi">4294901760</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span><span class="nx">symbol</span><span class="o">=</span><span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">codePoint</span><span class="o">&gt;&gt;</span><span class="mi">12</span><span class="o">&amp;</span><span class="mi">15</span><span class="o">|</span><span class="mi">224</span><span class="p">);</span><span class="nx">symbol</span><span class="o">+=</span><span class="nx">createByte</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">,</span><span class="mi">6</span><span class="p">)}</span><span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="nx">codePoint</span><span class="o">&amp;</span><span class="mi">4292870144</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span><span class="nx">symbol</span><span class="o">=</span><span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">codePoint</span><span class="o">&gt;&gt;</span><span class="mi">18</span><span class="o">&amp;</span><span class="mi">7</span><span class="o">|</span><span class="mi">240</span><span class="p">);</span><span class="nx">symbol</span><span class="o">+=</span><span class="nx">createByte</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">,</span><span class="mi">12</span><span class="p">);</span><span class="nx">symbol</span><span class="o">+=</span><span class="nx">createByte</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">,</span><span class="mi">6</span><span class="p">)}</span><span class="nx">symbol</span><span class="o">+=</span><span class="nx">stringFromCharCode</span><span class="p">(</span><span class="nx">codePoint</span><span class="o">&amp;</span><span class="mi">63</span><span class="o">|</span><span class="mi">128</span><span class="p">);</span><span class="k">return</span> <span class="nx">symbol</span><span class="p">}</span><span class="kd">function</span> <span class="nx">utf8encode</span><span class="p">(</span><span class="nx">string</span><span class="p">){</span><span class="kd">var</span> <span class="nx">codePoints</span><span class="o">=</span><span class="nx">ucs2decode</span><span class="p">(</span><span class="nx">string</span><span class="p">);</span><span class="kd">var</span> <span class="nx">length</span><span class="o">=</span><span class="nx">codePoints</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="kd">var</span> <span class="nx">index</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span><span class="kd">var</span> <span class="nx">codePoint</span><span class="p">;</span><span class="kd">var</span> <span class="nx">byteString</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="o">++</span><span class="nx">index</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">){</span><span class="nx">codePoint</span><span class="o">=</span><span class="nx">codePoints</span><span class="p">[</span><span class="nx">index</span><span class="p">];</span><span class="nx">byteString</span><span class="o">+=</span><span class="nx">encodeCodePoint</span><span class="p">(</span><span class="nx">codePoint</span><span class="p">)}</span><span class="k">return</span> <span class="nx">byteString</span><span class="p">}</span><span class="kd">function</span> <span class="nx">readContinuationByte</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">byteIndex</span><span class="o">&gt;=</span><span class="nx">byteCount</span><span class="p">){</span><span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid byte index&quot;</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">continuationByte</span><span class="o">=</span><span class="nx">byteArray</span><span class="p">[</span><span class="nx">byteIndex</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">255</span><span class="p">;</span><span class="nx">byteIndex</span><span class="o">++</span><span class="p">;</span><span class="k">if</span><span class="p">((</span><span class="nx">continuationByte</span><span class="o">&amp;</span><span class="mi">192</span><span class="p">)</span><span class="o">==</span><span class="mi">128</span><span class="p">){</span><span class="k">return</span> <span class="nx">continuationByte</span><span class="o">&amp;</span><span class="mi">63</span><span class="p">}</span><span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid continuation byte&quot;</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">decodeSymbol</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">byte1</span><span class="p">;</span><span class="kd">var</span> <span class="nx">byte2</span><span class="p">;</span><span class="kd">var</span> <span class="nx">byte3</span><span class="p">;</span><span class="kd">var</span> <span class="nx">byte4</span><span class="p">;</span><span class="kd">var</span> <span class="nx">codePoint</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">byteIndex</span><span class="o">&gt;</span><span class="nx">byteCount</span><span class="p">){</span><span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid byte index&quot;</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">byteIndex</span><span class="o">==</span><span class="nx">byteCount</span><span class="p">){</span><span class="k">return</span> <span class="kc">false</span><span class="p">}</span><span class="nx">byte1</span><span class="o">=</span><span class="nx">byteArray</span><span class="p">[</span><span class="nx">byteIndex</span><span class="p">]</span><span class="o">&amp;</span><span class="mi">255</span><span class="p">;</span><span class="nx">byteIndex</span><span class="o">++</span><span class="p">;</span><span class="k">if</span><span class="p">((</span><span class="nx">byte1</span><span class="o">&amp;</span><span class="mi">128</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span><span class="k">return</span> <span class="nx">byte1</span><span class="p">}</span><span class="k">if</span><span class="p">((</span><span class="nx">byte1</span><span class="o">&amp;</span><span class="mi">224</span><span class="p">)</span><span class="o">==</span><span class="mi">192</span><span class="p">){</span><span class="kd">var</span> <span class="nx">byte2</span><span class="o">=</span><span class="nx">readContinuationByte</span><span class="p">();</span><span class="nx">codePoint</span><span class="o">=</span><span class="p">(</span><span class="nx">byte1</span><span class="o">&amp;</span><span class="mi">31</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="o">|</span><span class="nx">byte2</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">codePoint</span><span class="o">&gt;=</span><span class="mi">128</span><span class="p">){</span><span class="k">return</span> <span class="nx">codePoint</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid continuation byte&quot;</span><span class="p">)}}</span><span class="k">if</span><span class="p">((</span><span class="nx">byte1</span><span class="o">&amp;</span><span class="mi">240</span><span class="p">)</span><span class="o">==</span><span class="mi">224</span><span class="p">){</span><span class="nx">byte2</span><span class="o">=</span><span class="nx">readContinuationByte</span><span class="p">();</span><span class="nx">byte3</span><span class="o">=</span><span class="nx">readContinuationByte</span><span class="p">();</span><span class="nx">codePoint</span><span class="o">=</span><span class="p">(</span><span class="nx">byte1</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="nx">byte2</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="o">|</span><span class="nx">byte3</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">codePoint</span><span class="o">&gt;=</span><span class="mi">2048</span><span class="p">){</span><span class="k">return</span> <span class="nx">codePoint</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid continuation byte&quot;</span><span class="p">)}}</span><span class="k">if</span><span class="p">((</span><span class="nx">byte1</span><span class="o">&amp;</span><span class="mi">248</span><span class="p">)</span><span class="o">==</span><span class="mi">240</span><span class="p">){</span><span class="nx">byte2</span><span class="o">=</span><span class="nx">readContinuationByte</span><span class="p">();</span><span class="nx">byte3</span><span class="o">=</span><span class="nx">readContinuationByte</span><span class="p">();</span><span class="nx">byte4</span><span class="o">=</span><span class="nx">readContinuationByte</span><span class="p">();</span><span class="nx">codePoint</span><span class="o">=</span><span class="p">(</span><span class="nx">byte1</span><span class="o">&amp;</span><span class="mi">15</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">18</span><span class="o">|</span><span class="nx">byte2</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="o">|</span><span class="nx">byte3</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="o">|</span><span class="nx">byte4</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">codePoint</span><span class="o">&gt;=</span><span class="mi">65536</span><span class="o">&amp;&amp;</span><span class="nx">codePoint</span><span class="o">&lt;=</span><span class="mi">1114111</span><span class="p">){</span><span class="k">return</span> <span class="nx">codePoint</span><span class="p">}}</span><span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Invalid UTF-8 detected&quot;</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">byteArray</span><span class="p">;</span><span class="kd">var</span> <span class="nx">byteCount</span><span class="p">;</span><span class="kd">var</span> <span class="nx">byteIndex</span><span class="p">;</span><span class="kd">function</span> <span class="nx">utf8decode</span><span class="p">(</span><span class="nx">byteString</span><span class="p">){</span><span class="nx">byteArray</span><span class="o">=</span><span class="nx">ucs2decode</span><span class="p">(</span><span class="nx">byteString</span><span class="p">);</span><span class="nx">byteCount</span><span class="o">=</span><span class="nx">byteArray</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">byteIndex</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="kd">var</span> <span class="nx">codePoints</span><span class="o">=</span><span class="p">[];</span><span class="kd">var</span> <span class="nx">tmp</span><span class="p">;</span><span class="k">while</span><span class="p">((</span><span class="nx">tmp</span><span class="o">=</span><span class="nx">decodeSymbol</span><span class="p">())</span><span class="o">!==</span><span class="kc">false</span><span class="p">){</span><span class="nx">codePoints</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">tmp</span><span class="p">)}</span><span class="k">return</span> <span class="nx">ucs2encode</span><span class="p">(</span><span class="nx">codePoints</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">utf8</span><span class="o">=</span><span class="p">{</span><span class="nx">version</span><span class="o">:</span><span class="s2">&quot;2.0.0&quot;</span><span class="p">,</span><span class="nx">encode</span><span class="o">:</span><span class="nx">utf8encode</span><span class="p">,</span><span class="nx">decode</span><span class="o">:</span><span class="nx">utf8decode</span><span class="p">};</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">define</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="o">&amp;&amp;</span><span class="k">typeof</span> <span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">&amp;&amp;</span><span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">){</span><span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">utf8</span><span class="p">})}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">freeExports</span><span class="o">&amp;&amp;!</span><span class="nx">freeExports</span><span class="p">.</span><span class="nx">nodeType</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">freeModule</span><span class="p">){</span><span class="nx">freeModule</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">utf8</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="kd">var</span> <span class="nx">object</span><span class="o">=</span><span class="p">{};</span><span class="kd">var</span> <span class="nx">hasOwnProperty</span><span class="o">=</span><span class="nx">object</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">utf8</span><span class="p">){</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">utf8</span><span class="p">,</span><span class="nx">key</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">freeExports</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">=</span><span class="nx">utf8</span><span class="p">[</span><span class="nx">key</span><span class="p">])}}}</span><span class="k">else</span><span class="p">{</span><span class="nx">root</span><span class="p">.</span><span class="nx">utf8</span><span class="o">=</span><span class="nx">utf8</span><span class="p">}})(</span><span class="k">this</span><span class="p">)}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{}],</span><span class="mi">31</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">rvalidchars</span><span class="o">=</span><span class="sr">/^[\],:{}\s]*$/</span><span class="p">;</span><span class="kd">var</span> <span class="nx">rvalidescape</span><span class="o">=</span><span class="sr">/\\(?:[&quot;\\\/bfnrt]|u[0-9a-fA-F]{4})/g</span><span class="p">;</span><span class="kd">var</span> <span class="nx">rvalidtokens</span><span class="o">=</span><span class="sr">/&quot;[^&quot;\\\n\r]*&quot;|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g</span><span class="p">;</span><span class="kd">var</span> <span class="nx">rvalidbraces</span><span class="o">=</span><span class="sr">/(?:^|:|,)(?:\s*\[)+/g</span><span class="p">;</span><span class="kd">var</span> <span class="nx">rtrimLeft</span><span class="o">=</span><span class="sr">/^\s+/</span><span class="p">;</span><span class="kd">var</span> <span class="nx">rtrimRight</span><span class="o">=</span><span class="sr">/\s+$/</span><span class="p">;</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span> <span class="nx">parsejson</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="o">!=</span><span class="k">typeof</span> <span class="nx">data</span><span class="o">||!</span><span class="nx">data</span><span class="p">){</span><span class="k">return</span> <span class="kc">null</span><span class="p">}</span><span class="nx">data</span><span class="o">=</span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rtrimLeft</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rtrimRight</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">JSON</span><span class="o">&amp;&amp;</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">){</span><span class="k">return</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">rvalidchars</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rvalidescape</span><span class="p">,</span><span class="s2">&quot;@&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rvalidtokens</span><span class="p">,</span><span class="s2">&quot;]&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="nx">rvalidbraces</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">))){</span><span class="k">return</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span><span class="s2">&quot;return &quot;</span><span class="o">+</span><span class="nx">data</span><span class="p">)()}}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{}],</span><span class="mi">32</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">exports</span><span class="p">.</span><span class="nx">encode</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="kd">var</span> <span class="nx">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">i</span><span class="p">)){</span><span class="k">if</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="nx">str</span><span class="o">+=</span><span class="s2">&quot;&amp;&quot;</span><span class="p">;</span><span class="nx">str</span><span class="o">+=</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;=&quot;</span><span class="o">+</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">])}}</span><span class="k">return</span> <span class="nx">str</span><span class="p">};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">decode</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">qs</span><span class="p">){</span><span class="kd">var</span> <span class="nx">qry</span><span class="o">=</span><span class="p">{};</span><span class="kd">var</span> <span class="nx">pairs</span><span class="o">=</span><span class="nx">qs</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&amp;&quot;</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">l</span><span class="o">=</span><span class="nx">pairs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">l</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="kd">var</span> <span class="nx">pair</span><span class="o">=</span><span class="nx">pairs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">);</span><span class="nx">qry</span><span class="p">[</span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">=</span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])}</span><span class="k">return</span> <span class="nx">qry</span><span class="p">}},{}],</span><span class="mi">33</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">re</span><span class="o">=</span><span class="sr">/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">parts</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span><span class="s2">&quot;protocol&quot;</span><span class="p">,</span><span class="s2">&quot;authority&quot;</span><span class="p">,</span><span class="s2">&quot;userInfo&quot;</span><span class="p">,</span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="s2">&quot;password&quot;</span><span class="p">,</span><span class="s2">&quot;host&quot;</span><span class="p">,</span><span class="s2">&quot;port&quot;</span><span class="p">,</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="p">,</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span><span class="s2">&quot;file&quot;</span><span class="p">,</span><span class="s2">&quot;query&quot;</span><span class="p">,</span><span class="s2">&quot;anchor&quot;</span><span class="p">];</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span> <span class="nx">parseuri</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span><span class="kd">var</span> <span class="nx">src</span><span class="o">=</span><span class="nx">str</span><span class="p">,</span><span class="nx">b</span><span class="o">=</span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">),</span><span class="nx">e</span><span class="o">=</span><span class="nx">str</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="o">!=-</span><span class="mi">1</span><span class="o">&amp;&amp;</span><span class="nx">e</span><span class="o">!=-</span><span class="mi">1</span><span class="p">){</span><span class="nx">str</span><span class="o">=</span><span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">b</span><span class="p">)</span><span class="o">+</span><span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="nx">e</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/:/g</span><span class="p">,</span><span class="s2">&quot;;&quot;</span><span class="p">)</span><span class="o">+</span><span class="nx">str</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)}</span><span class="kd">var</span> <span class="nx">m</span><span class="o">=</span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">str</span><span class="o">||</span><span class="s2">&quot;&quot;</span><span class="p">),</span><span class="nx">uri</span><span class="o">=</span><span class="p">{},</span><span class="nx">i</span><span class="o">=</span><span class="mi">14</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">){</span><span class="nx">uri</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">=</span><span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">||</span><span class="s2">&quot;&quot;</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">b</span><span class="o">!=-</span><span class="mi">1</span><span class="o">&amp;&amp;</span><span class="nx">e</span><span class="o">!=-</span><span class="mi">1</span><span class="p">){</span><span class="nx">uri</span><span class="p">.</span><span class="nx">source</span><span class="o">=</span><span class="nx">src</span><span class="p">;</span><span class="nx">uri</span><span class="p">.</span><span class="nx">host</span><span class="o">=</span><span class="nx">uri</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nx">uri</span><span class="p">.</span><span class="nx">host</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;/g</span><span class="p">,</span><span class="s2">&quot;:&quot;</span><span class="p">);</span><span class="nx">uri</span><span class="p">.</span><span class="nx">authority</span><span class="o">=</span><span class="nx">uri</span><span class="p">.</span><span class="nx">authority</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s2">&quot;]&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/;/g</span><span class="p">,</span><span class="s2">&quot;:&quot;</span><span class="p">);</span><span class="nx">uri</span><span class="p">.</span><span class="nx">ipv6uri</span><span class="o">=</span><span class="kc">true</span><span class="p">}</span><span class="k">return</span> <span class="nx">uri</span><span class="p">}},{}],</span><span class="mi">34</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">global</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="k">this</span><span class="p">}();</span><span class="kd">var</span> <span class="nx">WebSocket</span><span class="o">=</span><span class="nx">global</span><span class="p">.</span><span class="nx">WebSocket</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">MozWebSocket</span><span class="p">;</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">WebSocket</span><span class="o">?</span><span class="nx">ws</span><span class="o">:</span><span class="kc">null</span><span class="p">;</span><span class="kd">function</span> <span class="nx">ws</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span><span class="nx">protocols</span><span class="p">,</span><span class="nx">opts</span><span class="p">){</span><span class="kd">var</span> <span class="nx">instance</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">protocols</span><span class="p">){</span><span class="nx">instance</span><span class="o">=</span><span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">uri</span><span class="p">,</span><span class="nx">protocols</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="nx">instance</span><span class="o">=</span><span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="nx">uri</span><span class="p">)}</span><span class="k">return</span> <span class="nx">instance</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">WebSocket</span><span class="p">)</span><span class="nx">ws</span><span class="p">.</span><span class="nx">prototype</span><span class="o">=</span><span class="nx">WebSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">},{}],</span><span class="mi">35</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">isArray</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;isarray&quot;</span><span class="p">);</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">hasBinary</span><span class="p">;</span><span class="kd">function</span> <span class="nx">hasBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="kd">function</span> <span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span><span class="k">return</span> <span class="kc">false</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span><span class="o">&amp;&amp;</span><span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">ArrayBuffer</span><span class="o">&amp;&amp;</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">ArrayBuffer</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">Blob</span><span class="o">&amp;&amp;</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Blob</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">File</span><span class="o">&amp;&amp;</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">File</span><span class="p">){</span><span class="k">return</span> <span class="kc">true</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">])){</span><span class="k">return</span> <span class="kc">true</span><span class="p">}}}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="o">&amp;&amp;</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">){</span><span class="nx">obj</span><span class="o">=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()}</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">])){</span><span class="k">return</span> <span class="kc">true</span><span class="p">}}}</span><span class="k">return</span> <span class="kc">false</span><span class="p">}</span><span class="k">return</span> <span class="nx">_hasBinary</span><span class="p">(</span><span class="nx">data</span><span class="p">)}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{</span><span class="nx">isarray</span><span class="o">:</span><span class="mi">36</span><span class="p">}],</span><span class="mi">36</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="o">||</span><span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">){</span><span class="k">return</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arr</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;[object Array]&quot;</span><span class="p">}},{}],</span><span class="mi">37</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">global</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;global&quot;</span><span class="p">);</span><span class="k">try</span><span class="p">{</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="s2">&quot;XMLHttpRequest&quot;</span><span class="k">in</span> <span class="nx">global</span><span class="o">&amp;&amp;</span><span class="s2">&quot;withCredentials&quot;</span><span class="k">in</span> <span class="k">new</span> <span class="nx">global</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kc">false</span><span class="p">}},{</span><span class="nx">global</span><span class="o">:</span><span class="mi">38</span><span class="p">}],</span><span class="mi">38</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="k">this</span><span class="p">}()},{}],</span><span class="mi">39</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">indexOf</span><span class="o">=</span><span class="p">[].</span><span class="nx">indexOf</span><span class="p">;</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">arr</span><span class="p">,</span><span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">indexOf</span><span class="p">)</span><span class="k">return</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="o">++</span><span class="nx">i</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">===</span><span class="nx">obj</span><span class="p">)</span><span class="k">return</span> <span class="nx">i</span><span class="p">}</span><span class="k">return</span><span class="o">-</span><span class="mi">1</span><span class="p">}},{}],</span><span class="mi">40</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">has</span><span class="o">=</span><span class="nb">Object</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">keys</span><span class="o">=</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="o">||</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="kd">var</span> <span class="nx">keys</span><span class="o">=</span><span class="p">[];</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">key</span><span class="p">)){</span><span class="nx">keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">key</span><span class="p">)}}</span><span class="k">return</span> <span class="nx">keys</span><span class="p">};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">values</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="kd">var</span> <span class="nx">vals</span><span class="o">=</span><span class="p">[];</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">key</span><span class="p">)){</span><span class="nx">vals</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">])}}</span><span class="k">return</span> <span class="nx">vals</span><span class="p">};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">merge</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span><span class="nx">b</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">b</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">has</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="nx">key</span><span class="p">)){</span><span class="nx">a</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">=</span><span class="nx">b</span><span class="p">[</span><span class="nx">key</span><span class="p">]}}</span><span class="k">return</span> <span class="nx">a</span><span class="p">};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">length</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="k">return</span> <span class="nx">exports</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">obj</span><span class="p">).</span><span class="nx">length</span><span class="p">};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">isEmpty</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="k">return</span> <span class="mi">0</span><span class="o">==</span><span class="nx">exports</span><span class="p">.</span><span class="nx">length</span><span class="p">(</span><span class="nx">obj</span><span class="p">)}},{}],</span><span class="mi">41</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">re</span><span class="o">=</span><span class="sr">/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/</span><span class="p">;</span><span class="kd">var</span> <span class="nx">parts</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">,</span><span class="s2">&quot;protocol&quot;</span><span class="p">,</span><span class="s2">&quot;authority&quot;</span><span class="p">,</span><span class="s2">&quot;userInfo&quot;</span><span class="p">,</span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="s2">&quot;password&quot;</span><span class="p">,</span><span class="s2">&quot;host&quot;</span><span class="p">,</span><span class="s2">&quot;port&quot;</span><span class="p">,</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span><span class="s2">&quot;path&quot;</span><span class="p">,</span><span class="s2">&quot;directory&quot;</span><span class="p">,</span><span class="s2">&quot;file&quot;</span><span class="p">,</span><span class="s2">&quot;query&quot;</span><span class="p">,</span><span class="s2">&quot;anchor&quot;</span><span class="p">];</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="kd">function</span> <span class="nx">parseuri</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span><span class="kd">var</span> <span class="nx">m</span><span class="o">=</span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">str</span><span class="o">||</span><span class="s2">&quot;&quot;</span><span class="p">),</span><span class="nx">uri</span><span class="o">=</span><span class="p">{},</span><span class="nx">i</span><span class="o">=</span><span class="mi">14</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="nx">i</span><span class="o">--</span><span class="p">){</span><span class="nx">uri</span><span class="p">[</span><span class="nx">parts</span><span class="p">[</span><span class="nx">i</span><span class="p">]]</span><span class="o">=</span><span class="nx">m</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">||</span><span class="s2">&quot;&quot;</span><span class="p">}</span><span class="k">return</span> <span class="nx">uri</span><span class="p">}},{}],</span><span class="mi">42</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="kd">var</span> <span class="nx">isArray</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;isarray&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">isBuf</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./is-buffer&quot;</span><span class="p">);</span><span class="nx">exports</span><span class="p">.</span><span class="nx">deconstructPacket</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="kd">var</span> <span class="nx">buffers</span><span class="o">=</span><span class="p">[];</span><span class="kd">var</span> <span class="nx">packetData</span><span class="o">=</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span><span class="kd">function</span> <span class="nx">_deconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span><span class="k">return</span> <span class="nx">data</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">isBuf</span><span class="p">(</span><span class="nx">data</span><span class="p">)){</span><span class="kd">var</span> <span class="nx">placeholder</span><span class="o">=</span><span class="p">{</span><span class="nx">_placeholder</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="nx">num</span><span class="o">:</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span><span class="p">};</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span><span class="k">return</span> <span class="nx">placeholder</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">)){</span><span class="kd">var</span> <span class="nx">newData</span><span class="o">=</span><span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">newData</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nx">_deconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span><span class="k">return</span> <span class="nx">newData</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">data</span><span class="o">&amp;&amp;!</span><span class="p">(</span><span class="nx">data</span> <span class="k">instanceof</span> <span class="nb">Date</span><span class="p">)){</span><span class="kd">var</span> <span class="nx">newData</span><span class="o">=</span><span class="p">{};</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">data</span><span class="p">){</span><span class="nx">newData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">=</span><span class="nx">_deconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">])}</span><span class="k">return</span> <span class="nx">newData</span><span class="p">}</span><span class="k">return</span> <span class="nx">data</span><span class="p">}</span><span class="kd">var</span> <span class="nx">pack</span><span class="o">=</span><span class="nx">packet</span><span class="p">;</span><span class="nx">pack</span><span class="p">.</span><span class="nx">data</span><span class="o">=</span><span class="nx">_deconstructPacket</span><span class="p">(</span><span class="nx">packetData</span><span class="p">);</span><span class="nx">pack</span><span class="p">.</span><span class="nx">attachments</span><span class="o">=</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="k">return</span><span class="p">{</span><span class="nx">packet</span><span class="o">:</span><span class="nx">pack</span><span class="p">,</span><span class="nx">buffers</span><span class="o">:</span><span class="nx">buffers</span><span class="p">}};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">reconstructPacket</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">packet</span><span class="p">,</span><span class="nx">buffers</span><span class="p">){</span><span class="kd">var</span> <span class="nx">curPlaceHolder</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="kd">function</span> <span class="nx">_reconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="o">&amp;&amp;</span><span class="nx">data</span><span class="p">.</span><span class="nx">_placeholder</span><span class="p">){</span><span class="kd">var</span> <span class="nx">buf</span><span class="o">=</span><span class="nx">buffers</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">num</span><span class="p">];</span><span class="k">return</span> <span class="nx">buf</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">data</span><span class="p">)){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">=</span><span class="nx">_reconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">])}</span><span class="k">return</span> <span class="nx">data</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="o">&amp;&amp;</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">data</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">data</span><span class="p">){</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">=</span><span class="nx">_reconstructPacket</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">])}</span><span class="k">return</span> <span class="nx">data</span><span class="p">}</span><span class="k">return</span> <span class="nx">data</span><span class="p">}</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="o">=</span><span class="nx">_reconstructPacket</span><span class="p">(</span><span class="nx">packet</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span><span class="nx">packet</span><span class="p">.</span><span class="nx">attachments</span><span class="o">=</span><span class="kc">undefined</span><span class="p">;</span><span class="k">return</span> <span class="nx">packet</span><span class="p">};</span><span class="nx">exports</span><span class="p">.</span><span class="nx">removeBlobs</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">function</span> <span class="nx">_removeBlobs</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">curKey</span><span class="p">,</span><span class="nx">containingObject</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span><span class="k">return</span> <span class="nx">obj</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">global</span><span class="p">.</span><span class="nx">Blob</span><span class="o">&amp;&amp;</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Blob</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">File</span><span class="o">&amp;&amp;</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">File</span><span class="p">){</span><span class="nx">pendingBlobs</span><span class="o">++</span><span class="p">;</span><span class="kd">var</span> <span class="nx">fileReader</span><span class="o">=</span><span class="k">new</span> <span class="nx">FileReader</span><span class="p">;</span><span class="nx">fileReader</span><span class="p">.</span><span class="nx">onload</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="nx">containingObject</span><span class="p">){</span><span class="nx">containingObject</span><span class="p">[</span><span class="nx">curKey</span><span class="p">]</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">bloblessData</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">result</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="o">!--</span><span class="nx">pendingBlobs</span><span class="p">){</span><span class="nx">callback</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">)}};</span><span class="nx">fileReader</span><span class="p">.</span><span class="nx">readAsArrayBuffer</span><span class="p">(</span><span class="nx">obj</span><span class="p">)}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">obj</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">_removeBlobs</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span><span class="nx">i</span><span class="p">,</span><span class="nx">obj</span><span class="p">)}}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="o">&amp;&amp;</span><span class="s2">&quot;object&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">obj</span><span class="o">&amp;&amp;!</span><span class="nx">isBuf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)){</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">obj</span><span class="p">){</span><span class="nx">_removeBlobs</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span><span class="nx">key</span><span class="p">,</span><span class="nx">obj</span><span class="p">)}}}</span><span class="kd">var</span> <span class="nx">pendingBlobs</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="kd">var</span> <span class="nx">bloblessData</span><span class="o">=</span><span class="nx">data</span><span class="p">;</span><span class="nx">_removeBlobs</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">pendingBlobs</span><span class="p">){</span><span class="nx">callback</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">)}}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{</span><span class="s2">&quot;./is-buffer&quot;</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="nx">isarray</span><span class="o">:</span><span class="mi">45</span><span class="p">}],</span><span class="mi">43</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="kd">var</span> <span class="nx">debug</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)(</span><span class="s2">&quot;socket.io-parser&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">json</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;json3&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">isArray</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;isarray&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">Emitter</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;component-emitter&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">binary</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./binary&quot;</span><span class="p">);</span><span class="kd">var</span> <span class="nx">isBuf</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="s2">&quot;./is-buffer&quot;</span><span class="p">);</span><span class="nx">exports</span><span class="p">.</span><span class="nx">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">types</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CONNECT&quot;</span><span class="p">,</span><span class="s2">&quot;DISCONNECT&quot;</span><span class="p">,</span><span class="s2">&quot;EVENT&quot;</span><span class="p">,</span><span class="s2">&quot;BINARY_EVENT&quot;</span><span class="p">,</span><span class="s2">&quot;ACK&quot;</span><span class="p">,</span><span class="s2">&quot;BINARY_ACK&quot;</span><span class="p">,</span><span class="s2">&quot;ERROR&quot;</span><span class="p">];</span><span class="nx">exports</span><span class="p">.</span><span class="nx">CONNECT</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">DISCONNECT</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">EVENT</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">ACK</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">ERROR</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span><span class="o">=</span><span class="mi">5</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span><span class="o">=</span><span class="mi">6</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">Encoder</span><span class="o">=</span><span class="nx">Encoder</span><span class="p">;</span><span class="nx">exports</span><span class="p">.</span><span class="nx">Decoder</span><span class="o">=</span><span class="nx">Decoder</span><span class="p">;</span><span class="kd">function</span> <span class="nx">Encoder</span><span class="p">(){}</span><span class="nx">Encoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">encode</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;encoding packet %j&quot;</span><span class="p">,</span><span class="nx">obj</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span><span class="o">==</span><span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="o">||</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span><span class="o">==</span><span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="p">){</span><span class="nx">encodeAsBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="kd">var</span> <span class="nx">encoding</span><span class="o">=</span><span class="nx">encodeAsString</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span><span class="nx">callback</span><span class="p">([</span><span class="nx">encoding</span><span class="p">])}};</span><span class="kd">function</span> <span class="nx">encodeAsString</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="kd">var</span> <span class="nx">str</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">nsp</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="nx">str</span><span class="o">+=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span><span class="o">==</span><span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="o">||</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span><span class="o">==</span><span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="p">){</span><span class="nx">str</span><span class="o">+=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">attachments</span><span class="p">;</span><span class="nx">str</span><span class="o">+=</span><span class="s2">&quot;-&quot;</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">nsp</span><span class="o">&amp;&amp;</span><span class="s2">&quot;/&quot;</span><span class="o">!=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">nsp</span><span class="p">){</span><span class="nx">nsp</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">str</span><span class="o">+=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">nsp</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">!=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">nsp</span><span class="p">){</span><span class="nx">str</span><span class="o">+=</span><span class="s2">&quot;,&quot;</span><span class="p">;</span><span class="nx">nsp</span><span class="o">=</span><span class="kc">false</span><span class="p">}</span><span class="nx">str</span><span class="o">+=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">!=</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">nsp</span><span class="p">)</span><span class="nx">str</span><span class="o">+=</span><span class="s2">&quot;,&quot;</span><span class="p">;</span><span class="nx">str</span><span class="o">+=</span><span class="nx">json</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">)}</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;encoded %j as %s&quot;</span><span class="p">,</span><span class="nx">obj</span><span class="p">,</span><span class="nx">str</span><span class="p">);</span><span class="k">return</span> <span class="nx">str</span><span class="p">}</span><span class="kd">function</span> <span class="nx">encodeAsBinary</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">function</span> <span class="nx">writeEncoding</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">){</span><span class="kd">var</span> <span class="nx">deconstruction</span><span class="o">=</span><span class="nx">binary</span><span class="p">.</span><span class="nx">deconstructPacket</span><span class="p">(</span><span class="nx">bloblessData</span><span class="p">);</span><span class="kd">var</span> <span class="nx">pack</span><span class="o">=</span><span class="nx">encodeAsString</span><span class="p">(</span><span class="nx">deconstruction</span><span class="p">.</span><span class="nx">packet</span><span class="p">);</span><span class="kd">var</span> <span class="nx">buffers</span><span class="o">=</span><span class="nx">deconstruction</span><span class="p">.</span><span class="nx">buffers</span><span class="p">;</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">pack</span><span class="p">);</span><span class="nx">callback</span><span class="p">(</span><span class="nx">buffers</span><span class="p">)}</span><span class="nx">binary</span><span class="p">.</span><span class="nx">removeBlobs</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="nx">writeEncoding</span><span class="p">)}</span><span class="kd">function</span> <span class="nx">Decoder</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="o">=</span><span class="kc">null</span><span class="p">}</span><span class="nx">Emitter</span><span class="p">(</span><span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span><span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">add</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="kd">var</span> <span class="nx">packet</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;string&quot;</span><span class="o">==</span><span class="k">typeof</span> <span class="nx">obj</span><span class="p">){</span><span class="nx">packet</span><span class="o">=</span><span class="nx">decodeString</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span><span class="o">==</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="o">||</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span><span class="o">==</span><span class="nx">packet</span><span class="p">.</span><span class="nx">type</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="o">=</span><span class="k">new</span> <span class="nx">BinaryReconstructor</span><span class="p">(</span><span class="nx">packet</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">.</span><span class="nx">reconPack</span><span class="p">.</span><span class="nx">attachments</span><span class="o">==</span><span class="mi">0</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;decoded&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">)}}</span><span class="k">else</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;decoded&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">)}}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">isBuf</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span><span class="o">||</span><span class="nx">obj</span><span class="p">.</span><span class="nx">base64</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">){</span><span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;got binary data when not reconstructing a packet&quot;</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="nx">packet</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">.</span><span class="nx">takeBinaryData</span><span class="p">(</span><span class="nx">obj</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;decoded&quot;</span><span class="p">,</span><span class="nx">packet</span><span class="p">)}}}</span><span class="k">else</span><span class="p">{</span><span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unknown type: &quot;</span><span class="o">+</span><span class="nx">obj</span><span class="p">)}};</span><span class="kd">function</span> <span class="nx">decodeString</span><span class="p">(</span><span class="nx">str</span><span class="p">){</span><span class="kd">var</span> <span class="nx">p</span><span class="o">=</span><span class="p">{};</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">p</span><span class="p">.</span><span class="nx">type</span><span class="o">=</span><span class="nb">Number</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">==</span><span class="nx">exports</span><span class="p">.</span><span class="nx">types</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">type</span><span class="p">])</span><span class="k">return</span> <span class="nx">error</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_EVENT</span><span class="o">==</span><span class="nx">p</span><span class="p">.</span><span class="nx">type</span><span class="o">||</span><span class="nx">exports</span><span class="p">.</span><span class="nx">BINARY_ACK</span><span class="o">==</span><span class="nx">p</span><span class="p">.</span><span class="nx">type</span><span class="p">){</span><span class="nx">p</span><span class="p">.</span><span class="nx">attachments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">)</span><span class="o">!=</span><span class="s2">&quot;-&quot;</span><span class="p">){</span><span class="nx">p</span><span class="p">.</span><span class="nx">attachments</span><span class="o">+=</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)}</span><span class="nx">p</span><span class="p">.</span><span class="nx">attachments</span><span class="o">=</span><span class="nb">Number</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">attachments</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="o">==</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)){</span><span class="nx">p</span><span class="p">.</span><span class="nx">nsp</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">){</span><span class="kd">var</span> <span class="nx">c</span><span class="o">=</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">==</span><span class="nx">c</span><span class="p">)</span><span class="k">break</span><span class="p">;</span><span class="nx">p</span><span class="p">.</span><span class="nx">nsp</span><span class="o">+=</span><span class="nx">c</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="k">break</span><span class="p">}}</span><span class="k">else</span><span class="p">{</span><span class="nx">p</span><span class="p">.</span><span class="nx">nsp</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">}</span><span class="kd">var</span> <span class="nx">next</span><span class="o">=</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">!=</span><span class="nx">next</span><span class="o">&amp;&amp;</span><span class="nb">Number</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span><span class="o">==</span><span class="nx">next</span><span class="p">){</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">){</span><span class="kd">var</span> <span class="nx">c</span><span class="o">=</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="kc">null</span><span class="o">==</span><span class="nx">c</span><span class="o">||</span><span class="nb">Number</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="o">!=</span><span class="nx">c</span><span class="p">){</span><span class="o">--</span><span class="nx">i</span><span class="p">;</span><span class="k">break</span><span class="p">}</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="o">+=</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="k">break</span><span class="p">}</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="o">=</span><span class="nb">Number</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">id</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="o">++</span><span class="nx">i</span><span class="p">)){</span><span class="k">try</span><span class="p">{</span><span class="nx">p</span><span class="p">.</span><span class="nx">data</span><span class="o">=</span><span class="nx">json</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">str</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">i</span><span class="p">))}</span><span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span><span class="k">return</span> <span class="nx">error</span><span class="p">()}}</span><span class="nx">debug</span><span class="p">(</span><span class="s2">&quot;decoded %s as %j&quot;</span><span class="p">,</span><span class="nx">str</span><span class="p">,</span><span class="nx">p</span><span class="p">);</span><span class="k">return</span> <span class="nx">p</span><span class="p">}</span><span class="nx">Decoder</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">destroy</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">reconstructor</span><span class="p">.</span><span class="nx">finishedReconstruction</span><span class="p">()}};</span><span class="kd">function</span> <span class="nx">BinaryReconstructor</span><span class="p">(</span><span class="nx">packet</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">reconPack</span><span class="o">=</span><span class="nx">packet</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="o">=</span><span class="p">[]}</span><span class="nx">BinaryReconstructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">takeBinaryData</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">binData</span><span class="p">){</span><span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">binData</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="k">this</span><span class="p">.</span><span class="nx">reconPack</span><span class="p">.</span><span class="nx">attachments</span><span class="p">){</span><span class="kd">var</span> <span class="nx">packet</span><span class="o">=</span><span class="nx">binary</span><span class="p">.</span><span class="nx">reconstructPacket</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reconPack</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">finishedReconstruction</span><span class="p">();</span><span class="k">return</span> <span class="nx">packet</span><span class="p">}</span><span class="k">return</span> <span class="kc">null</span><span class="p">};</span><span class="nx">BinaryReconstructor</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">finishedReconstruction</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">reconPack</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">this</span><span class="p">.</span><span class="nx">buffers</span><span class="o">=</span><span class="p">[]};</span><span class="kd">function</span> <span class="nx">error</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span><span class="k">return</span><span class="p">{</span><span class="nx">type</span><span class="o">:</span><span class="nx">exports</span><span class="p">.</span><span class="nx">ERROR</span><span class="p">,</span><span class="nx">data</span><span class="o">:</span><span class="s2">&quot;parser error&quot;</span><span class="p">}}},{</span><span class="s2">&quot;./binary&quot;</span><span class="o">:</span><span class="mi">42</span><span class="p">,</span><span class="s2">&quot;./is-buffer&quot;</span><span class="o">:</span><span class="mi">44</span><span class="p">,</span><span class="s2">&quot;component-emitter&quot;</span><span class="o">:</span><span class="mi">8</span><span class="p">,</span><span class="nx">debug</span><span class="o">:</span><span class="mi">9</span><span class="p">,</span><span class="nx">isarray</span><span class="o">:</span><span class="mi">45</span><span class="p">,</span><span class="nx">json3</span><span class="o">:</span><span class="mi">46</span><span class="p">}],</span><span class="mi">44</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nx">global</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">isBuf</span><span class="p">;</span><span class="kd">function</span> <span class="nx">isBuf</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span><span class="k">return</span> <span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span><span class="o">&amp;&amp;</span><span class="nx">global</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">.</span><span class="nx">isBuffer</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span><span class="o">||</span><span class="nx">global</span><span class="p">.</span><span class="nx">ArrayBuffer</span><span class="o">&amp;&amp;</span><span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">ArrayBuffer</span><span class="p">}}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="k">typeof</span> <span class="nx">self</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nx">self</span><span class="o">:</span><span class="k">typeof</span> <span class="nb">window</span><span class="o">!==</span><span class="s2">&quot;undefined&quot;</span><span class="o">?</span><span class="nb">window</span><span class="o">:</span><span class="p">{})},{}],</span><span class="mi">45</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">_dereq_</span><span class="p">(</span><span class="mi">36</span><span class="p">)},{}],</span><span class="mi">46</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){(</span><span class="kd">function</span><span class="p">(</span><span class="nb">window</span><span class="p">){</span><span class="kd">var</span> <span class="nx">getClass</span><span class="o">=</span><span class="p">{}.</span><span class="nx">toString</span><span class="p">,</span><span class="nx">isProperty</span><span class="p">,</span><span class="nx">forEach</span><span class="p">,</span><span class="nx">undef</span><span class="p">;</span><span class="kd">var</span> <span class="nx">isLoader</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">define</span><span class="o">===</span><span class="s2">&quot;function&quot;</span><span class="o">&amp;&amp;</span><span class="nx">define</span><span class="p">.</span><span class="nx">amd</span><span class="p">;</span><span class="kd">var</span> <span class="nx">nativeJSON</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">JSON</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">&amp;&amp;</span><span class="nx">JSON</span><span class="p">;</span><span class="kd">var</span> <span class="nx">JSON3</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">exports</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">&amp;&amp;</span><span class="nx">exports</span><span class="o">&amp;&amp;!</span><span class="nx">exports</span><span class="p">.</span><span class="nx">nodeType</span><span class="o">&amp;&amp;</span><span class="nx">exports</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">JSON3</span><span class="o">&amp;&amp;</span><span class="nx">nativeJSON</span><span class="p">){</span><span class="nx">JSON3</span><span class="p">.</span><span class="nx">stringify</span><span class="o">=</span><span class="nx">nativeJSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">;</span><span class="nx">JSON3</span><span class="p">.</span><span class="nx">parse</span><span class="o">=</span><span class="nx">nativeJSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">JSON3</span><span class="o">=</span><span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span><span class="o">=</span><span class="nx">nativeJSON</span><span class="o">||</span><span class="p">{}}</span><span class="kd">var</span> <span class="nx">isExtended</span><span class="o">=</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">-</span><span class="mh">0xc782b5b800cec</span><span class="p">);</span><span class="k">try</span><span class="p">{</span><span class="nx">isExtended</span><span class="o">=</span><span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">()</span><span class="o">==-</span><span class="mi">109252</span><span class="o">&amp;&amp;</span><span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">()</span><span class="o">===</span><span class="mi">0</span><span class="o">&amp;&amp;</span><span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">()</span><span class="o">===</span><span class="mi">1</span><span class="o">&amp;&amp;</span><span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">()</span><span class="o">==</span><span class="mi">10</span><span class="o">&amp;&amp;</span><span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">()</span><span class="o">==</span><span class="mi">37</span><span class="o">&amp;&amp;</span><span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">()</span><span class="o">==</span><span class="mi">6</span><span class="o">&amp;&amp;</span><span class="nx">isExtended</span><span class="p">.</span><span class="nx">getUTCMilliseconds</span><span class="p">()</span><span class="o">==</span><span class="mi">708</span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">){}</span><span class="kd">function</span> <span class="nx">has</span><span class="p">(</span><span class="nx">name</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">has</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">!==</span><span class="nx">undef</span><span class="p">){</span><span class="k">return</span> <span class="nx">has</span><span class="p">[</span><span class="nx">name</span><span class="p">]}</span><span class="kd">var</span> <span class="nx">isSupported</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="o">==</span><span class="s2">&quot;bug-string-char-index&quot;</span><span class="p">){</span><span class="nx">isSupported</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="s2">&quot;a&quot;</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="o">==</span><span class="s2">&quot;json&quot;</span><span class="p">){</span><span class="nx">isSupported</span><span class="o">=</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json-stringify&quot;</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json-parse&quot;</span><span class="p">)}</span><span class="k">else</span><span class="p">{</span><span class="kd">var</span> <span class="nx">value</span><span class="p">,</span><span class="nx">serialized</span><span class="o">=</span><span class="s1">&#39;{&quot;a&quot;:[1,true,false,null,&quot;\\u0000\\b\\n\\f\\r\\t&quot;]}&#39;</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="o">==</span><span class="s2">&quot;json-stringify&quot;</span><span class="p">){</span><span class="kd">var</span> <span class="nx">stringify</span><span class="o">=</span><span class="nx">JSON3</span><span class="p">.</span><span class="nx">stringify</span><span class="p">,</span><span class="nx">stringifySupported</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">stringify</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="o">&amp;&amp;</span><span class="nx">isExtended</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">stringifySupported</span><span class="p">){(</span><span class="nx">value</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="mi">1</span><span class="p">}).</span><span class="nx">toJSON</span><span class="o">=</span><span class="nx">value</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="nx">stringifySupported</span><span class="o">=</span><span class="nx">stringify</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">===</span><span class="s2">&quot;0&quot;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Number</span><span class="p">)</span><span class="o">===</span><span class="s2">&quot;0&quot;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">String</span><span class="p">)</span><span class="o">==</span><span class="s1">&#39;&quot;&quot;&#39;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">getClass</span><span class="p">)</span><span class="o">===</span><span class="nx">undef</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">undef</span><span class="p">)</span><span class="o">===</span><span class="nx">undef</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">()</span><span class="o">===</span><span class="nx">undef</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="o">===</span><span class="s2">&quot;1&quot;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">([</span><span class="nx">value</span><span class="p">])</span><span class="o">==</span><span class="s2">&quot;[1]&quot;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">([</span><span class="nx">undef</span><span class="p">])</span><span class="o">==</span><span class="s2">&quot;[null]&quot;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;null&quot;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">([</span><span class="nx">undef</span><span class="p">,</span><span class="nx">getClass</span><span class="p">,</span><span class="kc">null</span><span class="p">])</span><span class="o">==</span><span class="s2">&quot;[null,null,null]&quot;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">({</span><span class="nx">a</span><span class="o">:</span><span class="p">[</span><span class="nx">value</span><span class="p">,</span><span class="kc">true</span><span class="p">,</span><span class="kc">false</span><span class="p">,</span><span class="kc">null</span><span class="p">,</span><span class="s2">&quot;\x00\b\n\f\r  &quot;</span><span class="p">]})</span><span class="o">==</span><span class="nx">serialized</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span><span class="nx">value</span><span class="p">)</span><span class="o">===</span><span class="s2">&quot;1&quot;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span><span class="kc">null</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;[\n 1,\n 2\n]&quot;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">-</span><span class="mi">864</span><span class="nx">e13</span><span class="p">))</span><span class="o">==</span><span class="s1">&#39;&quot;-271821-04-20T00:00:00.000Z&quot;&#39;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="mi">864</span><span class="nx">e13</span><span class="p">))</span><span class="o">==</span><span class="s1">&#39;&quot;+275760-09-13T00:00:00.000Z&quot;&#39;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">-</span><span class="mi">621987552</span><span class="nx">e5</span><span class="p">))</span><span class="o">==</span><span class="s1">&#39;&quot;-000001-01-01T00:00:00.000Z&quot;&#39;</span><span class="o">&amp;&amp;</span><span class="nx">stringify</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">==</span><span class="s1">&#39;&quot;1969-12-31T23:59:59.999Z&quot;&#39;</span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">){</span><span class="nx">stringifySupported</span><span class="o">=</span><span class="kc">false</span><span class="p">}}</span><span class="nx">isSupported</span><span class="o">=</span><span class="nx">stringifySupported</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">name</span><span class="o">==</span><span class="s2">&quot;json-parse&quot;</span><span class="p">){</span><span class="kd">var</span> <span class="nx">parse</span><span class="o">=</span><span class="nx">JSON3</span><span class="p">.</span><span class="nx">parse</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">parse</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="nx">parse</span><span class="p">(</span><span class="s2">&quot;0&quot;</span><span class="p">)</span><span class="o">===</span><span class="mi">0</span><span class="o">&amp;&amp;!</span><span class="nx">parse</span><span class="p">(</span><span class="kc">false</span><span class="p">)){</span><span class="nx">value</span><span class="o">=</span><span class="nx">parse</span><span class="p">(</span><span class="nx">serialized</span><span class="p">);</span><span class="kd">var</span> <span class="nx">parseSupported</span><span class="o">=</span><span class="nx">value</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">].</span><span class="nx">length</span><span class="o">==</span><span class="mi">5</span><span class="o">&amp;&amp;</span><span class="nx">value</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">===</span><span class="mi">1</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">parseSupported</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">parseSupported</span><span class="o">=!</span><span class="nx">parse</span><span class="p">(</span><span class="s1">&#39;&quot;  &quot;&#39;</span><span class="p">)}</span><span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">){}</span><span class="k">if</span><span class="p">(</span><span class="nx">parseSupported</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">parseSupported</span><span class="o">=</span><span class="nx">parse</span><span class="p">(</span><span class="s2">&quot;01&quot;</span><span class="p">)</span><span class="o">!==</span><span class="mi">1</span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">){}}</span><span class="k">if</span><span class="p">(</span><span class="nx">parseSupported</span><span class="p">){</span><span class="k">try</span><span class="p">{</span><span class="nx">parseSupported</span><span class="o">=</span><span class="nx">parse</span><span class="p">(</span><span class="s2">&quot;1.&quot;</span><span class="p">)</span><span class="o">!==</span><span class="mi">1</span><span class="p">}</span><span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">){}}}}}</span><span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">){</span><span class="nx">parseSupported</span><span class="o">=</span><span class="kc">false</span><span class="p">}}</span><span class="nx">isSupported</span><span class="o">=</span><span class="nx">parseSupported</span><span class="p">}}</span><span class="k">return</span> <span class="nx">has</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">=!!</span><span class="nx">isSupported</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json&quot;</span><span class="p">)){</span><span class="kd">var</span> <span class="nx">functionClass</span><span class="o">=</span><span class="s2">&quot;[object Function]&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">dateClass</span><span class="o">=</span><span class="s2">&quot;[object Date]&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">numberClass</span><span class="o">=</span><span class="s2">&quot;[object Number]&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">stringClass</span><span class="o">=</span><span class="s2">&quot;[object String]&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">arrayClass</span><span class="o">=</span><span class="s2">&quot;[object Array]&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">booleanClass</span><span class="o">=</span><span class="s2">&quot;[object Boolean]&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">charIndexBuggy</span><span class="o">=</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;bug-string-char-index&quot;</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">isExtended</span><span class="p">){</span><span class="kd">var</span> <span class="nx">floor</span><span class="o">=</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">;</span><span class="kd">var</span> <span class="nx">Months</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">31</span><span class="p">,</span><span class="mi">59</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">120</span><span class="p">,</span><span class="mi">151</span><span class="p">,</span><span class="mi">181</span><span class="p">,</span><span class="mi">212</span><span class="p">,</span><span class="mi">243</span><span class="p">,</span><span class="mi">273</span><span class="p">,</span><span class="mi">304</span><span class="p">,</span><span class="mi">334</span><span class="p">];</span><span class="kd">var</span> <span class="nx">getDay</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span><span class="nx">month</span><span class="p">){</span><span class="k">return</span> <span class="nx">Months</span><span class="p">[</span><span class="nx">month</span><span class="p">]</span><span class="o">+</span><span class="mi">365</span><span class="o">*</span><span class="p">(</span><span class="nx">year</span><span class="o">-</span><span class="mi">1970</span><span class="p">)</span><span class="o">+</span><span class="nx">floor</span><span class="p">((</span><span class="nx">year</span><span class="o">-</span><span class="mi">1969</span><span class="o">+</span><span class="p">(</span><span class="nx">month</span><span class="o">=+</span><span class="p">(</span><span class="nx">month</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">-</span><span class="nx">floor</span><span class="p">((</span><span class="nx">year</span><span class="o">-</span><span class="mi">1901</span><span class="o">+</span><span class="nx">month</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">+</span><span class="nx">floor</span><span class="p">((</span><span class="nx">year</span><span class="o">-</span><span class="mi">1601</span><span class="o">+</span><span class="nx">month</span><span class="p">)</span><span class="o">/</span><span class="mi">400</span><span class="p">)}}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">isProperty</span><span class="o">=</span><span class="p">{}.</span><span class="nx">hasOwnProperty</span><span class="p">)){</span><span class="nx">isProperty</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">){</span><span class="kd">var</span> <span class="nx">members</span><span class="o">=</span><span class="p">{},</span><span class="nx">constructor</span><span class="p">;</span><span class="k">if</span><span class="p">((</span><span class="nx">members</span><span class="p">.</span><span class="nx">__proto__</span><span class="o">=</span><span class="kc">null</span><span class="p">,</span><span class="nx">members</span><span class="p">.</span><span class="nx">__proto__</span><span class="o">=</span><span class="p">{</span><span class="nx">toString</span><span class="o">:</span><span class="mi">1</span><span class="p">},</span><span class="nx">members</span><span class="p">).</span><span class="nx">toString</span><span class="o">!=</span><span class="nx">getClass</span><span class="p">){</span><span class="nx">isProperty</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">){</span><span class="kd">var</span> <span class="nx">original</span><span class="o">=</span><span class="k">this</span><span class="p">.</span><span class="nx">__proto__</span><span class="p">,</span><span class="nx">result</span><span class="o">=</span><span class="nx">property</span> <span class="k">in</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">__proto__</span><span class="o">=</span><span class="kc">null</span><span class="p">,</span><span class="k">this</span><span class="p">);</span><span class="k">this</span><span class="p">.</span><span class="nx">__proto__</span><span class="o">=</span><span class="nx">original</span><span class="p">;</span><span class="k">return</span> <span class="nx">result</span><span class="p">}}</span><span class="k">else</span><span class="p">{</span><span class="nx">constructor</span><span class="o">=</span><span class="nx">members</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span><span class="nx">isProperty</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">){</span><span class="kd">var</span> <span class="nx">parent</span><span class="o">=</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">constructor</span><span class="o">||</span><span class="nx">constructor</span><span class="p">).</span><span class="nx">prototype</span><span class="p">;</span><span class="k">return</span> <span class="nx">property</span> <span class="k">in</span> <span class="k">this</span><span class="o">&amp;&amp;!</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">parent</span><span class="o">&amp;&amp;</span><span class="k">this</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span><span class="o">===</span><span class="nx">parent</span><span class="p">[</span><span class="nx">property</span><span class="p">])}}</span><span class="nx">members</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">return</span> <span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="nx">property</span><span class="p">)}}</span><span class="kd">var</span> <span class="nx">PrimitiveTypes</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;boolean&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">number</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="nx">string</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="kc">undefined</span><span class="o">:</span><span class="mi">1</span><span class="p">};</span><span class="kd">var</span> <span class="nx">isHostType</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">property</span><span class="p">){</span><span class="kd">var</span> <span class="nx">type</span><span class="o">=</span><span class="k">typeof</span> <span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">];</span><span class="k">return</span> <span class="nx">type</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">?!!</span><span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span><span class="o">:!</span><span class="nx">PrimitiveTypes</span><span class="p">[</span><span class="nx">type</span><span class="p">]};</span><span class="nx">forEach</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">var</span> <span class="nx">size</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">Properties</span><span class="p">,</span><span class="nx">members</span><span class="p">,</span><span class="nx">property</span><span class="p">;(</span><span class="nx">Properties</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="k">this</span><span class="p">.</span><span class="nx">valueOf</span><span class="o">=</span><span class="mi">0</span><span class="p">}).</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">valueOf</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">members</span><span class="o">=</span><span class="k">new</span> <span class="nx">Properties</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">members</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">members</span><span class="p">,</span><span class="nx">property</span><span class="p">)){</span><span class="nx">size</span><span class="o">++</span><span class="p">}}</span><span class="nx">Properties</span><span class="o">=</span><span class="nx">members</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">size</span><span class="p">){</span><span class="nx">members</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;valueOf&quot;</span><span class="p">,</span><span class="s2">&quot;toString&quot;</span><span class="p">,</span><span class="s2">&quot;toLocaleString&quot;</span><span class="p">,</span><span class="s2">&quot;propertyIsEnumerable&quot;</span><span class="p">,</span><span class="s2">&quot;isPrototypeOf&quot;</span><span class="p">,</span><span class="s2">&quot;hasOwnProperty&quot;</span><span class="p">,</span><span class="s2">&quot;constructor&quot;</span><span class="p">];</span><span class="nx">forEach</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">var</span> <span class="nx">isFunction</span><span class="o">=</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="o">==</span><span class="nx">functionClass</span><span class="p">,</span><span class="nx">property</span><span class="p">,</span><span class="nx">length</span><span class="p">;</span><span class="kd">var</span> <span class="nx">hasProperty</span><span class="o">=!</span><span class="nx">isFunction</span><span class="o">&amp;&amp;</span><span class="k">typeof</span> <span class="nx">object</span><span class="p">.</span><span class="nx">constructor</span><span class="o">!=</span><span class="s2">&quot;function&quot;</span><span class="o">&amp;&amp;</span><span class="nx">isHostType</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="s2">&quot;hasOwnProperty&quot;</span><span class="p">)</span><span class="o">?</span><span class="nx">object</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="o">:</span><span class="nx">isProperty</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">isFunction</span><span class="o">&amp;&amp;</span><span class="nx">property</span><span class="o">==</span><span class="s2">&quot;prototype&quot;</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="nx">hasProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">property</span><span class="p">)){</span><span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">)}}</span><span class="k">for</span><span class="p">(</span><span class="nx">length</span><span class="o">=</span><span class="nx">members</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">property</span><span class="o">=</span><span class="nx">members</span><span class="p">[</span><span class="o">--</span><span class="nx">length</span><span class="p">];</span><span class="nx">hasProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">property</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">));}}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">size</span><span class="o">==</span><span class="mi">2</span><span class="p">){</span><span class="nx">forEach</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">var</span> <span class="nx">members</span><span class="o">=</span><span class="p">{},</span><span class="nx">isFunction</span><span class="o">=</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="o">==</span><span class="nx">functionClass</span><span class="p">,</span><span class="nx">property</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">isFunction</span><span class="o">&amp;&amp;</span><span class="nx">property</span><span class="o">==</span><span class="s2">&quot;prototype&quot;</span><span class="p">)</span><span class="o">&amp;&amp;!</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">members</span><span class="p">,</span><span class="nx">property</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">members</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">property</span><span class="p">)){</span><span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">)}}}}</span><span class="k">else</span><span class="p">{</span><span class="nx">forEach</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">var</span> <span class="nx">isFunction</span><span class="o">=</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span><span class="o">==</span><span class="nx">functionClass</span><span class="p">,</span><span class="nx">property</span><span class="p">,</span><span class="nx">isConstructor</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">property</span> <span class="k">in</span> <span class="nx">object</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">isFunction</span><span class="o">&amp;&amp;</span><span class="nx">property</span><span class="o">==</span><span class="s2">&quot;prototype&quot;</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">property</span><span class="p">)</span><span class="o">&amp;&amp;!</span><span class="p">(</span><span class="nx">isConstructor</span><span class="o">=</span><span class="nx">property</span><span class="o">===</span><span class="s2">&quot;constructor&quot;</span><span class="p">)){</span><span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">)}}</span><span class="k">if</span><span class="p">(</span><span class="nx">isConstructor</span><span class="o">||</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">property</span><span class="o">=</span><span class="s2">&quot;constructor&quot;</span><span class="p">)){</span><span class="nx">callback</span><span class="p">(</span><span class="nx">property</span><span class="p">)}}}</span><span class="k">return</span> <span class="nx">forEach</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">callback</span><span class="p">)};</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json-stringify&quot;</span><span class="p">)){</span><span class="kd">var</span> <span class="nx">Escapes</span><span class="o">=</span><span class="p">{</span><span class="mi">92</span><span class="o">:</span><span class="s2">&quot;\\\\&quot;</span><span class="p">,</span><span class="mi">34</span><span class="o">:</span><span class="s1">&#39;\\&quot;&#39;</span><span class="p">,</span><span class="mi">8</span><span class="o">:</span><span class="s2">&quot;\\b&quot;</span><span class="p">,</span><span class="mi">12</span><span class="o">:</span><span class="s2">&quot;\\f&quot;</span><span class="p">,</span><span class="mi">10</span><span class="o">:</span><span class="s2">&quot;\\n&quot;</span><span class="p">,</span><span class="mi">13</span><span class="o">:</span><span class="s2">&quot;\\r&quot;</span><span class="p">,</span><span class="mi">9</span><span class="o">:</span><span class="s2">&quot;\\t&quot;</span><span class="p">};</span><span class="kd">var</span> <span class="nx">leadingZeroes</span><span class="o">=</span><span class="s2">&quot;000000&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">toPaddedString</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="nx">value</span><span class="p">){</span><span class="k">return</span><span class="p">(</span><span class="nx">leadingZeroes</span><span class="o">+</span><span class="p">(</span><span class="nx">value</span><span class="o">||</span><span class="mi">0</span><span class="p">)).</span><span class="nx">slice</span><span class="p">(</span><span class="o">-</span><span class="nx">width</span><span class="p">)};</span><span class="kd">var</span> <span class="nx">unicodePrefix</span><span class="o">=</span><span class="s2">&quot;\\u00&quot;</span><span class="p">;</span><span class="kd">var</span> <span class="nx">quote</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span><span class="kd">var</span> <span class="nx">result</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="nx">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">length</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="nx">isLarge</span><span class="o">=</span><span class="nx">length</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">&amp;&amp;</span><span class="nx">charIndexBuggy</span><span class="p">,</span><span class="nx">symbols</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">isLarge</span><span class="p">){</span><span class="nx">symbols</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)}</span><span class="k">for</span><span class="p">(;</span><span class="nx">index</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">;</span><span class="nx">index</span><span class="o">++</span><span class="p">){</span><span class="kd">var</span> <span class="nx">charCode</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">index</span><span class="p">);</span><span class="k">switch</span><span class="p">(</span><span class="nx">charCode</span><span class="p">){</span><span class="k">case</span> <span class="mi">8</span><span class="o">:</span><span class="k">case</span> <span class="mi">9</span><span class="o">:</span><span class="k">case</span> <span class="mi">10</span><span class="o">:</span><span class="k">case</span> <span class="mi">12</span><span class="o">:</span><span class="k">case</span> <span class="mi">13</span><span class="o">:</span><span class="k">case</span> <span class="mi">34</span><span class="o">:</span><span class="k">case</span> <span class="mi">92</span><span class="o">:</span><span class="nx">result</span><span class="o">+=</span><span class="nx">Escapes</span><span class="p">[</span><span class="nx">charCode</span><span class="p">];</span><span class="k">break</span><span class="p">;</span><span class="k">default</span><span class="o">:</span><span class="k">if</span><span class="p">(</span><span class="nx">charCode</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">){</span><span class="nx">result</span><span class="o">+=</span><span class="nx">unicodePrefix</span><span class="o">+</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">charCode</span><span class="p">.</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span><span class="k">break</span><span class="p">}</span><span class="nx">result</span><span class="o">+=</span><span class="nx">isLarge</span><span class="o">?</span><span class="nx">symbols</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span><span class="o">:</span><span class="nx">charIndexBuggy</span><span class="o">?</span><span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span><span class="o">:</span><span class="nx">value</span><span class="p">[</span><span class="nx">index</span><span class="p">]}}</span><span class="k">return</span> <span class="nx">result</span><span class="o">+</span><span class="s1">&#39;&quot;&#39;</span><span class="p">};</span><span class="kd">var</span> <span class="nx">serialize</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span><span class="nx">object</span><span class="p">,</span><span class="nx">callback</span><span class="p">,</span><span class="nx">properties</span><span class="p">,</span><span class="nx">whitespace</span><span class="p">,</span><span class="nx">indentation</span><span class="p">,</span><span class="nx">stack</span><span class="p">){</span><span class="kd">var</span> <span class="nx">value</span><span class="p">,</span><span class="nx">className</span><span class="p">,</span><span class="nx">year</span><span class="p">,</span><span class="nx">month</span><span class="p">,</span><span class="nx">date</span><span class="p">,</span><span class="nx">time</span><span class="p">,</span><span class="nx">hours</span><span class="p">,</span><span class="nx">minutes</span><span class="p">,</span><span class="nx">seconds</span><span class="p">,</span><span class="nx">milliseconds</span><span class="p">,</span><span class="nx">results</span><span class="p">,</span><span class="nx">element</span><span class="p">,</span><span class="nx">index</span><span class="p">,</span><span class="nx">length</span><span class="p">,</span><span class="nx">prefix</span><span class="p">,</span><span class="nx">result</span><span class="p">;</span><span class="k">try</span><span class="p">{</span><span class="nx">value</span><span class="o">=</span><span class="nx">object</span><span class="p">[</span><span class="nx">property</span><span class="p">]}</span><span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">){}</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">&amp;&amp;</span><span class="nx">value</span><span class="p">){</span><span class="nx">className</span><span class="o">=</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">className</span><span class="o">==</span><span class="nx">dateClass</span><span class="o">&amp;&amp;!</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="s2">&quot;toJSON&quot;</span><span class="p">)){</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">&gt;-</span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">&amp;&amp;</span><span class="nx">value</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">getDay</span><span class="p">){</span><span class="nx">date</span><span class="o">=</span><span class="nx">floor</span><span class="p">(</span><span class="nx">value</span><span class="o">/</span><span class="mi">864</span><span class="nx">e5</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="nx">year</span><span class="o">=</span><span class="nx">floor</span><span class="p">(</span><span class="nx">date</span><span class="o">/</span><span class="mf">365.2425</span><span class="p">)</span><span class="o">+</span><span class="mi">1970</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="nx">getDay</span><span class="p">(</span><span class="nx">year</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">&lt;=</span><span class="nx">date</span><span class="p">;</span><span class="nx">year</span><span class="o">++</span><span class="p">);</span><span class="k">for</span><span class="p">(</span><span class="nx">month</span><span class="o">=</span><span class="nx">floor</span><span class="p">((</span><span class="nx">date</span><span class="o">-</span><span class="nx">getDay</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="mf">30.42</span><span class="p">);</span><span class="nx">getDay</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span><span class="nx">month</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;=</span><span class="nx">date</span><span class="p">;</span><span class="nx">month</span><span class="o">++</span><span class="p">);</span><span class="nx">date</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="nx">date</span><span class="o">-</span><span class="nx">getDay</span><span class="p">(</span><span class="nx">year</span><span class="p">,</span><span class="nx">month</span><span class="p">);</span><span class="nx">time</span><span class="o">=</span><span class="p">(</span><span class="nx">value</span><span class="o">%</span><span class="mi">864</span><span class="nx">e5</span><span class="o">+</span><span class="mi">864</span><span class="nx">e5</span><span class="p">)</span><span class="o">%</span><span class="mi">864</span><span class="nx">e5</span><span class="p">;</span><span class="nx">hours</span><span class="o">=</span><span class="nx">floor</span><span class="p">(</span><span class="nx">time</span><span class="o">/</span><span class="mi">36</span><span class="nx">e5</span><span class="p">)</span><span class="o">%</span><span class="mi">24</span><span class="p">;</span><span class="nx">minutes</span><span class="o">=</span><span class="nx">floor</span><span class="p">(</span><span class="nx">time</span><span class="o">/</span><span class="mi">6</span><span class="nx">e4</span><span class="p">)</span><span class="o">%</span><span class="mi">60</span><span class="p">;</span><span class="nx">seconds</span><span class="o">=</span><span class="nx">floor</span><span class="p">(</span><span class="nx">time</span><span class="o">/</span><span class="mi">1</span><span class="nx">e3</span><span class="p">)</span><span class="o">%</span><span class="mi">60</span><span class="p">;</span><span class="nx">milliseconds</span><span class="o">=</span><span class="nx">time</span><span class="o">%</span><span class="mi">1</span><span class="nx">e3</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">year</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">getUTCFullYear</span><span class="p">();</span><span class="nx">month</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">getUTCMonth</span><span class="p">();</span><span class="nx">date</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">getUTCDate</span><span class="p">();</span><span class="nx">hours</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">getUTCHours</span><span class="p">();</span><span class="nx">minutes</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">getUTCMinutes</span><span class="p">();</span><span class="nx">seconds</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">getUTCSeconds</span><span class="p">();</span><span class="nx">milliseconds</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">getUTCMilliseconds</span><span class="p">()}</span><span class="nx">value</span><span class="o">=</span><span class="p">(</span><span class="nx">year</span><span class="o">&lt;=</span><span class="mi">0</span><span class="o">||</span><span class="nx">year</span><span class="o">&gt;=</span><span class="mi">1</span><span class="nx">e4</span><span class="o">?</span><span class="p">(</span><span class="nx">year</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">?</span><span class="s2">&quot;-&quot;</span><span class="o">:</span><span class="s2">&quot;+&quot;</span><span class="p">)</span><span class="o">+</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="nx">year</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">?-</span><span class="nx">year</span><span class="o">:</span><span class="nx">year</span><span class="p">)</span><span class="o">:</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="nx">year</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">month</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">date</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;T&quot;</span><span class="o">+</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">hours</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">minutes</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">seconds</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="nx">toPaddedString</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="nx">milliseconds</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;Z&quot;</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">value</span><span class="o">=</span><span class="kc">null</span><span class="p">}}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">className</span><span class="o">!=</span><span class="nx">numberClass</span><span class="o">&amp;&amp;</span><span class="nx">className</span><span class="o">!=</span><span class="nx">stringClass</span><span class="o">&amp;&amp;</span><span class="nx">className</span><span class="o">!=</span><span class="nx">arrayClass</span><span class="o">||</span><span class="nx">isProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="s2">&quot;toJSON&quot;</span><span class="p">))){</span><span class="nx">value</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">property</span><span class="p">)}}</span><span class="k">if</span><span class="p">(</span><span class="nx">callback</span><span class="p">){</span><span class="nx">value</span><span class="o">=</span><span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">object</span><span class="p">,</span><span class="nx">property</span><span class="p">,</span><span class="nx">value</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">===</span><span class="kc">null</span><span class="p">){</span><span class="k">return</span><span class="s2">&quot;null&quot;</span><span class="p">}</span><span class="nx">className</span><span class="o">=</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">className</span><span class="o">==</span><span class="nx">booleanClass</span><span class="p">){</span><span class="k">return</span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="nx">value</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">className</span><span class="o">==</span><span class="nx">numberClass</span><span class="p">){</span><span class="k">return</span> <span class="nx">value</span><span class="o">&gt;-</span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">&amp;&amp;</span><span class="nx">value</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">?</span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="nx">value</span><span class="o">:</span><span class="s2">&quot;null&quot;</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">className</span><span class="o">==</span><span class="nx">stringClass</span><span class="p">){</span><span class="k">return</span> <span class="nx">quote</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="nx">value</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="nx">length</span><span class="o">=</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">length</span><span class="o">--</span><span class="p">;){</span><span class="k">if</span><span class="p">(</span><span class="nx">stack</span><span class="p">[</span><span class="nx">length</span><span class="p">]</span><span class="o">===</span><span class="nx">value</span><span class="p">){</span><span class="k">throw</span> <span class="nx">TypeError</span><span class="p">()}}</span><span class="nx">stack</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span><span class="nx">results</span><span class="o">=</span><span class="p">[];</span><span class="nx">prefix</span><span class="o">=</span><span class="nx">indentation</span><span class="p">;</span><span class="nx">indentation</span><span class="o">+=</span><span class="nx">whitespace</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">className</span><span class="o">==</span><span class="nx">arrayClass</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="nx">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">length</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">index</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">;</span><span class="nx">index</span><span class="o">++</span><span class="p">){</span><span class="nx">element</span><span class="o">=</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="nx">value</span><span class="p">,</span><span class="nx">callback</span><span class="p">,</span><span class="nx">properties</span><span class="p">,</span><span class="nx">whitespace</span><span class="p">,</span><span class="nx">indentation</span><span class="p">,</span><span class="nx">stack</span><span class="p">);</span><span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">element</span><span class="o">===</span><span class="nx">undef</span><span class="o">?</span><span class="s2">&quot;null&quot;</span><span class="o">:</span><span class="nx">element</span><span class="p">)}</span><span class="nx">result</span><span class="o">=</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span><span class="nx">whitespace</span><span class="o">?</span><span class="s2">&quot;[\n&quot;</span><span class="o">+</span><span class="nx">indentation</span><span class="o">+</span><span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,\n&quot;</span><span class="o">+</span><span class="nx">indentation</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;\n&quot;</span><span class="o">+</span><span class="nx">prefix</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="o">:</span><span class="s2">&quot;[&quot;</span><span class="o">+</span><span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;]&quot;</span><span class="o">:</span><span class="s2">&quot;[]&quot;</span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">properties</span><span class="o">||</span><span class="nx">value</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">){</span><span class="kd">var</span> <span class="nx">element</span><span class="o">=</span><span class="nx">serialize</span><span class="p">(</span><span class="nx">property</span><span class="p">,</span><span class="nx">value</span><span class="p">,</span><span class="nx">callback</span><span class="p">,</span><span class="nx">properties</span><span class="p">,</span><span class="nx">whitespace</span><span class="p">,</span><span class="nx">indentation</span><span class="p">,</span><span class="nx">stack</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="o">!==</span><span class="nx">undef</span><span class="p">){</span><span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">quote</span><span class="p">(</span><span class="nx">property</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="p">(</span><span class="nx">whitespace</span><span class="o">?</span><span class="s2">&quot; &quot;</span><span class="o">:</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">+</span><span class="nx">element</span><span class="p">)}});</span><span class="nx">result</span><span class="o">=</span><span class="nx">results</span><span class="p">.</span><span class="nx">length</span><span class="o">?</span><span class="nx">whitespace</span><span class="o">?</span><span class="s2">&quot;{\n&quot;</span><span class="o">+</span><span class="nx">indentation</span><span class="o">+</span><span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,\n&quot;</span><span class="o">+</span><span class="nx">indentation</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;\n&quot;</span><span class="o">+</span><span class="nx">prefix</span><span class="o">+</span><span class="s2">&quot;}&quot;</span><span class="o">:</span><span class="s2">&quot;{&quot;</span><span class="o">+</span><span class="nx">results</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;}&quot;</span><span class="o">:</span><span class="s2">&quot;{}&quot;</span><span class="p">}</span><span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span><span class="k">return</span> <span class="nx">result</span><span class="p">}};</span><span class="nx">JSON3</span><span class="p">.</span><span class="nx">stringify</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span><span class="nx">filter</span><span class="p">,</span><span class="nx">width</span><span class="p">){</span><span class="kd">var</span> <span class="nx">whitespace</span><span class="p">,</span><span class="nx">callback</span><span class="p">,</span><span class="nx">properties</span><span class="p">,</span><span class="nx">className</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">filter</span><span class="o">==</span><span class="s2">&quot;function&quot;</span><span class="o">||</span><span class="k">typeof</span> <span class="nx">filter</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">&amp;&amp;</span><span class="nx">filter</span><span class="p">){</span><span class="k">if</span><span class="p">((</span><span class="nx">className</span><span class="o">=</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">filter</span><span class="p">))</span><span class="o">==</span><span class="nx">functionClass</span><span class="p">){</span><span class="nx">callback</span><span class="o">=</span><span class="nx">filter</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">className</span><span class="o">==</span><span class="nx">arrayClass</span><span class="p">){</span><span class="nx">properties</span><span class="o">=</span><span class="p">{};</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">index</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">length</span><span class="o">=</span><span class="nx">filter</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="nx">value</span><span class="p">;</span><span class="nx">index</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">;</span><span class="nx">value</span><span class="o">=</span><span class="nx">filter</span><span class="p">[</span><span class="nx">index</span><span class="o">++</span><span class="p">],(</span><span class="nx">className</span><span class="o">=</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">),</span><span class="nx">className</span><span class="o">==</span><span class="nx">stringClass</span><span class="o">||</span><span class="nx">className</span><span class="o">==</span><span class="nx">numberClass</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">properties</span><span class="p">[</span><span class="nx">value</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="p">));}}</span><span class="k">if</span><span class="p">(</span><span class="nx">width</span><span class="p">){</span><span class="k">if</span><span class="p">((</span><span class="nx">className</span><span class="o">=</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">width</span><span class="p">))</span><span class="o">==</span><span class="nx">numberClass</span><span class="p">){</span><span class="k">if</span><span class="p">((</span><span class="nx">width</span><span class="o">-=</span><span class="nx">width</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="nx">whitespace</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nx">width</span><span class="o">&gt;</span><span class="mi">10</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">width</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span><span class="nx">whitespace</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;</span><span class="nx">width</span><span class="p">;</span><span class="nx">whitespace</span><span class="o">+=</span><span class="s2">&quot; &quot;</span><span class="p">);}}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">className</span><span class="o">==</span><span class="nx">stringClass</span><span class="p">){</span><span class="nx">whitespace</span><span class="o">=</span><span class="nx">width</span><span class="p">.</span><span class="nx">length</span><span class="o">&lt;=</span><span class="mi">10</span><span class="o">?</span><span class="nx">width</span><span class="o">:</span><span class="nx">width</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)}}</span><span class="k">return</span> <span class="nx">serialize</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,(</span><span class="nx">value</span><span class="o">=</span><span class="p">{},</span><span class="nx">value</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">=</span><span class="nx">source</span><span class="p">,</span><span class="nx">value</span><span class="p">),</span><span class="nx">callback</span><span class="p">,</span><span class="nx">properties</span><span class="p">,</span><span class="nx">whitespace</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">,[])}}</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">has</span><span class="p">(</span><span class="s2">&quot;json-parse&quot;</span><span class="p">)){</span><span class="kd">var</span> <span class="nx">fromCharCode</span><span class="o">=</span><span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">;</span><span class="kd">var</span> <span class="nx">Unescapes</span><span class="o">=</span><span class="p">{</span><span class="mi">92</span><span class="o">:</span><span class="s2">&quot;\\&quot;</span><span class="p">,</span><span class="mi">34</span><span class="o">:</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span><span class="mi">47</span><span class="o">:</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="mi">98</span><span class="o">:</span><span class="s2">&quot;\b&quot;</span><span class="p">,</span><span class="mi">116</span><span class="o">:</span><span class="s2">&quot;  &quot;</span><span class="p">,</span><span class="mi">110</span><span class="o">:</span><span class="s2">&quot;\n&quot;</span><span class="p">,</span><span class="mi">102</span><span class="o">:</span><span class="s2">&quot;\f&quot;</span><span class="p">,</span><span class="mi">114</span><span class="o">:</span><span class="s2">&quot;\r&quot;</span><span class="p">};</span><span class="kd">var</span> <span class="nx">Index</span><span class="p">,</span><span class="nx">Source</span><span class="p">;</span><span class="kd">var</span> <span class="nx">abort</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="nx">Index</span><span class="o">=</span><span class="nx">Source</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">throw</span> <span class="nx">SyntaxError</span><span class="p">()};</span><span class="kd">var</span> <span class="nx">lex</span><span class="o">=</span><span class="kd">function</span><span class="p">(){</span><span class="kd">var</span> <span class="nx">source</span><span class="o">=</span><span class="nx">Source</span><span class="p">,</span><span class="nx">length</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="nx">value</span><span class="p">,</span><span class="nx">begin</span><span class="p">,</span><span class="nx">position</span><span class="p">,</span><span class="nx">isSigned</span><span class="p">,</span><span class="nx">charCode</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="nx">Index</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">){</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span><span class="k">switch</span><span class="p">(</span><span class="nx">charCode</span><span class="p">){</span><span class="k">case</span> <span class="mi">9</span><span class="o">:</span><span class="k">case</span> <span class="mi">10</span><span class="o">:</span><span class="k">case</span> <span class="mi">13</span><span class="o">:</span><span class="k">case</span> <span class="mi">32</span><span class="o">:</span><span class="nx">Index</span><span class="o">++</span><span class="p">;</span><span class="k">break</span><span class="p">;</span><span class="k">case</span> <span class="mi">123</span><span class="o">:</span><span class="k">case</span> <span class="mi">125</span><span class="o">:</span><span class="k">case</span> <span class="mi">91</span><span class="o">:</span><span class="k">case</span> <span class="mi">93</span><span class="o">:</span><span class="k">case</span> <span class="mi">58</span><span class="o">:</span><span class="k">case</span> <span class="mi">44</span><span class="o">:</span><span class="nx">value</span><span class="o">=</span><span class="nx">charIndexBuggy</span><span class="o">?</span><span class="nx">source</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">)</span><span class="o">:</span><span class="nx">source</span><span class="p">[</span><span class="nx">Index</span><span class="p">];</span><span class="nx">Index</span><span class="o">++</span><span class="p">;</span><span class="k">return</span> <span class="nx">value</span><span class="p">;</span><span class="k">case</span> <span class="mi">34</span><span class="o">:</span><span class="k">for</span><span class="p">(</span><span class="nx">value</span><span class="o">=</span><span class="s2">&quot;@&quot;</span><span class="p">,</span><span class="nx">Index</span><span class="o">++</span><span class="p">;</span><span class="nx">Index</span><span class="o">&lt;</span><span class="nx">length</span><span class="p">;){</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">charCode</span><span class="o">&lt;</span><span class="mi">32</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">charCode</span><span class="o">==</span><span class="mi">92</span><span class="p">){</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="o">++</span><span class="nx">Index</span><span class="p">);</span><span class="k">switch</span><span class="p">(</span><span class="nx">charCode</span><span class="p">){</span><span class="k">case</span> <span class="mi">92</span><span class="o">:</span><span class="k">case</span> <span class="mi">34</span><span class="o">:</span><span class="k">case</span> <span class="mi">47</span><span class="o">:</span><span class="k">case</span> <span class="mi">98</span><span class="o">:</span><span class="k">case</span> <span class="mi">116</span><span class="o">:</span><span class="k">case</span> <span class="mi">110</span><span class="o">:</span><span class="k">case</span> <span class="mi">102</span><span class="o">:</span><span class="k">case</span> <span class="mi">114</span><span class="o">:</span><span class="nx">value</span><span class="o">+=</span><span class="nx">Unescapes</span><span class="p">[</span><span class="nx">charCode</span><span class="p">];</span><span class="nx">Index</span><span class="o">++</span><span class="p">;</span><span class="k">break</span><span class="p">;</span><span class="k">case</span> <span class="mi">117</span><span class="o">:</span><span class="nx">begin</span><span class="o">=++</span><span class="nx">Index</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="nx">position</span><span class="o">=</span><span class="nx">Index</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span><span class="nx">Index</span><span class="o">&lt;</span><span class="nx">position</span><span class="p">;</span><span class="nx">Index</span><span class="o">++</span><span class="p">){</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">charCode</span><span class="o">&gt;=</span><span class="mi">48</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">&lt;=</span><span class="mi">57</span><span class="o">||</span><span class="nx">charCode</span><span class="o">&gt;=</span><span class="mi">97</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">&lt;=</span><span class="mi">102</span><span class="o">||</span><span class="nx">charCode</span><span class="o">&gt;=</span><span class="mi">65</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">&lt;=</span><span class="mi">70</span><span class="p">)){</span><span class="nx">abort</span><span class="p">()}}</span><span class="nx">value</span><span class="o">+=</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span><span class="o">+</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span><span class="nx">Index</span><span class="p">));</span><span class="k">break</span><span class="p">;</span><span class="k">default</span><span class="o">:</span><span class="nx">abort</span><span class="p">()}}</span><span class="k">else</span><span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="nx">charCode</span><span class="o">==</span><span class="mi">34</span><span class="p">){</span><span class="k">break</span><span class="p">}</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span><span class="nx">begin</span><span class="o">=</span><span class="nx">Index</span><span class="p">;</span><span class="k">while</span><span class="p">(</span><span class="nx">charCode</span><span class="o">&gt;=</span><span class="mi">32</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">!=</span><span class="mi">92</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">!=</span><span class="mi">34</span><span class="p">){</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="o">++</span><span class="nx">Index</span><span class="p">)}</span><span class="nx">value</span><span class="o">+=</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span><span class="nx">Index</span><span class="p">)}}</span><span class="k">if</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">)</span><span class="o">==</span><span class="mi">34</span><span class="p">){</span><span class="nx">Index</span><span class="o">++</span><span class="p">;</span><span class="k">return</span> <span class="nx">value</span><span class="p">}</span><span class="nx">abort</span><span class="p">();</span><span class="k">default</span><span class="o">:</span><span class="nx">begin</span><span class="o">=</span><span class="nx">Index</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">charCode</span><span class="o">==</span><span class="mi">45</span><span class="p">){</span><span class="nx">isSigned</span><span class="o">=</span><span class="kc">true</span><span class="p">;</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="o">++</span><span class="nx">Index</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">charCode</span><span class="o">&gt;=</span><span class="mi">48</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">&lt;=</span><span class="mi">57</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">charCode</span><span class="o">==</span><span class="mi">48</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="nx">charCode</span><span class="o">&gt;=</span><span class="mi">48</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">&lt;=</span><span class="mi">57</span><span class="p">)){</span><span class="nx">abort</span><span class="p">()}</span><span class="nx">isSigned</span><span class="o">=</span><span class="kc">false</span><span class="p">;</span><span class="k">for</span><span class="p">(;</span><span class="nx">Index</span><span class="o">&lt;</span><span class="nx">length</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">),</span><span class="nx">charCode</span><span class="o">&gt;=</span><span class="mi">48</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">&lt;=</span><span class="mi">57</span><span class="p">);</span><span class="nx">Index</span><span class="o">++</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">)</span><span class="o">==</span><span class="mi">46</span><span class="p">){</span><span class="nx">position</span><span class="o">=++</span><span class="nx">Index</span><span class="p">;</span><span class="k">for</span><span class="p">(;</span><span class="nx">position</span><span class="o">&lt;</span><span class="nx">length</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">position</span><span class="p">),</span><span class="nx">charCode</span><span class="o">&gt;=</span><span class="mi">48</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">&lt;=</span><span class="mi">57</span><span class="p">);</span><span class="nx">position</span><span class="o">++</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">position</span><span class="o">==</span><span class="nx">Index</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}</span><span class="nx">Index</span><span class="o">=</span><span class="nx">position</span><span class="p">}</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">Index</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">charCode</span><span class="o">==</span><span class="mi">101</span><span class="o">||</span><span class="nx">charCode</span><span class="o">==</span><span class="mi">69</span><span class="p">){</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="o">++</span><span class="nx">Index</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">charCode</span><span class="o">==</span><span class="mi">43</span><span class="o">||</span><span class="nx">charCode</span><span class="o">==</span><span class="mi">45</span><span class="p">){</span><span class="nx">Index</span><span class="o">++</span><span class="p">}</span><span class="k">for</span><span class="p">(</span><span class="nx">position</span><span class="o">=</span><span class="nx">Index</span><span class="p">;</span><span class="nx">position</span><span class="o">&lt;</span><span class="nx">length</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="nx">charCode</span><span class="o">=</span><span class="nx">source</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">position</span><span class="p">),</span><span class="nx">charCode</span><span class="o">&gt;=</span><span class="mi">48</span><span class="o">&amp;&amp;</span><span class="nx">charCode</span><span class="o">&lt;=</span><span class="mi">57</span><span class="p">);</span><span class="nx">position</span><span class="o">++</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">position</span><span class="o">==</span><span class="nx">Index</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}</span><span class="nx">Index</span><span class="o">=</span><span class="nx">position</span><span class="p">}</span><span class="k">return</span><span class="o">+</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">begin</span><span class="p">,</span><span class="nx">Index</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">isSigned</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}</span><span class="k">if</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">Index</span><span class="p">,</span><span class="nx">Index</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;true&quot;</span><span class="p">){</span><span class="nx">Index</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span><span class="k">return</span> <span class="kc">true</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">Index</span><span class="p">,</span><span class="nx">Index</span><span class="o">+</span><span class="mi">5</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;false&quot;</span><span class="p">){</span><span class="nx">Index</span><span class="o">+=</span><span class="mi">5</span><span class="p">;</span><span class="k">return</span> <span class="kc">false</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">source</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">Index</span><span class="p">,</span><span class="nx">Index</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;null&quot;</span><span class="p">){</span><span class="nx">Index</span><span class="o">+=</span><span class="mi">4</span><span class="p">;</span><span class="k">return</span> <span class="kc">null</span><span class="p">}</span><span class="nx">abort</span><span class="p">()}}</span><span class="k">return</span><span class="s2">&quot;$&quot;</span><span class="p">};</span><span class="kd">var</span> <span class="nx">get</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">){</span><span class="kd">var</span> <span class="nx">results</span><span class="p">,</span><span class="nx">hasMembers</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;$&quot;</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span><span class="o">==</span><span class="s2">&quot;string&quot;</span><span class="p">){</span><span class="k">if</span><span class="p">((</span><span class="nx">charIndexBuggy</span><span class="o">?</span><span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="s2">&quot;@&quot;</span><span class="p">){</span><span class="k">return</span> <span class="nx">value</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)}</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;[&quot;</span><span class="p">){</span><span class="nx">results</span><span class="o">=</span><span class="p">[];</span><span class="k">for</span><span class="p">(;;</span><span class="nx">hasMembers</span><span class="o">||</span><span class="p">(</span><span class="nx">hasMembers</span><span class="o">=</span><span class="kc">true</span><span class="p">)){</span><span class="nx">value</span><span class="o">=</span><span class="nx">lex</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;]&quot;</span><span class="p">){</span><span class="k">break</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">hasMembers</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;,&quot;</span><span class="p">){</span><span class="nx">value</span><span class="o">=</span><span class="nx">lex</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;]&quot;</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}}</span><span class="k">else</span><span class="p">{</span><span class="nx">abort</span><span class="p">()}}</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;,&quot;</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}</span><span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">get</span><span class="p">(</span><span class="nx">value</span><span class="p">))}</span><span class="k">return</span> <span class="nx">results</span><span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;{&quot;</span><span class="p">){</span><span class="nx">results</span><span class="o">=</span><span class="p">{};</span><span class="k">for</span><span class="p">(;;</span><span class="nx">hasMembers</span><span class="o">||</span><span class="p">(</span><span class="nx">hasMembers</span><span class="o">=</span><span class="kc">true</span><span class="p">)){</span><span class="nx">value</span><span class="o">=</span><span class="nx">lex</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;}&quot;</span><span class="p">){</span><span class="k">break</span><span class="p">}</span><span class="k">if</span><span class="p">(</span><span class="nx">hasMembers</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;,&quot;</span><span class="p">){</span><span class="nx">value</span><span class="o">=</span><span class="nx">lex</span><span class="p">();</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;}&quot;</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}}</span><span class="k">else</span><span class="p">{</span><span class="nx">abort</span><span class="p">()}}</span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="o">==</span><span class="s2">&quot;,&quot;</span><span class="o">||</span><span class="k">typeof</span> <span class="nx">value</span><span class="o">!=</span><span class="s2">&quot;string&quot;</span><span class="o">||</span><span class="p">(</span><span class="nx">charIndexBuggy</span><span class="o">?</span><span class="nx">value</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">:</span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">!=</span><span class="s2">&quot;@&quot;</span><span class="o">||</span><span class="nx">lex</span><span class="p">()</span><span class="o">!=</span><span class="s2">&quot;:&quot;</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}</span><span class="nx">results</span><span class="p">[</span><span class="nx">value</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">1</span><span class="p">)]</span><span class="o">=</span><span class="nx">get</span><span class="p">(</span><span class="nx">lex</span><span class="p">())}</span><span class="k">return</span> <span class="nx">results</span><span class="p">}</span><span class="nx">abort</span><span class="p">()}</span><span class="k">return</span> <span class="nx">value</span><span class="p">};</span><span class="kd">var</span> <span class="nx">update</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span><span class="nx">property</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">var</span> <span class="nx">element</span><span class="o">=</span><span class="nx">walk</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span><span class="nx">property</span><span class="p">,</span><span class="nx">callback</span><span class="p">);</span><span class="k">if</span><span class="p">(</span><span class="nx">element</span><span class="o">===</span><span class="nx">undef</span><span class="p">){</span><span class="k">delete</span> <span class="nx">source</span><span class="p">[</span><span class="nx">property</span><span class="p">]}</span><span class="k">else</span><span class="p">{</span><span class="nx">source</span><span class="p">[</span><span class="nx">property</span><span class="p">]</span><span class="o">=</span><span class="nx">element</span><span class="p">}};</span><span class="kd">var</span> <span class="nx">walk</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span><span class="nx">property</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">var</span> <span class="nx">value</span><span class="o">=</span><span class="nx">source</span><span class="p">[</span><span class="nx">property</span><span class="p">],</span><span class="nx">length</span><span class="p">;</span><span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">value</span><span class="o">==</span><span class="s2">&quot;object&quot;</span><span class="o">&amp;&amp;</span><span class="nx">value</span><span class="p">){</span><span class="k">if</span><span class="p">(</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span><span class="o">==</span><span class="nx">arrayClass</span><span class="p">){</span><span class="k">for</span><span class="p">(</span><span class="nx">length</span><span class="o">=</span><span class="nx">value</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">length</span><span class="o">--</span><span class="p">;){</span><span class="nx">update</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">length</span><span class="p">,</span><span class="nx">callback</span><span class="p">)}}</span><span class="k">else</span><span class="p">{</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">property</span><span class="p">){</span><span class="nx">update</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span><span class="nx">property</span><span class="p">,</span><span class="nx">callback</span><span class="p">)})}}</span><span class="k">return</span> <span class="nx">callback</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span><span class="nx">property</span><span class="p">,</span><span class="nx">value</span><span class="p">)};</span><span class="nx">JSON3</span><span class="p">.</span><span class="nx">parse</span><span class="o">=</span><span class="kd">function</span><span class="p">(</span><span class="nx">source</span><span class="p">,</span><span class="nx">callback</span><span class="p">){</span><span class="kd">var</span> <span class="nx">result</span><span class="p">,</span><span class="nx">value</span><span class="p">;</span><span class="nx">Index</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">Source</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">+</span><span class="nx">source</span><span class="p">;</span><span class="nx">result</span><span class="o">=</span><span class="nx">get</span><span class="p">(</span><span class="nx">lex</span><span class="p">());</span><span class="k">if</span><span class="p">(</span><span class="nx">lex</span><span class="p">()</span><span class="o">!=</span><span class="s2">&quot;$&quot;</span><span class="p">){</span><span class="nx">abort</span><span class="p">()}</span><span class="nx">Index</span><span class="o">=</span><span class="nx">Source</span><span class="o">=</span><span class="kc">null</span><span class="p">;</span><span class="k">return</span> <span class="nx">callback</span><span class="o">&amp;&amp;</span><span class="nx">getClass</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span><span class="o">==</span><span class="nx">functionClass</span><span class="o">?</span><span class="nx">walk</span><span class="p">((</span><span class="nx">value</span><span class="o">=</span><span class="p">{},</span><span class="nx">value</span><span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">=</span><span class="nx">result</span><span class="p">,</span><span class="nx">value</span><span class="p">),</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nx">callback</span><span class="p">)</span><span class="o">:</span><span class="nx">result</span><span class="p">}}}</span><span class="k">if</span><span class="p">(</span><span class="nx">isLoader</span><span class="p">){</span><span class="nx">define</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">JSON3</span><span class="p">})}})(</span><span class="k">this</span><span class="p">)},{}],</span><span class="mi">47</span><span class="o">:</span><span class="p">[</span><span class="kd">function</span><span class="p">(</span><span class="nx">_dereq_</span><span class="p">,</span><span class="nx">module</span><span class="p">,</span><span class="nx">exports</span><span class="p">){</span><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="o">=</span><span class="nx">toArray</span><span class="p">;</span><span class="kd">function</span> <span class="nx">toArray</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span><span class="nx">index</span><span class="p">){</span><span class="kd">var</span> <span class="nx">array</span><span class="o">=</span><span class="p">[];</span><span class="nx">index</span><span class="o">=</span><span class="nx">index</span><span class="o">||</span><span class="mi">0</span><span class="p">;</span><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="nx">index</span><span class="o">||</span><span class="mi">0</span><span class="p">;</span><span class="nx">i</span><span class="o">&lt;</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span><span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="o">-</span><span class="nx">index</span><span class="p">]</span><span class="o">=</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]}</span><span class="k">return</span> <span class="nx">array</span><span class="p">}},{}]},{},[</span><span class="mi">1</span><span class="p">])(</span><span class="mi">1</span><span class="p">)});</span>
<span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs"><div class="dox">
  <div class="summary">
<div class="pilwrap" id="sails.io.js">
  <h2>
    <a href="#sails.io.js" name="sails.io.js" class="pilcrow">&#182;</a>
    sails.io.js
  </h2>
</div>


<p>JavaScript Client (SDK) for communicating with Sails.</p>
  </div>
  <div class="body"><p>Note that this script is completely optional, but it is handy if you're
using WebSockets from the browser to talk to your Sails server.</p>

<p>For tips and documentation, visit:</p>


<div class="pilwrap" id="http%3A%2F%2Fsailsjs.org%2F%23!documentation%2Freference%2Fbrowsersdk%2Fbrowsersdk.html">
  <h2>
    <a href="#http%3A%2F%2Fsailsjs.org%2F%23!documentation%2Freference%2Fbrowsersdk%2Fbrowsersdk.html" name="http%3A%2F%2Fsailsjs.org%2F%23!documentation%2Freference%2Fbrowsersdk%2Fbrowsersdk.html" class="pilcrow">&#182;</a>
    <a href='http://sailsjs.org/#!documentation/reference/BrowserSDK/BrowserSDK.html'>http://sailsjs.org/#!documentation/reference/BrowserSDK/BrowserSDK.html</a>
  </h2>
</div>


<p>This file allows you to send and receive socket.io messages to &amp; from Sails
by simulating a REST client interface on top of socket.io. It models its API
after the $.ajax pattern from jQuery you might already be familiar with.</p>

<p>So if you're switching from using AJAX to sockets, instead of:
   <code>$.post( url, [data], [cb] )</code></p>

<p>You would use:
   <code>socket.post( url, [data], [cb] )</code></p>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>Save the URL that this script was fetched from for use below.
(skip this if this SDK is being used outside of the DOM, i.e. in a Node process)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">urlThisScriptWasFetchedFrom</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span>
      <span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span>
      <span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span>
    <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Return the URL of the last script loaded (i.e. this one)
(this must run before nextTick; see <a href='http://stackoverflow.com/a/2976714/486547'>http://stackoverflow.com/a/2976714/486547</a>)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">allScriptsCurrentlyInDOM</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">thisScript</span> <span class="o">=</span> <span class="nx">allScriptsCurrentlyInDOM</span><span class="p">[</span><span class="nx">allScriptsCurrentlyInDOM</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
    <span class="k">return</span> <span class="nx">thisScript</span><span class="p">.</span><span class="nx">src</span><span class="p">;</span>
  <span class="p">})();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Constants</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">CONNECTION_METADATA_PARAMS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;__sails_io_sdk_version&#39;</span><span class="p">,</span>
    <span class="nx">platform</span><span class="o">:</span> <span class="s1">&#39;__sails_io_sdk_platform&#39;</span><span class="p">,</span>
    <span class="nx">language</span><span class="o">:</span> <span class="s1">&#39;__sails_io_sdk_language&#39;</span>
  <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6">&#182;</a>
</div>
<p>Current version of this SDK (sailsDK?!?!) and other metadata
that will be sent along w/ the initial connection request.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">SDK_INFO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;0.11.0&#39;</span><span class="p">,</span> <span class="c1">// TODO: pull this automatically from package.json during build.</span>
    <span class="nx">platform</span><span class="o">:</span> <span class="k">typeof</span> <span class="nx">module</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="s1">&#39;browser&#39;</span> <span class="o">:</span> <span class="s1">&#39;node&#39;</span><span class="p">,</span>
    <span class="nx">language</span><span class="o">:</span> <span class="s1">&#39;javascript&#39;</span>
  <span class="p">};</span>
  <span class="nx">SDK_INFO</span><span class="p">.</span><span class="nx">versionString</span> <span class="o">=</span>
    <span class="nx">CONNECTION_METADATA_PARAMS</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">SDK_INFO</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span>
    <span class="nx">CONNECTION_METADATA_PARAMS</span><span class="p">.</span><span class="nx">platform</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">SDK_INFO</span><span class="p">.</span><span class="nx">platform</span> <span class="o">+</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span>
    <span class="nx">CONNECTION_METADATA_PARAMS</span><span class="p">.</span><span class="nx">language</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">SDK_INFO</span><span class="p">.</span><span class="nx">language</span><span class="p">;</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>In case you're wrapping the socket.io client to prevent pollution of the
global namespace, you can pass in your own <code>io</code> to replace the global one.
But we still grab access to the global one if it's available here:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="kd">var</span> <span class="nx">_io</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">io</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="nx">io</span> <span class="o">:</span> <span class="kc">null</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Augment the <code>io</code> object passed in with methods for talking and listening
to one or more Sails backend(s).  Automatically connects a socket and
exposes it on <code>io.socket</code>.  If a socket tries to make requests before it
is connected, the sails.io.js client will queue it up.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">io
</span>
      <span class="dox_type">SocketIO</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="kd">function</span> <span class="nx">SailsIOClient</span><span class="p">(</span><span class="nx">io</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Prefer the passed-in <code>io</code> instance, but also use the global one if we've got it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">io</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">io</span> <span class="o">=</span> <span class="nx">_io</span><span class="p">;</span>
    <span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>If the socket.io client is not available, none of this will work.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">io</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;`sails.io.js` requires a socket.io client, but `io` was not passed in.&#39;</span><span class="p">);</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>////////////////////////////////////////////////////////////
///                              ///////////////////////////
/// PRIVATE METHODS/CONSTRUCTORS ///////////////////////////
///                              ///////////////////////////
////////////////////////////////////////////////////////////</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>A little logger for this library to use internally.
Basically just a wrapper around <code>console.log</code> with
support for feature-detection.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private</span>
    </div>
    <div class="dox_tag_title">factory
</div>


<div class="highlight"><pre><code><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;dox_tag_detail&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="err">/div&gt;</span>
</code></pre></div>



<p></div>
</div></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">function</span> <span class="nx">LoggerFactory</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">options</span> <span class="o">=</span> <span class="nx">options</span> <span class="o">||</span> <span class="p">{</span>
        <span class="nx">prefix</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>If <code>console.log</code> is not accessible, <code>log</code> is a noop.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span>
        <span class="k">typeof</span> <span class="nx">console</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span>
        <span class="k">typeof</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span> <span class="o">||</span>
        <span class="k">typeof</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">bind</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span>
      <span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span> <span class="nx">noop</span><span class="p">()</span> <span class="p">{};</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="kd">function</span> <span class="nx">log</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>All logs are disabled when <code>io.sails.environment = 'production'</code>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">io</span><span class="p">.</span><span class="nx">sails</span><span class="p">.</span><span class="nx">environment</span> <span class="o">===</span> <span class="s1">&#39;production&#39;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Add prefix to log messages (unless disabled)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">PREFIX</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">prefix</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">args</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="nx">PREFIX</span><span class="p">);</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>Call wrapped logger</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
          <span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">console</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Create a private logger instance</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="kd">var</span> <span class="nx">consolog</span> <span class="o">=</span> <span class="nx">LoggerFactory</span><span class="p">();</span>
    <span class="nx">consolog</span><span class="p">.</span><span class="nx">noPrefix</span> <span class="o">=</span> <span class="nx">LoggerFactory</span><span class="p">({</span>
      <span class="nx">prefix</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">});</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>What is the <code>requestQueue</code>?</p>
  </div>
  <div class="body"><p>The request queue is used to simplify app-level connection logic--
i.e. so you don't have to wait for the socket to be connected
to start trying to  synchronize data.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{SailsSocket}  socket</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="kd">function</span> <span class="nx">runRequestQueue</span> <span class="p">(</span><span class="nx">socket</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">queue</span> <span class="o">=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">requestQueue</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">queue</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">queue</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Double-check that <code>queue[i]</code> will not
inadvertently discover extra properties attached to the Object
and/or Array prototype by other libraries/frameworks/tools.
(e.g. Ember does this. See <a href='https://github.com/balderdashy/sails.io.js/pull/5'>https://github.com/balderdashy/sails.io.js/pull/5</a>)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">isSafeToDereference</span> <span class="o">=</span> <span class="p">({}).</span><span class="nx">hasOwnProperty</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">queue</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">isSafeToDereference</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20">&#182;</a>
</div>
<p>Emit the request.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">_emitFrom</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">queue</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Now empty the queue to remove it as a source of additional complexity.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">queue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Send a JSONP request.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Object}   opts [optional]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Function} cb</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">XMLHttpRequest
</span>
      <span>{XMLHttpRequest}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="kd">function</span> <span class="nx">jsonp</span><span class="p">(</span><span class="nx">opts</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>

      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>TODO: refactor node usage to live in here</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">return</span> <span class="nx">cb</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">scriptEl</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">_sailsIoJSConnect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">scriptEl</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">scriptEl</span><span class="p">);</span>
        
        <span class="nx">cb</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
      <span class="p">};</span>
      <span class="nx">scriptEl</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">scriptEl</span><span class="p">);</span>

    <span class="p">}</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>The JWR (JSON WebSocket Response) received from a Sails server.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Object}  responseCtx
        => :body
        => :statusCode
        => :headers</span>
    </div>
    <div class="dox_tag_title">constructor
</div>


<div class="highlight"><pre><code><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;dox_tag_detail&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="err">/div&gt;</span>
</code></pre></div>



<p></div>
</div></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="kd">function</span> <span class="nx">JWR</span><span class="p">(</span><span class="nx">responseCtx</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">=</span> <span class="nx">responseCtx</span><span class="p">.</span><span class="nx">body</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nx">responseCtx</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="p">{};</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">=</span> <span class="nx">responseCtx</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">||</span> <span class="mi">200</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">&gt;=</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">error</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span> <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">JWR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toString</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="s1">&#39;[ResponseFromSails]&#39;</span> <span class="o">+</span> <span class="s1">&#39;  -- &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;Status: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">+</span> <span class="s1">&#39;  -- &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;Headers: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span> <span class="o">+</span> <span class="s1">&#39;  -- &#39;</span> <span class="o">+</span>
        <span class="s1">&#39;Body: &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>
    <span class="p">};</span>
    <span class="nx">JWR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toPOJO</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nx">body</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
        <span class="nx">headers</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">,</span>
        <span class="nx">statusCode</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">statusCode</span>
      <span class="p">};</span>
    <span class="p">};</span>
    <span class="nx">JWR</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">pipe</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>TODO: look at substack's stuff</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Client-side streaming support not implemented yet.&#39;</span><span class="p">);</span>
    <span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<div class="dox">
  <div class="summary">
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{SailsSocket} socket  [description]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Object} requestCtx [description]</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="kd">function</span> <span class="nx">_emitFrom</span><span class="p">(</span><span class="nx">socket</span><span class="p">,</span> <span class="nx">requestCtx</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">socket</span><span class="p">.</span><span class="nx">_raw</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Failed to emit from socket- raw SIO socket is missing.&#39;</span><span class="p">);</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>Since callback is embedded in requestCtx,
retrieve it and delete the key before continuing.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">cb</span> <span class="o">=</span> <span class="nx">requestCtx</span><span class="p">.</span><span class="nx">cb</span><span class="p">;</span>
      <span class="k">delete</span> <span class="nx">requestCtx</span><span class="p">.</span><span class="nx">cb</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>Name of the appropriate socket.io listener on the server
( === the request method or "verb", e.g. 'get', 'post', 'put', etc. )</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">sailsEndpoint</span> <span class="o">=</span> <span class="nx">requestCtx</span><span class="p">.</span><span class="nx">method</span><span class="p">;</span>

      <span class="nx">socket</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="nx">sailsEndpoint</span><span class="p">,</span> <span class="nx">requestCtx</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">serverResponded</span><span class="p">(</span><span class="nx">responseCtx</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Send back (emulatedHTTPBody, jsonWebSocketResponse)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">cb</span><span class="p">(</span><span class="nx">responseCtx</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span> <span class="k">new</span> <span class="nx">JWR</span><span class="p">(</span><span class="nx">responseCtx</span><span class="p">));</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>////////////////////////////////////////////////////////////
/// </PRIVATE METHODS/CONSTRUCTORS> ////////////////////////
////////////////////////////////////////////////////////////</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Version note:</p>

<p><code>io.SocketNamespace.prototype</code> doesn't exist in sio 1.0.</p>

<p>Rather than adding methods to the prototype for the Socket instance that is returned
when the browser connects with <code>io.connect()</code>, we create our own constructor, <code>SailsSocket</code>.
This makes our solution more future-proof and helps us work better w/ the Socket.io team
when changes are rolled out in the future.  To get a <code>SailsSocket</code>, you can run:</p>

<div class='highlight'><pre><code language=''>io.sails.connect();
</code></pre></div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>SailsSocket</p>
  </div>
  <div class="body"><p>A wrapper for an underlying Socket instance that communicates directly
to the Socket.io server running inside of Sails.</p>

<p>If no <code>socket</code> option is provied, SailsSocket will function as a mock. It will queue socket
requests and event handler bindings, replaying them when the raw underlying socket actually
connects. This is handy when we don't necessarily have the valid configuration to know
WHICH SERVER to talk to yet, etc.  It is also used by <code>io.socket</code> for your convenience.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">constructor
</div>


<div class="highlight"><pre><code><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;dox_tag_detail&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="err">/div&gt;</span>
</code></pre></div>



<p></div>
</div></p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    
    <span class="kd">function</span> <span class="nx">SailsSocket</span> <span class="p">(</span><span class="nx">opts</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
      <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span><span class="o">||</span><span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>Absorb opts</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">self</span><span class="p">.</span><span class="nx">useCORSRouteToGetCookie</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">useCORSRouteToGetCookie</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">multiplex</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">multiplex</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">transports</span> <span class="o">=</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">transports</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Set up "eventQueue" to hold event handlers which have not been set on the actual raw socket yet.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">self</span><span class="p">.</span><span class="nx">eventQueue</span> <span class="o">=</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Listen for special <code>parseError</code> event sent from sockets hook on the backend
if an error occurs but a valid callback was not received from the client
(i.e. so the server had no other way to send back the error information)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;sails:parseError&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
        <span class="nx">consolog</span><span class="p">(</span><span class="s1">&#39;Sails encountered an error parsing a socket message sent from this client, and did not have access to a callback function to respond with.&#39;</span><span class="p">);</span>
        <span class="nx">consolog</span><span class="p">(</span><span class="s1">&#39;Error details:&#39;</span><span class="p">,</span><span class="nx">err</span><span class="p">);</span>
      <span class="p">});</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>TODO:
Listen for a special private message on any connected that allows the server
to set the environment (giving us 100% certainty that we guessed right)
However, note that the <code>console.log</code>s called before and after connection
are still forced to rely on our existing heuristics (to disable, tack #production
onto the URL used to fetch this file.)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Start connecting this socket.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_connect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>Apply <code>io.sails</code> config as defaults
(now that at least one tick has elapsed)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">self</span><span class="p">.</span><span class="nx">useCORSRouteToGetCookie</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">useCORSRouteToGetCookie</span><span class="o">||</span><span class="nx">io</span><span class="p">.</span><span class="nx">sails</span><span class="p">.</span><span class="nx">useCORSRouteToGetCookie</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span><span class="o">||</span><span class="nx">io</span><span class="p">.</span><span class="nx">sails</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">transports</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">transports</span> <span class="o">||</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sails</span><span class="p">.</span><span class="nx">transports</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>Ensure URL has no trailing slash</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">self</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span> <span class="o">?</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/(\/)$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="kc">undefined</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>Mix the current SDK version into the query string in
the connection request to the server:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">query</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">self</span><span class="p">.</span><span class="nx">query</span> <span class="o">=</span> <span class="nx">SDK_INFO</span><span class="p">.</span><span class="nx">versionString</span><span class="p">;</span>
      <span class="k">else</span> <span class="nx">self</span><span class="p">.</span><span class="nx">query</span> <span class="o">+=</span> <span class="s1">&#39;&amp;&#39;</span> <span class="o">+</span> <span class="nx">SDK_INFO</span><span class="p">.</span><span class="nx">versionString</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>Determine whether this is a cross-origin socket by examining the
hostname and port on the <code>window.location</code> object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">isXOrigin</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(){</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>If <code>window</code> doesn't exist (i.e. being used from node.js), then it's
always "cross-domain".</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>If <code>self.url</code> (aka "target") is falsy, then we don't need to worry about it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="p">}</span>
        

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Get information about the "target" (<code>self.url</code>)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">targetProtocol</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(){</span>
          <span class="k">try</span> <span class="p">{</span>
            <span class="nx">targetProtocol</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^([a-z]+:\/\/)/i</span><span class="p">)[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toLowerCase</span><span class="p">();</span>
          <span class="p">}</span>
          <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{}</span>
          <span class="nx">targetProtocol</span> <span class="o">=</span> <span class="nx">targetProtocol</span> <span class="o">||</span> <span class="s1">&#39;http://&#39;</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">targetProtocol</span><span class="p">;</span>
        <span class="p">})();</span>
        <span class="kd">var</span> <span class="nx">isTargetSSL</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">self</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="s1">&#39;^https&#39;</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">targetPort</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span> <span class="p">(){</span>
          <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^[a-z]+:\/\/[^:]*:([0-9]*)/i</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
          <span class="p">}</span>
          <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">){}</span>
          <span class="k">return</span> <span class="nx">isTargetSSL</span> <span class="o">?</span> <span class="s1">&#39;443&#39;</span> <span class="o">:</span> <span class="s1">&#39;80&#39;</span><span class="p">;</span>
        <span class="p">})();</span>
        <span class="kd">var</span> <span class="nx">targetAfterProtocol</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^([a-z]+:\/\/)/i</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>If target protocol is different than the actual protocol,
then we'll consider this cross-origin.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">targetProtocol</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[:\/]/g</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">!==</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[:\/]/g</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>If target hostname is different than actual hostname, we'll consider this cross-origin.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">hasSameHostname</span> <span class="o">=</span> <span class="nx">targetAfterProtocol</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hostname</span><span class="p">)</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">hasSameHostname</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>If no actual port is explicitly set on the <code>window.location</code> object,
we'll assume either 80 or 443.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">isLocationSSL</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/https/i</span><span class="p">);</span>
        <span class="kd">var</span> <span class="nx">locationPort</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">port</span><span class="o">+</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">isLocationSSL</span> <span class="o">?</span> <span class="s1">&#39;443&#39;</span> <span class="o">:</span> <span class="s1">&#39;80&#39;</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Finally, if ports don't match, we'll consider this cross-origin.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="nx">targetPort</span> <span class="o">!==</span> <span class="nx">locationPort</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-49" id="section-49">&#182;</a>
</div>
<p>Otherwise, it's the same origin.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

      <span class="p">})();</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50">&#182;</a>
</div>
<p>Prepare to start connecting the socket</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">(</span><span class="kd">function</span> <span class="nx">selfInvoking</span> <span class="p">(</span><span class="nx">cb</span><span class="p">){</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>
<p>If this is an attempt at a cross-origin or cross-port
socket connection, send a JSONP request first to ensure
that a valid cookie is available.  This can be disabled
by setting <code>io.sails.useCORSRouteToGetCookie</code> to false.</p>

<p>Otherwise, skip the stuff below.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">useCORSRouteToGetCookie</span> <span class="o">&amp;&amp;</span> <span class="nx">isXOrigin</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">cb</span><span class="p">();</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-52" id="section-52">&#182;</a>
</div>
<p>Figure out the x-origin CORS route
(Sails provides a default)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">xOriginCookieURL</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">self</span><span class="p">.</span><span class="nx">useCORSRouteToGetCookie</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">xOriginCookieURL</span> <span class="o">+=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">useCORSRouteToGetCookie</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="p">{</span>
          <span class="nx">xOriginCookieURL</span> <span class="o">+=</span> <span class="s1">&#39;/__getcookie&#39;</span><span class="p">;</span>
        <span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53">&#182;</a>
</div>
<p>Make the AJAX request (CORS)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">jsonp</span><span class="p">({</span>
            <span class="nx">url</span><span class="o">:</span> <span class="nx">xOriginCookieURL</span><span class="p">,</span>
            <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span>
          <span class="p">},</span> <span class="nx">cb</span><span class="p">);</span>
          <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54">&#182;</a>
</div>
<p>If there's no <code>window</code> object, we must be running in Node.js
so just require the request module and send the HTTP request that
way.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="kd">var</span> <span class="nx">mikealsReq</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">);</span>
        <span class="nx">mikealsReq</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">xOriginCookieURL</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">httpResponse</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">consolog</span><span class="p">(</span>
              <span class="s1">&#39;Failed to connect socket (failed to get cookie)&#39;</span><span class="p">,</span>
              <span class="s1">&#39;Error:&#39;</span><span class="p">,</span> <span class="nx">err</span>
            <span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="nx">cb</span><span class="p">();</span>
        <span class="p">});</span>

      <span class="p">})(</span><span class="kd">function</span> <span class="nx">goAheadAndActuallyConnect</span><span class="p">()</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-55" id="section-55">&#182;</a>
</div>
<p>Now that we're ready to connect, create a raw underlying Socket
using Socket.io and save it as <code>_raw</code> (this will start it connecting)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_raw</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">self</span><span class="p">);</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-56" id="section-56">&#182;</a>
</div>
<p>Replay event bindings from the eager socket</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">self</span><span class="p">.</span><span class="nx">replay</span><span class="p">();</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-57" id="section-57">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>'connect' event is triggered when the socket establishes a connection
 successfully.</p>
  </div>
  <div class="body">
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">socketConnected</span><span class="p">()</span> <span class="p">{</span>

          <span class="nx">consolog</span><span class="p">.</span><span class="nx">noPrefix</span><span class="p">(</span>
            <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-58" id="section-58">&#182;</a>
</div>
<p>'    |>    ' + '\n' +
'  \___/  '+️
'\n'+</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
             <span class="s1">&#39;  |&gt;    Now connected to Sails.&#39;</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;\\___/   For help, see: http://bit.ly/1DmTvgK&#39;</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
             <span class="s1">&#39;        (using &#39;</span><span class="o">+</span><span class="nx">io</span><span class="p">.</span><span class="nx">sails</span><span class="p">.</span><span class="nx">sdk</span><span class="p">.</span><span class="nx">platform</span><span class="o">+</span><span class="s1">&#39; SDK @v&#39;</span><span class="o">+</span><span class="nx">io</span><span class="p">.</span><span class="nx">sails</span><span class="p">.</span><span class="nx">sdk</span><span class="p">.</span><span class="nx">version</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
            <span class="s1">&#39;\n&#39;</span><span class="o">+</span>
            <span class="s1">&#39;\n&#39;</span><span class="o">+</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-59" id="section-59">&#182;</a>
</div>
<p>'\n'+</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
            <span class="s1">&#39;&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-60" id="section-60">&#182;</a>
</div>
<p>' ⚓︎ (development mode)'
'e.g. to send a GET request to Sails via WebSockets, run:'+ '\n' +
'<code>io.socket.get("/foo", function serverRespondedWith (body, jwr) { console.log(body); })</code>'+ '\n' +</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="p">);</span>
        <span class="p">});</span>
        
        <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;disconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">connectionLostTimestamp</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">();</span>
          <span class="nx">consolog</span><span class="p">(</span><span class="s1">&#39;====================================&#39;</span><span class="p">);</span>
          <span class="nx">consolog</span><span class="p">(</span><span class="s1">&#39;Socket was disconnected from Sails.&#39;</span><span class="p">);</span>
          <span class="nx">consolog</span><span class="p">(</span><span class="s1">&#39;Usually, this is due to one of the following reasons:&#39;</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
            <span class="s1">&#39; -&gt; the server &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">url</span> <span class="o">?</span> <span class="nx">self</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;was taken down&#39;</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span>
            <span class="s1">&#39; -&gt; your browser lost internet connectivity&#39;</span><span class="p">);</span>
          <span class="nx">consolog</span><span class="p">(</span><span class="s1">&#39;====================================&#39;</span><span class="p">);</span>
        <span class="p">});</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;reconnecting&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">numAttempts</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">consolog</span><span class="p">(</span>
            <span class="s1">&#39;\n&#39;</span><span class="o">+</span>
            <span class="s1">&#39;        Socket is trying to reconnect to Sails...\n&#39;</span><span class="o">+</span>
            <span class="s1">&#39;_-|&gt;_-  (attempt #&#39;</span> <span class="o">+</span> <span class="nx">numAttempts</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="o">+</span><span class="s1">&#39;\n&#39;</span><span class="o">+</span>
            <span class="s1">&#39;\n&#39;</span>
          <span class="p">);</span>
        <span class="p">});</span>
      
        <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;reconnect&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">transport</span><span class="p">,</span> <span class="nx">numAttempts</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">msSinceConnectionLost</span> <span class="o">=</span> <span class="p">((</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">connectionLostTimestamp</span><span class="p">);</span>
          <span class="kd">var</span> <span class="nx">numSecsOffline</span> <span class="o">=</span> <span class="p">(</span><span class="nx">msSinceConnectionLost</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
          <span class="nx">consolog</span><span class="p">(</span>
            <span class="s1">&#39;\n&#39;</span><span class="o">+</span>
             <span class="s1">&#39;  |&gt;    Socket reconnected successfully after&#39;</span><span class="o">+</span><span class="s1">&#39;\n&#39;</span><span class="o">+</span>
            <span class="s1">&#39;\\___/   being offline for ~&#39;</span> <span class="o">+</span> <span class="nx">numSecsOffline</span> <span class="o">+</span> <span class="s1">&#39; seconds.&#39;</span><span class="o">+</span><span class="s1">&#39;\n&#39;</span><span class="o">+</span>
            <span class="s1">&#39;\n&#39;</span>
          <span class="p">);</span>
        <span class="p">});</span>
      

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-61" id="section-61">&#182;</a>
</div>
<p>'error' event is triggered if connection can not be established.
(usually because of a failed authorization, which is in turn
usually due to a missing or invalid cookie)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">self</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">failedToConnect</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-62" id="section-62">&#182;</a>
</div>
<p>TODO:
handle failed connections due to failed authorization
in a smarter way (probably can listen for a different event)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-63" id="section-63">&#182;</a>
</div>
<p>A bug in Socket.io 0.9.x causes <code>connect_failed</code>
and <code>reconnect_failed</code> not to fire.
Check out the discussion in github issues for details:
<a href='https://github.com/LearnBoost/socket.io/issues/652'>https://github.com/LearnBoost/socket.io/issues/652</a>
io.socket.on('connect_failed', function () {
 consolog('io.socket emitted <code>connect_failed</code>');
});
io.socket.on('reconnect_failed', function () {
 consolog('io.socket emitted <code>reconnect_failed</code>');
});</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

          <span class="nx">consolog</span><span class="p">(</span>
            <span class="s1">&#39;Failed to connect socket (probably due to failed authorization on server)&#39;</span><span class="p">,</span>
            <span class="s1">&#39;Error:&#39;</span><span class="p">,</span> <span class="nx">err</span>
          <span class="p">);</span>
        <span class="p">});</span>
      <span class="p">});</span>

    <span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-64" id="section-64">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Disconnect the underlying socket.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public
</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">disconnect</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Cannot disconnect- socket is already disconnected&#39;</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">();</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-65" id="section-65">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>isConnected</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Boolean</span>
      <span>whether the socket is connected and able to
                          communicate w/ the server.</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">isConnected</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="o">!!</span><span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">connected</span><span class="p">;</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-66" id="section-66">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>[replay description]</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">[type]</span>
      <span>[description]</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">replay</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
      <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-67" id="section-67">&#182;</a>
</div>
<p>Pass events and a reference to the request queue
off to the self._raw for consumption</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">evName</span> <span class="k">in</span> <span class="nx">self</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">self</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">[</span><span class="nx">evName</span><span class="p">])</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">evName</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">[</span><span class="nx">evName</span><span class="p">][</span><span class="nx">i</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-68" id="section-68">&#182;</a>
</div>
<p>Bind a one-time function to run the request queue
when the self._raw connects.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">isConnected</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">alreadyRanRequestQueue</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connect&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">whenRawSocketConnects</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">alreadyRanRequestQueue</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
          <span class="nx">runRequestQueue</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
          <span class="nx">alreadyRanRequestQueue</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">});</span>
      <span class="p">}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-69" id="section-69">&#182;</a>
</div>
<p>Or run it immediately if self._raw is already connected</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">else</span> <span class="p">{</span>
        <span class="nx">runRequestQueue</span><span class="p">(</span><span class="nx">self</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">self</span><span class="p">;</span>
    <span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-70" id="section-70">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Chainable method to bind an event to the socket.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{String}   evName [event name]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Function} fn     [event handler function]</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">SailsSocket
</span>
      <span>{SailsSocket}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">on</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evName</span><span class="p">,</span> <span class="nx">fn</span><span class="p">){</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-71" id="section-71">&#182;</a>
</div>
<p>Bind the event to the raw underlying socket if possible.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="nx">evName</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-72" id="section-72">&#182;</a>
</div>
<p>Otherwise queue the event binding.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">[</span><span class="nx">evName</span><span class="p">])</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">[</span><span class="nx">evName</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">fn</span><span class="p">];</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">[</span><span class="nx">evName</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">fn</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-73" id="section-73">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Chainable method to unbind an event from the socket.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{String}   evName [event name]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Function} fn     [event handler function]</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">SailsSocket
</span>
      <span>{SailsSocket}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">off</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">evName</span><span class="p">,</span> <span class="nx">fn</span><span class="p">){</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-74" id="section-74">&#182;</a>
</div>
<p>Bind the event to the raw underlying socket if possible.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">off</span><span class="p">(</span><span class="nx">evName</span><span class="p">,</span> <span class="nx">fn</span><span class="p">);</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-75" id="section-75">&#182;</a>
</div>
<p>Otherwise queue the event binding.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">[</span><span class="nx">evName</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">[</span><span class="nx">evName</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">fn</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">[</span><span class="nx">evName</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span><span class="p">[</span><span class="nx">evName</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">fn</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-76" id="section-76">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Chainable method to unbind all events from the socket.</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">SailsSocket
</span>
      <span>{SailsSocket}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">removeAllListeners</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-77" id="section-77">&#182;</a>
</div>
<p>Bind the event to the raw underlying socket if possible.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">_raw</span><span class="p">.</span><span class="nx">removeAllListeners</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-78" id="section-78">&#182;</a>
</div>
<p>Otherwise queue the event binding.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">this</span><span class="p">.</span><span class="nx">eventQueue</span> <span class="o">=</span> <span class="p">{};</span>
      
      <span class="k">return</span> <span class="k">this</span><span class="p">;</span>
    <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-79" id="section-79">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Simulate a GET request to sails
e.g.
   <code>socket.get('/user/3', Stats.populate)</code></p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">url</span>
      <span class="dox_type">String</span>
      <span>::    destination URL</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">params</span>
      <span class="dox_type">Object</span>
      <span>::    parameters to send with the request [optional]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">Function</span>
      <span>::    callback function to call when finished [optional]</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-80" id="section-80">&#182;</a>
</div>
<p><code>data</code> is optional</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
        <span class="nx">params</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span>
      <span class="p">},</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-81" id="section-81">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Simulate a POST request to sails
e.g.
   <code>socket.post('/event', newMeeting, $spinner.hide)</code></p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">url</span>
      <span class="dox_type">String</span>
      <span>::    destination URL</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">params</span>
      <span class="dox_type">Object</span>
      <span>::    parameters to send with the request [optional]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">Function</span>
      <span>::    callback function to call when finished [optional]</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">post</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-82" id="section-82">&#182;</a>
</div>
<p><code>data</code> is optional</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;post&#39;</span><span class="p">,</span>
        <span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span>
      <span class="p">},</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-83" id="section-83">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Simulate a PUT request to sails
e.g.
   <code>socket.post('/event/3', changedFields, $spinner.hide)</code></p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">url</span>
      <span class="dox_type">String</span>
      <span>::    destination URL</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">params</span>
      <span class="dox_type">Object</span>
      <span>::    parameters to send with the request [optional]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">Function</span>
      <span>::    callback function to call when finished [optional]</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">put</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-84" id="section-84">&#182;</a>
</div>
<p><code>data</code> is optional</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;put&#39;</span><span class="p">,</span>
        <span class="nx">params</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span>
      <span class="p">},</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-85" id="section-85">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Simulate a DELETE request to sails
e.g.
   <code>socket.delete('/event', $spinner.hide)</code></p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">url</span>
      <span class="dox_type">String</span>
      <span>::    destination URL</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">params</span>
      <span class="dox_type">Object</span>
      <span>::    parameters to send with the request [optional]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name">cb</span>
      <span class="dox_type">Function</span>
      <span>::    callback function to call when finished [optional]</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">[</span><span class="s1">&#39;delete&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-86" id="section-86">&#182;</a>
</div>
<p><code>data</code> is optional</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">cb</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
        <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">request</span><span class="p">({</span>
        <span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;delete&#39;</span><span class="p">,</span>
        <span class="nx">params</span><span class="o">:</span> <span class="nx">data</span><span class="p">,</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">url</span>
      <span class="p">},</span> <span class="nx">cb</span><span class="p">);</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-87" id="section-87">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Simulate an HTTP request to sails
e.g.</p>

<div class='highlight'><pre><code language=''>socket.request({
  url:'/user',
  params: {},
  method: 'POST',
  headers: {}
}, function (responseBody, JWR) {
  // ...
});
</code></pre></div>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">public</span>
    </div>
    <div class="dox_tag_title">option</div>
    <div class="dox_tag_detail">
      <span class="dox_type">String</span>
      <span>url    ::    destination URL</span>
    </div>
    <div class="dox_tag_title">option</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Object</span>
      <span>params ::    parameters to send with the request [optional]</span>
    </div>
    <div class="dox_tag_title">option</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Object</span>
      <span>headers::    headers to send with the request [optional]</span>
    </div>
    <div class="dox_tag_title">option</div>
    <div class="dox_tag_detail">
      <span class="dox_type">Function</span>
      <span>cb   ::    callback function to call when finished [optional]</span>
    </div>
    <div class="dox_tag_title">option</div>
    <div class="dox_tag_detail">
      <span class="dox_type">String</span>
      <span>method ::    HTTP request method [optional]</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">request</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">usage</span> <span class="o">=</span>
      <span class="s1">&#39;Usage:\n&#39;</span><span class="o">+</span>
      <span class="s1">&#39;socket.request( options, [fnToCallWhenComplete] )\n\n&#39;</span><span class="o">+</span>
      <span class="s1">&#39;options.url :: e.g. &quot;/foo/bar&quot;&#39;</span><span class="o">+</span><span class="s1">&#39;\n&#39;</span><span class="o">+</span>
      <span class="s1">&#39;options.method :: e.g. &quot;get&quot;, &quot;post&quot;, &quot;put&quot;, or &quot;delete&quot;, etc.&#39;</span><span class="o">+</span><span class="s1">&#39;\n&#39;</span><span class="o">+</span>
      <span class="s1">&#39;options.params :: e.g. { emailAddress: &quot;mike@sailsjs.org&quot; }&#39;</span><span class="o">+</span><span class="s1">&#39;\n&#39;</span><span class="o">+</span>
      <span class="s1">&#39;options.headers :: e.g. { &quot;x-my-custom-header&quot;: &quot;some string&quot; }&#39;</span><span class="p">;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-88" id="section-88">&#182;</a>
</div>
<p>Old usage:
var usage = 'Usage:\n socket.'+(options.method||'request')+'('+
  ' destinationURL, [dataToSend], [fnToCallWhenComplete] )';</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-89" id="section-89">&#182;</a>
</div>
<p>Validate options and callback</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">options</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span> <span class="o">||</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid or missing URL!\n&#39;</span> <span class="o">+</span> <span class="nx">usage</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">method</span> <span class="o">!==</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid `method` provided (should be a string like &quot;post&quot; or &quot;put&quot;)\n&#39;</span> <span class="o">+</span> <span class="nx">usage</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">headers</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid `headers` provided (should be an object with string values)\n&#39;</span> <span class="o">+</span> <span class="nx">usage</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">params</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">options</span><span class="p">.</span><span class="nx">params</span> <span class="o">!==</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid `params` provided (should be an object with string values)\n&#39;</span> <span class="o">+</span> <span class="nx">usage</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">cb</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">cb</span> <span class="o">!==</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Invalid callback function!\n&#39;</span> <span class="o">+</span> <span class="nx">usage</span><span class="p">);</span>
      <span class="p">}</span>
      


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-90" id="section-90">&#182;</a>
</div>
<p>Build a simulated request object
(and sanitize/marshal options along the way)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">requestCtx</span> <span class="o">=</span> <span class="p">{</span>

        <span class="nx">method</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">||</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>

        <span class="nx">headers</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="p">{},</span>

        <span class="nx">data</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">params</span> <span class="o">||</span> <span class="nx">options</span><span class="p">.</span><span class="nx">data</span> <span class="o">||</span> <span class="p">{},</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-91" id="section-91">&#182;</a>
</div>
<p>Remove trailing slashes and spaces to make packets smaller.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^(.+)\/*\s*$/</span><span class="p">,</span> <span class="s1">&#39;$1&#39;</span><span class="p">),</span>

        <span class="nx">cb</span><span class="o">:</span> <span class="nx">cb</span>
      <span class="p">};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-92" id="section-92">&#182;</a>
</div>
<p>If this socket is not connected yet, queue up this request
instead of sending it.
(so it can be replayed when the socket comes online.)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="k">this</span><span class="p">.</span><span class="nx">isConnected</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-93" id="section-93">&#182;</a>
</div>
<p>If no queue array exists for this socket yet, create it.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="k">this</span><span class="p">.</span><span class="nx">requestQueue</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">requestQueue</span> <span class="o">||</span> <span class="p">[];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">requestQueue</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">requestCtx</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-94" id="section-94">&#182;</a>
</div>
<p>Otherwise, our socket is ok!
Send the request.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">_emitFrom</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">requestCtx</span><span class="p">);</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-95" id="section-95">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Socket.prototype._request</p>
  </div>
  <div class="body"><p>Simulate HTTP over Socket.io.</p>
  </div>
  <div class="details">
    <div class="dox_tag_title">API</div>
    <div class="dox_tag_detail">
      <span class="dox_type">private</span>
    </div>
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{[type]}   options [description]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Function} cb      [description]</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">SailsSocket</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_request</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;`_request()` was a private API deprecated as of v0.11 of the sails.io.js client. Use `.request()` instead.&#39;</span><span class="p">);</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-96" id="section-96">&#182;</a>
</div>
<p>Set a <code>sails</code> object that may be used for configuration before the
first socket connects (i.e. to prevent auto-connect)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">io</span><span class="p">.</span><span class="nx">sails</span> <span class="o">=</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-97" id="section-97">&#182;</a>
</div>
<p>Whether to automatically connect a socket and save it as <code>io.socket</code>.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">autoConnect</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-98" id="section-98">&#182;</a>
</div>
<p>The route (path) to hit to get a x-origin (CORS) cookie
(or true to use the default: '/__getcookie')</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">useCORSRouteToGetCookie</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-99" id="section-99">&#182;</a>
</div>
<p>The environment we're running in.
(logs are not displayed when this is set to 'production')</p>

<p>Defaults to development unless this script was fetched from a URL
that ends in <code>*.min.js</code> or '#production' (may also be manually overridden.)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">environment</span><span class="o">:</span> <span class="nx">urlThisScriptWasFetchedFrom</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/(\#production|\.min\.js)/g</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39;production&#39;</span> <span class="o">:</span> <span class="s1">&#39;development&#39;</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-100" id="section-100">&#182;</a>
</div>
<p>The version of this sails.io.js client SDK</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">sdk</span><span class="o">:</span> <span class="nx">SDK_INFO</span><span class="p">,</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-101" id="section-101">&#182;</a>
</div>
<p>Transports to use when communicating with the server, in the order they will be tried</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">transports</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;polling&#39;</span><span class="p">,</span> <span class="s1">&#39;websocket&#39;</span><span class="p">]</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-102" id="section-102">&#182;</a>
</div>
<div class="dox">
  <div class="summary"><p>Add <code>io.sails.connect</code> function as a wrapper for the built-in <code>io()</code> aka <code>io.connect()</code>
method, returning a SailsSocket. This special function respects the configured io.sails
connection URL, as well as sending other identifying information (most importantly, the
current version of this SDK).</p>
  </div>
  <div class="body">
  </div>
  <div class="details">
    <div class="dox_tag_title">Params</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{String} url  [optional]</span>
    </div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span>{Object} opts [optional]</span>
    </div>
    <div class="dox_tag_title">Returns</div>
    <div class="dox_tag_detail">
      <span class="dox_tag_name"></span>
      <span class="dox_type">Socket
</span>
      <span>{Socket}</span>
    </div>
  </div>
</div>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">io</span><span class="p">.</span><span class="nx">sails</span><span class="p">.</span><span class="nx">connect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">opts</span> <span class="o">=</span> <span class="nx">opts</span> <span class="o">||</span> <span class="p">{};</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-103" id="section-103">&#182;</a>
</div>
<p>If explicit connection url is specified, save it to options</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">opts</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">||</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">url</span> <span class="o">||</span> <span class="kc">undefined</span><span class="p">;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-104" id="section-104">&#182;</a>
</div>
<p>Instantiate and return a new SailsSocket- and try to connect immediately.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SailsSocket</span><span class="p">(</span><span class="nx">opts</span><span class="p">);</span>
      <span class="nx">socket</span><span class="p">.</span><span class="nx">_connect</span><span class="p">();</span>
      <span class="k">return</span> <span class="nx">socket</span><span class="p">;</span>
    <span class="p">};</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-105" id="section-105">&#182;</a>
</div>
<p>io.socket</p>

<p>The eager instance of Socket which will automatically try to connect
using the host that this js file was served from.</p>

<p>This can be disabled or configured by setting properties on <code>io.sails.*</code> within the
first cycle of the event loop.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-106" id="section-106">&#182;</a>
</div>
<p>Build <code>io.socket</code> so it exists
(this does not start the connection process)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SailsSocket</span><span class="p">();</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-107" id="section-107">&#182;</a>
</div>
<p>In the mean time, this eager socket will be queue events bound by the user
before the first cycle of the event loop (using <code>.on()</code>), which will later
be rebound on the raw underlying socket.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-108" id="section-108">&#182;</a>
</div>
<p>If configured to do so, start auto-connecting after the first cycle of the event loop
has completed (to allow time for this behavior to be configured/disabled
by specifying properties on <code>io.sails</code>)</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-109" id="section-109">&#182;</a>
</div>
<p>If autoConnect is disabled, delete the eager socket (io.socket) and bail out.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">io</span><span class="p">.</span><span class="nx">sails</span><span class="p">.</span><span class="nx">autoConnect</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">delete</span> <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">;</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-110" id="section-110">&#182;</a>
</div>
<p>consolog('Eagerly auto-connecting socket to Sails... (requests will be queued in the mean-time)');</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">_connect</span><span class="p">();</span>


    <span class="p">},</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// &lt;/setTimeout&gt;</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-111" id="section-111">&#182;</a>
</div>
<p>Return the <code>io</code> object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">return</span> <span class="nx">io</span><span class="p">;</span>
  <span class="p">}</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-112" id="section-112">&#182;</a>
</div>
<p>Add CommonJS support to allow this client SDK to be used from Node.js.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">module</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">SailsIOClient</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">SailsIOClient</span><span class="p">;</span>
  <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-113" id="section-113">&#182;</a>
</div>
<p>Otherwise, try to instantiate the client:
In case you're wrapping the socket.io client to prevent pollution of the
global namespace, you can replace the global <code>io</code> with your own <code>io</code> here:</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">return</span> <span class="nx">SailsIOClient</span><span class="p">();</span>

<span class="p">})();</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
